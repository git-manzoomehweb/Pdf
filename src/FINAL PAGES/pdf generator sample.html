<basis core="call"  file="Client_CheckRkey.inc"></basis>

<!DOCTYPE html>
<html lang="fa" id="html-root">

<head>
  <title>Invoice PDF</title>
      <basis core="call"  file="Pdf_Taglist.inc"></basis>
    <style>
        .my-1 {
        margin-top: unset !important;
        margin-bottom: unset !important;
        }

        .my-2 {
        margin-top: unset !important;
        margin-bottom: unset !important;
        }

        .my-4 {
        margin-top: unset !important;
        margin-bottom: unset !important;
        }

        .my-auto {
        margin-top: unset !important;
        margin-bottom: unset !important;
        }

        .-mt-\[10px\] {
        margin-top: unset !important;
        }

        .mb-0 {
        margin-bottom: unset !important;
        }

        .mb-1 {
        margin-bottom: unset !important;
        }

        .mb-2 {
        margin-bottom: unset !important;
        }

        .mb-3 {
        margin-bottom: unset !important;
        }

        .mb-4 {
        margin-bottom: unset !important;
        }

        .mb-5 {
        margin-bottom: unset !important;
        }

        .mt-1 {
        margin-top: unset !important;
        }

        .mt-2 {
        margin-top: unset !important;
        }

        .mt-3 {
        margin-top: unset !important;
        }

        .mt-4 {
        margin-top: unset !important;
        }

        .mt-8 {
        margin-top: unset !important;
        }

        .pagee {
            height: 230mm; 
            box-sizing: border-box;
            max-width: 794px;
            margin-bottom: 8em;
            /* border: 1px solid black; */
            /* page-break-after: always; */
        }

        p {
            text-align: justify !important;
            break-inside: avoid;
        }

        .pdf-content {
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
            min-width: 794px !important;
            /* min-height: 1697px !important; */
            position: relative;
            page-break-inside: avoid;
        }

        /* Force page break before these elements */
        .page-break-before {
            page-break-before: always;
        }

        /* Force page break after these elements */
        .page-break-after {
            page-break-after: always;
        }

        table {
            page-break-inside: auto;
            page-break-before: avoid;
        }

        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }

        .avoid-break {
            break-inside: avoid;
        }

        /* Or use the more modern equivalent */
        @media print {
            .avoid-break {
                break-inside: avoid;
            }

            .break-before {
                break-before: page;
            }

            .break-after {
                break-after: page;
            }
        }

        @media (max-width: 768px) {
            .pdf-content {
                margin: 0 auto;
                padding: 15px;
                box-sizing: border-box;
                min-width: unset !important;
                position: relative;
                page-break-inside: avoid;
            }
        }
    </style>
</head>

<body class="p-0 m-0 overflow-auto" id="content" onload="setlid([##cms.query.langid|(1)##]);">

    <!-- Loading -->
    <div class="main-loading-screen" id="main-loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="main-loading-text"></div>
    </div>

    <!-- Main content -->

    <div class="main-content" id="main-content-wrapper">
    <basis core="group" name="invalid-rkey" if="'[##db.checkrkey.checked##]'<>'true'">
            <div class="bg-red-300 border-2 border-red-500 rounded-xl py-4 px-8 max-sm:px-3 font-danaregular max-w-7xl !text-center w-fit mx-auto my-auto absolute top-0 left-0 right-0 bottom-0 h-fit"
                id="access-denied-message">
                شما اجازه دسترسی به این صفحه را ندارید
            </div>
  </basis>
  <basis core="group" name="valid-rkey" if="'[##db.checkrkey.checked##]'='true'">
    <basis core="api" name="api.Webservice" url="https://www.basisfly.com/panel/main/view/[##cms.query.rkey##]"
      method="post" body='{
            "name": "db", 
            "mid": "20", 
            "member":
            [
                { 
                    "name": "q", 
                    "type":"list", 
                    "request":"invoice_pdf", 
                    "lid":"[##cms.query.langid##]",
                    "id":"[##cms.query.id##]"
                }
            ] 
        }' content-type="application/json" run="atclient">
    </basis>
                <div class="w-full max-w-[794px] mx-auto my-4 flex justify-between items-center max-sm:justify-center">

                <div class="flex gap-2">
                    <button onclick="generatePDF()" type="button"
                        class="text-white bg-[#509ad3] hover:bg-[#509ad3]/90 focus:ring-4 focus:outline-none focus:ring-[#509ad3]/50 font-medium rounded-lg
                         text-sm px-5 py-2.5 !text-center inline-flex items-center dark:focus:ring-[#509ad3]/50 me-2 mb-2">

                        <svg class=" h-3 me-2 -ms-1" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M14 22H10C6.22876 22 4.34315 22 3.17157 20.8284C2 19.6569 2 17.7712 2 14V10C2 6.22876 2 4.34315 3.17157 3.17157C4.34315 2 6.23869 2 10.0298 2C10.6358 2 11.1214 2 11.53 2.01666C11.5166 2.09659 11.5095 2.17813 11.5092 2.26057L11.5 5.09497C11.4999 6.19207 11.4998 7.16164 11.6049 7.94316C11.7188 8.79028 11.9803 9.63726 12.6716 10.3285C13.3628 11.0198 14.2098 11.2813 15.0569 11.3952C15.8385 11.5003 16.808 11.5002 17.9051 11.5001L18 11.5001H21.9574C22 12.0344 22 12.6901 22 13.5629V14C22 17.7712 22 19.6569 20.8284 20.8284C19.6569 22 17.7712 22 14 22ZM5.25 14.5C5.25 14.0858 5.58579 13.75 6 13.75H14C14.4142 13.75 14.75 14.0858 14.75 14.5C14.75 14.9142 14.4142 15.25 14 15.25H6C5.58579 15.25 5.25 14.9142 5.25 14.5ZM5.25 18C5.25 17.5858 5.58579 17.25 6 17.25H11.5C11.9142 17.25 12.25 17.5858 12.25 18C12.25 18.4142 11.9142 18.75 11.5 18.75H6C5.58579 18.75 5.25 18.4142 5.25 18Z"
                                fill="#FFF" />
                            <path
                                d="M19.3517 7.61665L15.3929 4.05375C14.2651 3.03868 13.7012 2.53114 13.0092 2.26562L13 5.00011C13 7.35713 13 8.53564 13.7322 9.26787C14.4645 10.0001 15.643 10.0001 18 10.0001H21.5801C21.2175 9.29588 20.5684 8.71164 19.3517 7.61665Z"
                                fill="#FFF" />
                        </svg>

                        Download PDF
                    </button>

                    <basis core="print" datamembername="db.invoice_pdf" run="atclient">
                      <layout>
                        <div class="pdf-config">
                          @child
                        </div>
                      </layout>
                    
                      <face>
                        <script type="text/template">
                        <input type="hidden" id="name"
                          value="@passengers[0].passengerinfo.fullname.firstname@ @passengers[0].passengerinfo.fullname.lastname@" />
                        <input type="hidden" id="header" value="[##cms.query.letterhead|(1)##]" />
                        </script>
                      </face>
                    </basis>


                </div>
            </div>




<!-- با استفاده از Print Command -->
<basis datamembername="db.invoice_pdf"  core="print" run="atclient">
    <layout>@child</layout>
    <face>
        <script type="text/template">
        {{
            if([##cms.query.letterhead##] == 1) {
                return `<header id="pdf-header" class="header max-w-[794px] w-full mx-auto">
                    <img class="block max-w-[794px] w-full mx-auto object-contain" 
                         src="/images/Header-contract-pdf.jpg"
                         width="794" height="100" alt="Header-contract-pdf" />
                </header>`;
            }
            return '';
        }}
        </script>
    </face>
</basis>


            <main class="pdf-content py-6 w-full max-w-[794px] mx-auto max-sm:!p-2" id="main-content">

                <div class="pdf-loading hidden ">
                    <div
                        class="flex justify-center items-center fixed z-[99] w-full h-full top-0 left-0 right-0 bottom-0 bg-black/60 backdrop-blur-xl">
                        <span
                            class="pointer-events-none rounded bg-primary px-6 pb-2 pt-2.5 text-xs font-medium uppercase leading-normal text-white shadow-primary-3 transition duration-150 ease-in-out hover:bg-primary-accent-300 hover:shadow-primary-2 focus:bg-primary-accent-300 focus:shadow-primary-2 focus:outline-none focus:ring-0 active:bg-primary-600 active:shadow-primary-2 disabled:opacity-70 dark:shadow-black/30 dark:hover:shadow-dark-strong dark:focus:shadow-dark-strong dark:active:shadow-dark-strong flex justify-center items-center gap-x-2"
                            id="pdf-loading-text">
                            <div class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-current border-e-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"
                                role="status"></div>
                            <div class="font-danamedium leading-9" id="loading-text">در حال تولید PDF...</div>
                        </span>
        </div>
      </div>
      <div class="w-[95%] mx-auto">
        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await getOwner($data.invoiceDetails.ownerid)}}
            </script>
          </face>
        </basis>



        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await setInvoiceType($data.invoiceDetails.invoicetype)}}
              {{return await renderInvoiceDetails($data , [##cms.query.langid|(1)##])}}
            </script>
          </face>
        </basis>



        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await renderAllProducts($data.products , [##cms.query.langid|(1)##] )}}
            </script>
          </face>
        </basis>


        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await renderPassengers($data.passengers , $data , [##cms.query.langid|(1)##])}}
            </script>
          </face>
        </basis>

        
        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await renderPriceDetailsSection($data , $data.priceDetails , [##cms.query.langid|(1)##])}}
            </script>
          </face>
        </basis>

        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await renderBillSection($data.bill , [##cms.query.langid|(1)##])}}
            </script>
          </face>
        </basis>

        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>
            @child
          </layout>
          <face>
            <script type="text/template">
              {{return await renderDescription($data , [##cms.query.langid|(1)##])}}
            </script>
          </face>
        </basis>
      </div>
    </main>






                        <!-- با استفاده از Print Command -->
<basis datamembername="db.invoice_pdf"  core="print" run="atclient">
    <layout>@child</layout>
    <face>
        <script type="text/template">
        {{
            if([##cms.query.letterhead##] == 1) {
                return `<footer id="pdf-footer" class=" footer max-w-[794px]  w-full mx-auto "><img
                        class="block mx-auto max-w-[794px]  w-full object-contain" src="/images/Footer-contract-pdf.jpg"
                        width="794" height="100" alt="Footer-contract-pdf" /></footer>`;
            }
            return '';
        }}
        </script>
    </face>
</basis>


    </div>

  </basis>

    <script src="[##cms.cms.cdn##]/js/JsPDF.js" defer></script>
    <script>
        const PAGE_HEIGHT = 800;  // 50% 795

        function resetViewport() {
            // window.location.reload();
            return;
        }

        async function paginateContent(content, maxWidth = 0, currentY = 0) {
            const elements = Array.from(content.children); // دریافت تمام فرزندان
            const pages = [];
            let currentPage = [];

            // برای هر المان یک Promise ایجاد می‌کنیم
            await Promise.all(
                elements.map(async (el, index) => {
                    // بررسی اینکه آیا عرض المان بیشتر از عرض قبلی است
                    if (el.scrollWidth > maxWidth) {
                        maxWidth = el.scrollWidth;
                    }

                    // ایجاد HTML جدید از el
                    var htmlContent = buildHtmlFromPath(getParentHtml(el), el.innerHTML);
                    var tempDiv = document.createElement('div');
                    tempDiv.innerHTML = htmlContent;

                    // اطمینان از اینکه المان به درستی رندر شده
                    const renderedElement = tempDiv.firstChild;

                    // بررسی اینکه آیا المان در صفحه جا می‌شود یا خیر
                    if (currentY + el.offsetHeight <= PAGE_HEIGHT) {
                        currentPage.push(renderedElement);
                        currentY += el.offsetHeight;
                    } else {
                        // اگر المان خیلی بزرگ بود، صفحات جدید می‌سازیم
                        if (el.offsetHeight >= PAGE_HEIGHT) {
                            const [subPages, subMaxWidth, cy] = await paginateContent(el, maxWidth); // فراخوانی غیرهمزمان

                            if (subPages) {
                                pages.push(...subPages);
                            }
                            
                            if (subMaxWidth && subMaxWidth > maxWidth) {
                                maxWidth = subMaxWidth;
                            }

                            if (cy){
                                currentPage = [];
                                currentY = cy
                            }
                        } else {
                            // افزودن صفحه فعلی و شروع صفحه جدید
                            if (currentPage.length > 0) {
                                pages.push(currentPage);
                            }
                            currentPage = [renderedElement];
                            currentY = el.offsetHeight;
                        }
                    }

                    // اضافه کردن آخرین المان به صفحه‌ها
                    if (index === elements.length - 1 && currentPage.length > 0) {
                        pages.push(currentPage);
                    }
                })
            );

            return [pages, maxWidth, currentY];
        }

        function getParentHtml(elements) {
            let parentHtml = [];

            // Ensure elements is an array or NodeList
            const elementsArray = Array.isArray(elements) || elements instanceof NodeList ? elements : [elements];

            elementsArray.forEach(element => {
                let currentElement = element;
                let path = [];

                // Traverse up the DOM tree to the root
                while (currentElement) {
                    const tagName = currentElement.tagName.toLowerCase();
                    const className = currentElement.className ? `.${currentElement.className.trim().replace(/\s+/g, '.')}` : '';
                    
                    const idSelector = currentElement.id ? `#${currentElement.id.trim()}` : '';
                    path.unshift(tagName + className + idSelector); 

                    // Move to the parent element
                    currentElement = currentElement.parentElement;
                }

                // Join the path with '>' separator
                parentHtml.push(path)
            });

            return parentHtml; // Trim trailing newline
        }
        
        function buildHtmlFromPath(pathArray, content = '') {
            var startIndex = 4
            let currentHtml = '';
            pathArray = pathArray[0]; // استفاده از اولین آرایه در pathArray

            // اطمینان از اینکه ایندکس شروع معتبر باشد
            if (startIndex >= pathArray.length || startIndex < 0) {
                return ''; // اگر ایندکس شروع غیرمعتبر باشد چیزی برنمی‌گرداند
            }

            // شروع از ایندکس مشخص شده
            for (let i = pathArray.length - 1; i >= startIndex; i--) {
                const path = pathArray[i];
        
                const hashParts = path.split('#');
                const beforeHash = hashParts[0];
                const idValue = hashParts.length > 1 ? hashParts[1] : '';
                const parts = beforeHash.split('.');
                const tagName = parts[0];
                const className = parts.slice(1).join(' ');
                const idAttr = idValue ? ` id="${idValue}"` : '';
                const classAttr = className ? ` class="${className}"` : '';
                const attrs = `${idAttr}${classAttr}`;
                if (i === pathArray.length - 1) {
                    currentHtml = `<${tagName}${attrs}>${content}</${tagName}>`;
                } else {
                    currentHtml = `<${tagName}${attrs}>${currentHtml}</${tagName}>`;
                }
            }

            return currentHtml;
        }
        
        function renderPages(pages, width) {
            const container = document.querySelector('.pdf-content');
            container.innerHTML = ''; // Clear the existing content

            // Loop through each page
            pages.forEach(page => {
                const pageDiv = document.createElement('div');
                pageDiv.classList.add('pagee');
                
                // Set the page width dynamically
                // pageDiv.style.width = `${width}px`; // Corrected the style application (no space between width and px)

                // Loop through each element of the page and append its clone to the pageDiv
                page.forEach(el => {
                    el.setAttribute('style', 'margin-top: unset !important');
                    // const clonedElement = el.cloneNode(true);
                    pageDiv.appendChild(el);
                });

                // Append the pageDiv to the container
                container.appendChild(pageDiv);
            });
        }
        
        function setFixedViewport() {
            const pdfContent = document.querySelector('.pdf-content');
            if (pdfContent) {
                pdfContent.setAttribute('style', 'min-width: 794px !important;');
            }

            const metaViewport = document.querySelector('meta[name="viewport"]');
            if (metaViewport) {
                metaViewport.setAttribute('content', 'width=794, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no');
            }

            if (pdfContent && pdfContent.classList.contains('max-w-[794px]')) {
                pdfContent.classList.remove('max-w-[794px]');
            }
        }

        function resetViewport() {
            // window.location.reload();
            return;
        }
    
    
        async function generatePDF() {
            setFixedViewport();

            const element = document.querySelector('.pdf-content');

            var [pages, max_width, currentY] = await paginateContent(element, 0);
            console.log('pages', max_width, currentY, pages)
            renderPages(pages, max_width);

            const pdfConfig = document.querySelector('.pdf-config');
            const pdfFileName = pdfConfig.querySelector('#name');
            const isSetHeader = pdfConfig.querySelector('#header');
            
            let headerImage = null;
            let footerImage = null;

            if (isSetHeader.value == 1) {
                try {
                    const headerElement = document.querySelector('#pdf-header').querySelector("img");
                    const footerElement = document.querySelector('#pdf-footer').querySelector("img");

                    // Check if both header and footer have images
                    if (headerElement) {
                        const headerCanvas = await html2canvas(headerElement, { scale: 2 });
                        headerImage = headerCanvas.toDataURL('image/png');
                    }
                    if (footerElement) {
                        const footerCanvas = await html2canvas(footerElement, { scale: 2 });
                        footerImage = footerCanvas.toDataURL('image/png');
                    }
                } catch (error) {
                    console.error("Error loading header or footer:", error);
                    isSetHeader.value = 0; // If there's any issue, disable the header/footer flag
                }
            }

            const loadingElement = document.querySelector('.pdf-loading');

            try {
                if (loadingElement) loadingElement.classList.remove('hidden');

                var window_Width = element.scrollWidth;

                if (window.innerWidth < 768) {
                    window_Width = 768;
                }

                const opt = {
                    margin: [30, 10, 30, 10],
                    filename: pdfFileName.value || "reservationDoc.pdf",
                    image: { type: 'jpeg', quality: 1 },
                    html2canvas: {
                        scale: 1,
                        width: 794,
                        windowWidth: window_Width,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        scrollX: 0,
                        scrollY: 0,
                        letterRendering: true,
                        ignoreElements: (el) =>
                            ['BUTTON', 'A', 'SCRIPT'].includes(el.tagName) ||
                            el.classList.contains('pdf-loading'),
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait',
                        hotfixes: ['px_scaling']
                    },
                    pagebreak: {
                        mode: ['css', 'legacy'], // Use both CSS and legacy mode
                        before: '.page-break-before',
                        after: '.page-break-after',
                        avoid: '.avoid-break'
                    }
                };

                // Generate the PDF
                const worker = html2pdf().set(opt).from(element).toPdf();

                // Add header and footer images if they exist
                worker.get('pdf').then((pdf) => {
                    const totalPages = pdf.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        // Add header and/or footer based on availability
                        if (headerImage) {
                            pdf.addImage(headerImage, 'PNG', 0, 0, 210, 30);  // x, y, width, height
                        }
                        if (footerImage) {
                            pdf.addImage(footerImage, 'PNG', 0, 270, 210, 30);  // x, y, width, height
                        }
                    }
                });

                await worker.save();
            } catch (err) {
                console.error('PDF generation failed:', err);
                alert('خطا در تولید PDF.');
            } finally {
                resetViewport();
                if (loadingElement) loadingElement.classList.add('hidden');
            }
        }
   
    </script>

    <basis core="call"  file="Client_BasisCore_Script.inc"></basis>
    <script src="[##cms.cms.cdn##]/js/pdf-content.functions.js" defer></script>
    <script src="[##cms.cms.cdn##]/js/pdf-invoice.functions.js" defer></script>
</body>

</html>