<basis core="call" lid="1" file="Client_CheckRkey.inc"></basis>



<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/pdf-ui.min.css">
</head>

<body class="p-0 m-0">

    <basis core="group" name="valid-rkey" if="'[##db.checkrkey.checked##]'<>'true'">
        <div class="bg-[#F8F8F8] rounded-xl py-4  px-8  font-danaregular max-w-7xl text-center w-fit mx-auto my-auto absolute top-0 left-0 right-0 bottom-0 h-fit ">
            شما اجازه دسترسی به این صفحه را ندارید
        </div>
    </basis>
    <basis core="group" name="invalid-rkey" if="'[##db.checkrkey.checked##]'='true'">
        <basis core="api" name="api.Webservice" url="https://www.basisfly.com/panel/main/view/[##cms.query.rkey##]"
            method="post" body='{
         "name": "db",
         "mid": "20",
         "member": [
             {
                 "type": "list",
                 "name": "q",
                 "request": "voucher_pdf",
                 "id": "[##cms.query.id##]",
                 "lid": "[##cms.query.lid|(1)##]",
                 "cityid": "[##cms.query.cityid|(0)##]",
                 "status": "[##cms.query.status|(0)##]"
             }
         ]
     }' content-type="application/json" run="atclient">
        </basis>

        <header id="pdf-header" class="header h-[100px] print:w-[595pt] print:h-[75pt] w-full bg-gray-200">
    <img class="block mx-auto h-[100px] print:w-[595pt] print:h-[75pt] w-full object-contain" src="images/Header-contract-pdf.jpg" width="1060" height="100" alt="Footer-contract-pdf"/>

        </header>

        <main
            class="dir-rtl pdf-content py-6 w-full max-w-screen-xl mx-auto print:w-[595pt] print:min-h-[calc(842pt-150pt)] print:max-w-none print:overflow-hidden print:shadow-none">

            <div class="pdf-loading hidden fixed z-[99] w-full h-full pt-[20%] bg-[#8d8d8d8c]">
                <div class="flex justify-center items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-gray-900"></div>
                </div>
            </div>

            <div class="w-[95%] mx-auto">

                <!-- info -->
                <section class="w-full flex justify-between items-center ">
                    <h2 class="font-danademibold text-base text-black">کوپن / اقامت</h2>
                    <ul class="flex gap-x-4">

                        <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                            <layout>
                                @child
                            </layout>
                            <face>
                                <script type="text/template">
                    <li>
                        <div>
                            <h2 class="text-sm font-normal text-[#202020] font-danaregular">شماره قرارداد :</h2>
                            <p class="text-base text-[#292929] text-left font-danademibold">@refnumber@</p>
                        </div>
                    </li>
                        </script>
                            </face>
                        </basis>
                        <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                            <layout>
                                @child
                            </layout>
                            <face>
                                <script type="text/template">
                    <li>
                        <div>
                            <h2 class="text-sm font-normal text-[#202020] font-danaregular">تاریخ صدور :</h2>
                            <p class="text-base text-[#292929] text-left font-danademibold">@createDate.sstring@</p>
                        </div>
                    </li>
                        </script>
                            </face>
                        </basis>
                        <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                            <layout>
                                @child
                            </layout>
                            <face>
                                <script type="text/template">
                    <li>
                        <div>
                            <h2 class="text-sm font-normal text-[#202020] font-danaregular">ساعت ایجاد  :</h2>
                            <p class="text-base text-[#292929] text-center font-danademibold">@createHour@</p>
                        </div>
                    </li>
                        </script>
                            </face>
                        </basis>
                    </ul>

                </section>

                <section class="border-2 border-[#E3E3E3] rounded-xl  my-4 justify-between flex p-3">
                    <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                        <layout>
                            @child
                        </layout>
                        <face>
                            <script type="text/template">
                                {{ return await RenderInfoCard($data)}}
                        </script>
                        </face>
                    </basis>
                </section>

                <section>

                    <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                        <layout>
                            @child
                        </layout>
                        <face>
                            <script type="text/template">
                                {{ return await renderRooms($data)}}
                        </script>
                        </face>
                    </basis>
                </section>


                <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                    <layout>
                        @child
                    </layout>
                    <face>
                        <script type="text/template">
                <section class="mt-3 {{return await checkSection($data.HotelDescription)}}" >
                <h2 class="font-bold text-2xl my-2 font-danabold " dir="{{return await detectDirection($data.HotelDescription);}}">{{ return await getLocalizedText(await detectDirection($data.HotelDescription) , "ملاحظات", "Remarks")}}
                </h2>
                <div class="bg-[#F8F8F8] rounded-xl py-4  px-8 text-justify font-danaregular" dir="{{return await detectDirection($data.HotelDescription);}}">
                    @HotelDescription@
                </div>
            </section>   
                        </script>
                    </face>
                </basis>




                <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                    <layout>
                        @child
                    </layout>
                    <face>
                        <script type="text/template">
            <section class="{{return await checkSection($data.pdf_description[0]?.note.text)}}">
                <h2 class="font-bold text-2xl my-2 font-danabold" 
             dir="{{return await detectDirection($data.pdf_description[0]?.note.text);}}"
                >{{ return await getLocalizedText(await detectDirection($data.pdf_description[0].note.text), "قوانین و مقررات", "Rules")}}</h2>
                <div class="bg-[#F8F8F8] rounded-xl py-4  px-8 text-justify font-danaregular">
                    {{ return await renderRules($data)}}
                            </div>
            </section>
                        </script>
                    </face>
                </basis>






                <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                    <layout>
                        @child
                    </layout>
                    <face>
                        <script type="text/template">
            <section class="{{return await checkSection($data.note)}}">
                <h2 class="font-bold text-2xl my-2 font-danabold" 
                dir="{{return await detectDirection($data.note);}}" >{{ return await getLocalizedText(await detectDirection($data.note), "یادداشت", "Note")}}</h2>
                <div class="bg-[#F8F8F8] rounded-xl py-4  px-8 text-justify font-danaregular" dir="{{return await detectDirection($data.note);}}">
                    @note@
                            </div>
            </section>
                        </script>
                    </face>
                </basis>





        </main>

        <div class="text-sm max-w-screen-md min-w-[900px] mx-auto mt-8 text-xs max-lg:w-full max-lg:min-w-0 max-lg:min-w-0 max-lg:max-w-full margin-btn">
            <button class="flex gap-1 items-center my-4 font-bold text-base hover:text-[#FF0000]"
                onclick="generatePDF2()"><svg xmlns="http://www.w3.org/2000/svg" width="35" height="35"
                    viewBox="0 0 24 24" fill="none" stroke="#FF0000" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="9" y1="13" x2="15" y2="13" />
                    <line x1="9" y1="17" x2="15" y2="17" />
                </svg> Generate PDF</button>
        </div>


        <footer id="pdf-footer" class="h-[100px] print:w-[595pt] print:h-[75pt] w-full bg-gray-200">
    <img class="block mx-auto h-[100px] print:w-[595pt] print:h-[75pt] w-full object-contain" src="images/Footer-contract-pdf.jpg" width="1060" height="100" alt="Footer-contract-pdf"/>

        </footer>
    </basis>


</body>


<basis core="call" file="Client_BasisCore_Script.inc"></basis>
<script>

            async function generatePDF2() {
                const element = document.querySelector('.pdf-content');
                const headerElement = document.getElementById('pdf-header');
                const footerElement = document.getElementById('pdf-footer');

                // element.style.transform = 'scale(0.8)';
                // element.style.transformOrigin = 'top left';
                // element.style.width = '125%';

                try {
                    const loadingElement = document.querySelector('.pdf-loading');
                    if (loadingElement) loadingElement.classList.remove('hidden');
                                        
                    const isMobile = window.innerWidth <= 768; // Adjust breakpoint as needed

                    var static_width = 300;
                    var static_y = -45;
                    var static_height = 20;
                    var html2canvas_width = 1554 * 0.8;
                    var header_scale = 1.5;
                    var main_sacel = 1.5;
                    var window_width = 1900;
                    var margin = [35, -5, 35, -5];
                    
                    if (isMobile){
                        static_width = 190;
                        static_y = 10;
                        static_height = 25;
                        header_scale = 2;
                        main_sacel = 1.2;
                        html2canvas_width = 416 * 2.05;
                        window_width = 600;
                        margin = [35, 20, 35, -5];
                    } else {
                        if (window.innerWidth > 1554){
                            html2canvas_width = window.innerWidth * 0.6;
                            window_width = window.innerWidth + 115;
                        }

                        if (window.innerWidth < 1554){
                            if (window.innerWidth < 1554 && window.innerWidth > 1200){
                                html2canvas_width = window.innerWidth * 0.8;
                            } else {
                                html2canvas_width = window.innerWidth * 1;
                            }
                            window_width = window.innerWidth;
                            static_width = 190;
                            static_y = 10;
                            static_height = 25;
                            header_scale = 2;
                            main_sacel = 1.2;
                            margin = [35, 20, 35, -5];
                        }
                    }
                    
                    const opt = {
                        margin: margin, 
                        image: { type: 'jpeg', quality: 1 },
                        html2canvas: {
                            width: html2canvas_width,
                            scale: main_sacel,
                            windowWidth: window_width,
                            backgroundColor: '#ffffff',
                            useCORS: true,
                            allowTaint: true,
                            scrollX: 0,
                            scrollY: 0,
                            letterRendering: true,
                            ignoreElements: (e) => {
                                if (['BUTTON', 'A', 'SCRIPT'].includes(e.tagName)) {
                                    return true;
                                }
                                if (e.classList.contains('pdf-loading', 'pdf-header', 'pdf-footer')) {
                                    return true;
                                }
                                return false;
                            }
                        },
                        jsPDF: {
                            unit: 'mm',
                            format: 'a4',
                            orientation: 'portrait'
                        }
                    };

                    try {
                        const headerElement = document.getElementById('pdf-header');
                        const footerElement = document.getElementById('pdf-footer');

                        // تبدیل هدر و فوتر به عکس
                        const headerCanvasPromise = html2canvas(headerElement, { scale: header_scale });
                        const footerCanvasPromise = html2canvas(footerElement, { scale: header_scale });

                        Promise.all([headerCanvasPromise, footerCanvasPromise]).then(async ([headerCanvas, footerCanvas]) => {
                            const headerImage = headerCanvas.toDataURL('image/png');
                            const footerImage = footerCanvas.toDataURL('image/png');

                            const worker = html2pdf().set(opt).from(element).toPdf();
                            
                            
                            worker.get('pdf').then(function (pdf) {
                                const totalPages = pdf.internal.getNumberOfPages();
                                for (let i = 1; i <= totalPages; i++) {
                                    pdf.setPage(i);

                                    // Add header
                                    pdf.addImage(headerImage, 'PNG', static_y, 5, static_width, static_height); // x, y, width, height (سایز رو تنظیم کن)

                                    // Add footer
                                    pdf.addImage(footerImage, 'PNG', static_y, 270, static_width, static_height);
                                }
                            });

                            worker.save();
                        });


                    } catch (highResError) {}

                } catch (error) {
                    console.error('PDF generation failed:', error);
                    alert('خطا در تولید PDF.');
                }
                finally {
                    const loadingElement = document.querySelector('.pdf-loading');
                    if (loadingElement) loadingElement.classList.add('hidden');
                }
            }
            
            async function generatePDF1() {
                const element = document.querySelector('.pdf-content');
                const headerElement = document.getElementById('pdf-header');
                const footerElement = document.getElementById('pdf-footer');

                try {
                    const loadingElement = document.querySelector('.pdf-loading');
                    if (loadingElement) loadingElement.classList.remove('hidden');

                    // تشخیص موبایل و زوم
                    const isMobile = window.innerWidth <= 768;
                    const zoomLevel = window.devicePixelRatio || 1;
                    const actualWidth = window.innerWidth * zoomLevel;

                    // تنظیمات پویا
                    const a4WidthPx = 794; // عرض A4 در 96dpi (~210mm)
                    let html2canvasWidth = actualWidth;
                    let scale = a4WidthPx / actualWidth; // مقیاس متناسب با عرض واقعی
                    let windowWidth = actualWidth;
                    let headerScale = isMobile ? 2 : 1.5;
                    let margin = isMobile ? [35, 20, 35, -5] : [35, -5, 35, -5];

                    // تنظیم عرض و مقیاس برای رزولوشن‌های مختلف
                    if (actualWidth < a4WidthPx) {
                        html2canvasWidth = a4WidthPx; // حداقل عرض A4
                        scale = 1; // بدون مقیاس اضافی
                    } else if (actualWidth > 1554) {
                        html2canvasWidth = a4WidthPx * 1.2; // محدود کردن عرض برای رزولوشن‌های بزرگ
                        scale = a4WidthPx / html2canvasWidth;
                    }

                    // تنظیمات هدر و فوتر
                    const headerFooterWidth = isMobile ? 190 : Math.min(actualWidth * 0.2, 300);
                    const headerFooterHeight = isMobile ? 25 : 20;
                    const headerFooterY = isMobile ? 10 : -45;

                    const opt = {
                        margin: margin,
                        image: { type: 'jpeg', quality: 1 },
                        html2canvas: {
                            width: html2canvasWidth,
                            scale: scale * (isMobile ? 1.2 : 1), // تنظیم مقیاس برای موبایل
                            windowWidth: windowWidth,
                            backgroundColor: '#ffffff',
                            useCORS: true,
                            allowTaint: true,
                            scrollX: 0,
                            scrollY: 0,
                            letterRendering: true,
                            ignoreElements: (e) => {
                                if (['BUTTON', 'A', 'SCRIPT'].includes(e.tagName)) return true;
                                if (e.classList.contains('pdf-loading', 'pdf-header', 'pdf-footer')) return true;
                                return false;
                            },
                        },
                        jsPDF: {
                            unit: 'mm',
                            format: 'a4',
                            orientation: 'portrait',
                        },
                    };

                    // تبدیل هدر و فوتر به تصویر
                    const headerCanvasPromise = html2canvas(headerElement, { scale: headerScale });
                    const footerCanvasPromise = html2canvas(footerElement, { scale: headerScale });

                    const [headerCanvas, footerCanvas] = await Promise.all([headerCanvasPromise, footerCanvasPromise]);
                    const headerImage = headerCanvas.toDataURL('image/png');
                    const footerImage = footerCanvas.toDataURL('image/png');

                    const worker = html2pdf().set(opt).from(element).toPdf();

                    worker.get('pdf').then(function (pdf) {
                        const totalPages = pdf.internal.getNumberOfPages();
                        for (let i = 1; i <= totalPages; i++) {
                            pdf.setPage(i);

                            pdf.addImage(headerImage, 'PNG', headerFooterY, 5, headerFooterWidth, headerFooterHeight);

                            pdf.addImage(footerImage, 'PNG', headerFooterY, 270, headerFooterWidth, headerFooterHeight);
                        }
                    });

                    await worker.save();

                } catch (error) {
                    console.error('PDF generation failed:', error);
                    alert('خطا در تولید PDF.');
                } finally {
                    const loadingElement = document.querySelector('.pdf-loading');
                    if (loadingElement) loadingElement.classList.add('hidden');
                }
            }
            
            function nodata_error($data) {
                var len = $data.length
                var output = "";
                if (len > 0) {
                    var msg = $data
                    if (msg = 'no data') {
                        document.querySelector('.ticketContainer').remove();
                        document.querySelector('.ticketContainer__info').remove();
                        document.querySelector('.fare_conditions').remove();
                        return `<p class="text-xl text-center">Receiving ticket number , please wait ...</p>`
                    }
                }
            }

            async function arrive_date_info($data) {

                var len = $data.length
                var arrive_date = $data[len - 1].route.routeDate.mstring
                var arrive_dtime = $data[len - 1].route.atime
                return `<span id="landingDate" class=" text-sm">${await convertDateFormat(arrive_date)}</span> | <span id="landingTime" class=" text-sm">${arrive_dtime}</span>`
            }
            
            function passenger_type($data) {
                if ($data == 0) {
                    return `Infant`
                } else if ($data == 1) {
                    return `Child`
                } else if ($data == 2) {
                    return `Adult`
                }
            }
            
            async function route_array($data) {
                var output = "";
                var data = $data
                const isMobile = window.innerWidth <= 768; // Adjust breakpoint as needed

                var detial_class = "items-center gap-2";
                if (isMobile){
                    detial_class = "flex-col gap-1"
                }

                for (var i = 0; i < data.length; i++) {
                    output += `<div class="mb-5"><div class="ticketContainer__details__path__item pathItem flex gap-2 relative">
                   
                    <div class="ticketContainer__details__path__item__times pathItem__times flex flex-col justify-between items-center w-1/6">
                        <span class="pathItem__times__start text-nowrap text-sm">
                           ${data[i].route.etime}
                        </span>
                        <span class="pathItem__times__duration flex items-center gap-1 text-xs text-gray-500 mt-4">
                            <svg width="12" height="12" viewBox="0 0 9 9" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip0_1_755)">
                                    <path
                                        d="M4.5 0.375C3.68415 0.375 2.88663 0.616927 2.20827 1.07019C1.52992 1.52345 1.00121 2.16769 0.688999 2.92143C0.376787 3.67518 0.295099 4.50458 0.454263 5.30475C0.613427 6.10492 1.00629 6.83992 1.58319 7.41682C2.16008 7.99371 2.89508 8.38658 3.69525 8.54574C4.49543 8.7049 5.32483 8.62321 6.07857 8.311C6.83232 7.99879 7.47655 7.47008 7.92981 6.79173C8.38307 6.11338 8.625 5.31585 8.625 4.5C8.62371 3.40638 8.1887 2.35792 7.41539 1.58461C6.64208 0.811302 5.59362 0.37629 4.5 0.375ZM4.5 7.875C3.83249 7.875 3.17997 7.67706 2.62495 7.30621C2.06994 6.93536 1.63735 6.40826 1.38191 5.79156C1.12646 5.17486 1.05963 4.49626 1.18985 3.84157C1.32008 3.18688 1.64151 2.58552 2.11352 2.11351C2.58552 1.64151 3.18689 1.32007 3.84157 1.18985C4.49626 1.05962 5.17486 1.12646 5.79156 1.38191C6.40826 1.63735 6.93536 2.06993 7.30621 2.62495C7.67706 3.17997 7.875 3.83249 7.875 4.5C7.87391 5.39477 7.51798 6.25258 6.88528 6.88528C6.25258 7.51798 5.39477 7.87391 4.5 7.875Z"
                                        fill="#BEBBCE" />
                                    <path
                                        d="M4.875 4.34475V2.25C4.875 2.15054 4.83549 2.05516 4.76516 1.98484C4.69484 1.91451 4.59946 1.875 4.5 1.875C4.40054 1.875 4.30516 1.91451 4.23484 1.98484C4.16451 2.05516 4.125 2.15054 4.125 2.25V4.5C4.12502 4.59945 4.16454 4.69482 4.23488 4.76512L5.35988 5.89012C5.4306 5.95843 5.52533 5.99623 5.62365 5.99538C5.72197 5.99452 5.81603 5.95508 5.88556 5.88556C5.95509 5.81603 5.99452 5.72197 5.99538 5.62365C5.99623 5.52533 5.95843 5.4306 5.89012 5.35988L4.875 4.34475Z"
                                        fill="#BEBBCE" />
                                </g>
                                <defs>
                                    <clipPath id="clip0_1_755">
                                        <rect width="9" height="9" fill="white" />
                                    </clipPath>
                                </defs>
                            </svg>
                            ${data[i].route.timing}  
                        </span>
                    </div>

           

            <div class="ticketContainer__details__path__item__path pathItem__path flex flex-col items-center relative border-l-2 border-dashed border-gray-400 w-2.5">
    <img class="max-w-none absolute right-0 z-10" src="images/airplane-route.png" width="17" height="23" alt="airplane-route"/>
</div>
                    <div class="ticketContainer__details__path__item__details pathItem__details w-4/6 pl-2.5">

                        <h3 class="pathItem__details__city text-xl">${data[i].route.startairport.startotherinfo.city}</h3>
                        <span class="pathItem__details__airport text-xs text-gray-500">${data[i].route.startairport.airport}</span>

                        <div class="pathItem__details__airline flex ${detial_class} text-xs text-gray-500 mt-1">
                            <span class="flex gap-1 items-center">
                                <img class="mr-2.5" src="${data[i].route.airlineimage}" width="50" height="50" alt="${data[i].route.airline}"/>
                                ${data[i].route.airline} |
                            </span>
                            <span class="flex gap-1 items-center">
                                <span>flight number:</span>
                                <span>${data[i].route.routecode} | </span>
                            </span>
                            <span class="flex gap-1 items-center">
                                <span>${data[i].route.class} - ${data[i].route.classCode} | </span>
                            </span>
                            <span class="flex gap-1 items-center">
                                <span>
                                    <svg class="w-3 h-3" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M10.9496 6.48717C10.9482 6.47081 10.941 6.42787 10.905 6.40762C10.8799 6.39243 10.8499 6.39749 10.8299 6.40762L10.8099 6.41774C9.7994 7.09622 8.58379 7.54685 7.30815 7.73419C7.12806 7.75951 6.94797 7.64305 6.89795 7.46078C6.78789 7.04559 6.43272 6.77217 6.0075 6.77217H5.9925L5.91363 6.77535C5.52384 6.8069 5.20523 7.07154 5.10205 7.46078C5.05203 7.64305 4.87194 7.75951 4.69185 7.73419C3.41621 7.54685 2.2006 7.09622 1.1901 6.41774C1.18509 6.41268 1.13507 6.3823 1.09505 6.40762C1.05002 6.43293 1.05002 6.49369 1.05002 6.49369L1.08504 9.07596L1.08751 9.17503C1.13839 10.1922 1.9683 11 2.98599 11H9.009L9.10688 10.9975C10.1119 10.946 10.91 10.106 10.91 9.07596L10.95 6.49369L10.9496 6.48717ZM5.62578 7.82488C5.6509 7.64088 5.80949 7.49622 5.9975 7.49622C5.2076 7.49622 6.37269 7.66837 6.37269 7.87597V8.52913L6.36932 8.58127C6.34486 8.76847 6.19009 8.90887 5.9975 8.90887C5.7924 8.90887 5.62231 8.74178 5.62231 8.52913V7.87597L5.62578 7.82488Z" fill="black"></path>
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M8.10355 2.30632C8.0085 1.57215 7.3932 1 6.64282 1H5.35218C4.6018 1 3.98649 1.57215 3.89145 2.30632H2.90595C1.85543 2.30632 1 3.17214 1 4.23543C1 4.23543 1.02501 5.0658 1.04002 5.32403C1.04002 5.37466 1.06503 5.42023 1.10505 5.44555L1.58529 5.77972C2.41071 6.32706 3.37569 6.71845 4.3952 6.91389C4.46173 6.92655 4.52676 6.89263 4.56128 6.83389C4.85793 6.33415 5.4012 6.01263 5.9975 6.01263C6.5978 6.01263 7.13607 6.33769 7.42421 6.83693C7.45823 6.89668 7.52426 6.93162 7.5913 6.91845C8.61931 6.72352 9.58429 6.33162 10.4147 5.77466C10.4347 5.76453 10.6548 5.6177 10.8954 5.43998C10.935 5.41061 10.959 5.362 10.96 5.31238C10.97 4.68555 11 4.23543 11 4.23543C11 3.17214 10.1446 2.30632 9.09405 2.30632H8.10355ZM5.35218 1.75949H6.64282C6.97799 1.75949 7.26313 1.9924 7.34317 2.30632H4.65183C4.73187 1.9924 5.01701 1.75949 5.35218 1.75949Z" fill="black"></path>
                                    </svg>
                                </span>
                                <span>${data[i].route.baggage.CheckedBag}</span>
                            </span>
                        </div>
                    </div>
                </div>
              <div class="ticketContainer__details__path__item pathItem flex gap-2 relative">
                   
                    <div
                        class="ticketContainer__details__path__item__times pathItem__times flex flex-nowrap justify-end flex-col items-center w-1/6">
                        <span class="pathItem__times__start text-nowrap text-sm">
                           ${data[i].route.atime}
                        </span>
                    </div>
                 <div class="ticketContainer__details__path__item__path pathItem__path flex flex-col items-center relative border-l-2 border-dashed border-gray-400 w-2.5">
    <div class="w-2 h-2 rounded-full bg-gray-400 absolute bottom-0 right-[5px]"></div>
</div>
                    <div class="ticketContainer__details__path__item__details pathItem__details w-4/6 pl-2.5 pt-8">

                        <h3 class="pathItem__details__city text-xl">${data[i].route.endairport.endotherinfo.city}</h3>
                        <span class="pathItem__details__airport text-xs text-gray-500">${data[i].route.endairport.airport}</span>

                      
                        <div
                        class="class=pathItem__details__airline flex ${detial_class} text-xs text-gray-500 mt-1">
                        <span class="flex gap-1 items-center">
                            <img class="mr-2.5" src="${data[i].route.airlineimage}" width="50" height="50" alt="${data[i].route.airline}"/>
                            ${data[i].route.airline} |
                        </span> 

                        <span class="flex gap-1 items-center">
                            <span>flight number: </span>

                            <span>${data[i].route.routecode}</span> |
                        </span> 

                        <span class="flex gap-1 items-center">
                            <span>${data[i].route.class} - ${data[i].route.classCode}</span> |
                        </span> 

                        <span class="flex gap-1 items-center">
                            <span><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M10.9496 6.48717C10.9482 6.47081 10.941 6.42787 10.905 6.40762C10.8799 6.39243 10.8499 6.39749 10.8299 6.40762L10.8099 6.41774C9.7994 7.09622 8.58379 7.54685 7.30815 7.73419C7.12806 7.75951 6.94797 7.64305 6.89795 7.46078C6.78789 7.04559 6.43272 6.77217 6.0075 6.77217H5.9925L5.91363 6.77535C5.52384 6.8069 5.20523 7.07154 5.10205 7.46078C5.05203 7.64305 4.87194 7.75951 4.69185 7.73419C3.41621 7.54685 2.2006 7.09622 1.1901 6.41774C1.18509 6.41268 1.13507 6.3823 1.09505 6.40762C1.05002 6.43293 1.05002 6.49369 1.05002 6.49369L1.08504 9.07596L1.08751 9.17503C1.13839 10.1922 1.9683 11 2.98599 11H9.009L9.10688 10.9975C10.1119 10.946 10.91 10.106 10.91 9.07596L10.95 6.49369L10.9496 6.48717ZM5.62578 7.82488C5.6509 7.64088 5.80949 7.49622 5.9975 7.49622C6.2076 7.49622 6.37269 7.66837 6.37269 7.87597V8.52913L6.36932 8.58127C6.34486 8.76847 6.19009 8.90887 5.9975 8.90887C5.7924 8.90887 5.62231 8.74178 5.62231 8.52913V7.87597L5.62578 7.82488Z" fill="black"></path>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M8.10355 2.30632C8.0085 1.57215 7.3932 1 6.64282 1H5.35218C4.6018 1 3.98649 1.57215 3.89145 2.30632H2.90595C1.85543 2.30632 1 3.17214 1 4.23543C1 4.23543 1.02501 5.0658 1.04002 5.32403C1.04002 5.37466 1.06503 5.42023 1.10505 5.44555L1.58529 5.77972C2.41071 6.32706 3.37569 6.71845 4.3952 6.91389C4.46173 6.92655 4.52676 6.89263 4.56128 6.83389C4.85793 6.33415 5.4012 6.01263 5.9975 6.01263C6.5978 6.01263 7.13607 6.33769 7.42421 6.83693C7.45823 6.89668 7.52426 6.93162 7.5913 6.91845C8.61931 6.72352 9.58429 6.33162 10.4147 5.77466C10.4347 5.76453 10.6548 5.6177 10.8954 5.43998C10.935 5.41061 10.959 5.362 10.96 5.31238C10.97 4.68555 11 4.23543 11 4.23543C11 3.17214 10.1446 2.30632 9.09405 2.30632H8.10355ZM5.35218 1.75949H6.64282C6.97799 1.75949 7.26313 1.9924 7.34317 2.30632H4.65183C4.73187 1.9924 5.01701 1.75949 5.35218 1.75949Z" fill="black"></path>
                            </svg></span>

                            <span>${data[i].route.baggage.CheckedBag}</span>
                        </span>
                    </div>
                    </div>
                </div>
            </div>
            ${await connection_time(data[i].route.connectionTime)}`
                }
                return output;
            }

            function baggages_array($data) {

                var output = "";
                var data = $data
                if (data.length > 0) {
                    for (var i = 0; i < data.length; i++) {
                        output += `<div>${data[i].baggage.type}</div><div>${data[i].baggage.title}</div><br/>`
                    }
                    return output;
                }


            }

            function pdf_desc_array($data) {
                var output = "";
                var data = $data
                if (data.length > 0) {
                    for (var i = 0; i < data.length; i++) {
                        output += `<div>${data[i].note.title}</div><div>${data[i].note.text}</div><br/>`
                    }
                    return output;
                }
            }

            function desc_array($data) {

                var output = "";
                var data = $data

                if (data.length > 0) {
                    for (var i = 0; i < data.length; i++) {
                        if (data[i].departure !== undefined) {
                            output += `<div>${JSON.stringify(data[i].departure.left)}</div>
         <div>${data[i].departure.right}</div>`
                        }
                        if (data[i].return !== undefined) {
                            output += `<div>${data[i].return.left}</div>
            <div>${data[i].return.right}</div>`
                        }
                    }
                    document.getElementById("desc_array").innerHTML = output;
                }

            }
            
            function connection_time($data) {
                var output = "";
                var data = $data
                if (data !== undefined) {
                    let connectiontime = parseFloat(data)
                    if (connectiontime !== 0) {
                        const hours = Math.floor(connectiontime / 60);
                        const minutes = connectiontime % 60;
                        output += `<div class="w-full mb-5 rounded border-x border-y border-gray-400 border-2 border-dashed p-1 text-gray-500 text-xs"><span>Connection Time  ${hours}H : ${minutes}M</span></div>`
                    }
                    return output;
                }
            }
            
            async function multi_route_array($data) {
                var output = "";
                var data = $data
                if (data.length > 1) {
                    for (var i = 1; i < data.length; i++) {
                        var segment_len = data[i].segment.length
                        output += `
            <div class="return_stracture ticketContainer border-2 border-dashed overflow-hidden border-gray-400 rounded-2xl mx-auto max-w-screen-md min-w-[900px] shrink-0 max-lg:w-full max-lg:min-w-0 max-lg:min-w-0 max-lg:max-w-full">
        <div class="ticketContainer__details w-full">
            <div class="ticketContainer__details__time px-4 py-2 flex gap-3 w-full items-center text-sm">Route ${data[i].segment_id} : </div>
            <div class="ticketContainer__details__time px-4 py-2 flex gap-3 w-full items-center bg-yellow-300 text-sm">
                

                <div class="ticketContainer__details__time__flight flex items-center gap-2 shrink-0">
                            <svg width="22" height="22" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip0_1_717)">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="M12.9967 4.04383C12.4616 3.83566 11.7331 3.91 11.0456 4.24442C10.4088 4.55709 9.78484 4.91151 9.11998 5.26178C8.30949 4.65771 7.48892 4.07605 6.6662 3.49506C6.1033 3.09873 5.55654 2.99132 5.04397 3.17539C4.75521 3.27773 4.48568 3.41493 4.22368 3.54778C4.11657 3.60258 4.0077 3.65757 3.89561 3.71157C3.7801 3.76681 3.69244 3.86712 3.65247 3.98997C3.6128 4.11145 3.62499 4.24437 3.6862 4.35748L5.30417 7.34695C4.95632 7.53815 4.54275 7.7678 4.13505 7.99418C3.77818 8.19254 3.42503 8.3883 3.12222 8.55566L2.87823 8.10715C2.75308 7.88034 2.46796 7.79743 2.24155 7.9221C2.01504 8.04589 1.93134 8.33197 2.0565 8.55878L2.48153 9.33888C3.41411 11.0117 4.96594 11.4859 6.63407 10.6058C8.41206 9.6675 10.3557 8.61404 12.7506 7.2883C13.0439 7.12684 13.3203 6.90271 13.537 6.63508C13.9201 6.162 14.1135 5.55465 13.8625 4.92513C13.6961 4.50402 13.3965 4.19867 12.9967 4.04383Z"
                                        fill="#2F2F2F" />
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="M12.1 13.2007H3.27127C3.01252 13.2007 2.80252 13.4107 2.80252 13.6695C2.80252 13.9282 3.01252 14.1382 3.27127 14.1382H12.1C12.3588 14.1382 12.5688 13.9282 12.5688 13.6695C12.5688 13.4107 12.3588 13.2007 12.1 13.2007Z"
                                        fill="#2F2F2F" />
                                </g>
                                <defs>
                                    <clipPath id="clip0_1_717">
                                        <rect width="15" height="15" fill="white" />
                                    </clipPath>
                                </defs>
                            </svg>
        
                            <span id="flightDate" class=" text-sm">${await convertDateFormat(data[i].segment[0].route.routeDate.mstring)}</span>
                            |
                            <span id="flightTime" class=" text-sm">${data[i].segment[0].route.etime}</span>
                        </div>


                        <div class="ticketContainer__details__time__arrow h-1 w-full flex justify-end relative">
                           <img class="absolute right-[-6px] top-[-14px] z-10"  src="images/arrow-rtl.png" width="32" height="32" alt="arrow-rtl"/>
                        </div>


                        <div class="ticketContainer__details__time__landing flex items-center gap-2 shrink-0">
                            <svg width="22" height="22" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M12.9765 9.27775C12.8015 8.73088 12.2852 8.2115 11.5927 7.88775C10.949 7.58963 10.2809 7.32775 9.59024 7.0315C9.54961 6.02148 9.48524 5.01773 9.41899 4.01273C9.37274 3.32585 9.11211 2.83335 8.64649 2.55085C8.38524 2.39085 8.10899 2.26773 7.84086 2.14773C7.73086 2.09898 7.61961 2.04898 7.50711 1.99585C7.39149 1.94085 7.25836 1.93585 7.13774 1.9821C7.01836 2.02773 6.92274 2.12085 6.87336 2.2396L5.56837 5.37835C5.20087 5.22835 4.76212 5.05148 4.32962 4.8771C3.95087 4.7246 3.57649 4.57335 3.25587 4.44335L3.45087 3.97148C3.54837 3.73148 3.43337 3.45773 3.19399 3.36023C2.95524 3.2621 2.68024 3.3771 2.58274 3.6171L2.24399 4.43835C1.53087 6.21585 2.13899 7.72025 3.87274 8.46275C5.72087 9.254 7.76274 10.1015 10.3002 11.1284C10.6102 11.2546 10.9584 11.3284 11.3027 11.3284C11.9115 11.3284 12.5052 11.0965 12.8365 10.5053C13.059 10.1109 13.1077 9.68588 12.9765 9.27775Z"
                                    fill="#2F2F2F" />
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M12.1 13.2007H3.27127C3.01252 13.2007 2.80252 13.4107 2.80252 13.6695C2.80252 13.9282 3.01252 14.1382 3.27127 14.1382H12.1C12.3588 14.1382 12.5688 13.9282 12.5688 13.6695C12.5688 13.4107 12.3588 13.2007 12.1 13.2007Z"
                                    fill="#2F2F2F" />
                            </svg>
                            <span id="landingDate" class=" text-sm">${await convertDateFormat(data[i].segment[segment_len - 1].route.routeDate.mstring)}</span> | 
                            <span id="landingTime" class=" text-sm">${data[i].segment[segment_len - 1].route.atime}</span>
                        </div>
            </div>
            <div class="ticketContainer__details__path pathContainer p-4 flex flex-col">
                ${await route_array(data[i].segment)}
            </div>
            </div></div>`
                    }
                    return output;
                }
            }
            
            function convertDateFormat($data) {
                var output = "";
                var dateString = $data;
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const parts = dateString.split('-');
                const year = parts[0];
                const month = monthNames[parseInt(parts[1]) - 1];
                const day = parts[2];
                return `${day} ${month} ${year}`;
            }
        


            
    function detectDirection(text) {
        const rtlChars = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/; // محدوده یونیکد عربی و فارسی
        return rtlChars.test(text) ? 'rtl' : 'ltr';
    }



    async function RenderInfoCard($data) {
        let hotelJson = $data;

        if (!hotelJson || !hotelJson.hotelinfo) {
            console.error("Invalid hotel data:", hotelJson);
            return '<div class="text-red-500">Invalid hotel data provided.</div>';
        }

        const hotel = hotelJson.hotelinfo;
        const checkin = hotelJson.checkin?.mstring ? formatDateToReadable(hotelJson.checkin.mstring) : "";
        const checkout = hotelJson.checkout?.mstring ? formatDateToReadable(hotelJson.checkout.mstring) : "";
        const nights = hotelJson.nights || 0;
        const roomsCount = hotelJson.rooms?.length || 0;

        let infocard = `
<div class="w-3/5">
    <div class="flex leading-5 gap-x-3">
        <figure class="w-[80px] h-[80px] rounded-[5px] overflow-hidden">
            <img class="w-[80px] h-[80px] object-cover " width="80" height="80" src="${hotel.hotelimage}"
                alt="${hotel.hotelname}" />
        </figure>
        <div class="flex flex-col gap-y-1">
            <h2 class="text-lg font-danademibold">
                ${hotel.hotelname}
            </h2>
            <div class="flex items-center">
                ${RenderRateHotel(hotel.star)}
                <span class="text-sm ml-2 font-danaregular">${hotel.star} ستاره </span>
            </div>
            <span class="text-base font-danaregular">${hotel.country} / ${hotel.city}</span>
        </div>
    </div>

    <div class="mt-3">
                        <ul class="flex flex-col gap-y-2 font-danaregular">
                            <li>
                                <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">
                                    <svg class="scale-150 origin-center" width="13" height="13">
                                        <use href="./images/pdf-sprite-icons.svg#location-icon-pdf"></use>
                                    </svg>
                                    <span>
                                        veniam, quis nostrud exercitation ullamco laboris
                                    </span>
                                </div>
                            </li>
                            <li>
                                <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">

                                    <svg class="scale-150 origin-center" width="12" height="13">
                                        <use href="./images/pdf-sprite-icons.svg#call-icon-pdf"></use>
                                    </svg>
                                    <span>
                                        +51-556699774411
                                    </span>
                                </div>
                            </li>
                            <li>
                                <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">

                                    <svg class="scale-150 origin-center" width="13" height="13">
                                        <use href="./images/pdf-sprite-icons.svg#email-icon-pdf"></use>
                                    </svg>
                                    <span>
                                        heydarimohsen71@gmail.com
                                    </span>
                                </div>
                            </li>
                            <li>
                                <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">

                                    <svg class="scale-150 origin-center" width="13" height="13">
                                        <use href="./images/pdf-sprite-icons.svg#www-icon-pdf"></use>
                                    </svg>
                                    <span>
                                        www.moshenheydari.com
                                    </span>
                                </div>
                            </li>
                        </ul>
    </div>
</div>
<div class="w-2/5 border-r-2 border-[#E3E3E3] pr-3 ">
    <ul class="flex flex-col gap-y-2">
        <li>
            <h2 class="text-base font-danademibold">زمان ورورد</h2>
            <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">
                <svg class="scale-150 origin-center" width="13" height="13">
                    <use href="./images/pdf-sprite-icons.svg#calendar-icon-pdf"></use>
                </svg>
                <span class="font-danaregular dir-ltr">
                ${checkin}
                (${hotelJson.checkin?.sstring})
                </span>
            </div>
        </li>
        <li>
            <h2 class="text-base font-danademibold">زمان خروج</h2>
            <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">
                <svg class="scale-150 origin-center" width="13" height="13">
                    <use href="./images/pdf-sprite-icons.svg#calendar-icon-pdf"></use>
                </svg>
                <span class="font-danaregular dir-ltr">
                ${checkout}
                (${hotelJson.checkout?.sstring})
                </span>
            </div>
        </li>
        <li>
            <h2 class="text-base font-danademibold">تعداد شب ها</h2>
            <div class="flex items-center w-full gap-x-2 text-sm text-[#242424] font-danaregular">
                ${nights}
            </div>
        </li>
        <li>
            <h2 class="text-base font-danademibold">تعداد اتاق ها</h2>
            <div class="flex items-center w-full gap-x-2 text-sm text-[#242424] font-danaregular">
                ${roomsCount}
            </div>
        </li>
    </ul>
</div>`;

        return infocard;
    }



    async function renderRules($data) {
        const rules = $data?.pdf_description;
        if (!rules || !Array.isArray(rules)) {
            console.warn("هیچ آیتمی در pdf_description پیدا نشد");
            return null;
        }

        let direction;
        direction = detectDirection(rules[0].note.text);

        let ulitem = '';
        rules.forEach((item, index) => {
            const text = item?.note?.text?.trim();

            if (text) {
                ulitem += `<li>${text}</li>`;
            } else {
                console.warn(`آیتم ${index} متن معتبری ندارد`, item);
            }
        });

        return `<ul dir="${direction}">${ulitem}</ul>`;
    }


    function RenderRateHotel(starCount) {
        let stars = '';
        for (let i = 0; i < starCount; i++) {
            stars += `
            <svg width="14" height="14">
                <use href="./images/pdf-sprite-icons.svg#star-icon-pdf"></use>
            </svg>`;
        }
        return stars;
    }

    function formatDateToReadable(dateString) {
        const date = new Date(dateString);
        const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: '2-digit'
        };
        const formatted = date.toLocaleDateString('en-US', options);
        const [weekday, month, day, year] = formatted.replace(',', '').split(' ');
        return `${day} ${month} ${year} / ${weekday}`;
    }

    async function renderRooms($data) {
        let hotelinfo = $data?.hotelinfo;
        let roominfo = $data?.rooms;
        let roomcontent = '';

        roominfo.forEach((room) => {
            const parsedPassengers = room.passengers.map(p => {
                const typeRaw = p.type || '';
                const typeMatch = typeRaw.match(/^([^\(]+)(?:\s*\((.+)\))?/);
                const passengerType = typeMatch?.[1]?.trim() || '–';
                const passengerAge = typeMatch?.[2]?.trim() || (p.age || '–');

                return {
                    name: `${p.fullname.firstname.trim()} ${p.fullname.lastname.trim()}`,
                    type: passengerType,
                    age: passengerAge
                };
            });

            const passengerNames = parsedPassengers.map(p =>
                `<h2 class="text-[#292929] text-sm font-danademibold">${p.name}</h2>`
            ).join('');

            const passengerTypes = parsedPassengers.map(p =>
                `<h2 class="text-[#292929] text-sm font-danademibold">${p.type}</h2>`
            ).join('');

            const passengerAges = parsedPassengers.map(p =>
                `<h2 class="text-[#292929] text-sm font-danademibold">${p.age}</h2>`
            ).join('');

            const childrenCount = (room.numpassenger.childwithbed || 0) + (room.numpassenger.childwithoutbed || 0);

            roomcontent += `
            <h2 class="font-bold text-2xl my-2 font-danabold">اتاق ${room.index}</h2>
            <div class="bg-[#F4FBF9] rounded-xl p-4 flex flex-wrap justify-between gap-4">
                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-danaregular">نوع اتاق</span>
                    <div class="text-[#292929] text-sm font-danademibold self-center flex justify-center items-center h-[calc(100%-20px)]">${room.roomtype.trim()}</div>
                </div>

                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-danaregular">خدمات</span>
                    <div class="text-[#292929] text-sm font-danademibold self-center flex justify-center items-center h-[calc(100%-20px)]">
                        ${escapeXML(hotelinfo.services)}
                    </div>
                </div>

                <!-- Passenger Names -->
                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-danaregular">مسافران</span>
                    ${passengerNames}
                </div>

                <!-- Passenger Types (Gender) -->
                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-danaregular">نوع مسافر</span>
                    ${passengerTypes}
                </div>

                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-danaregular">سن</span>
                    ${passengerAges}
                </div>

                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-danaregular">وضعیت</span>
                    <div class="text-[#292929] text-sm font-danademibold self-center flex justify-center items-center h-[calc(100%-20px)]">
                        ${room.onrequest === "1" ? "On Request" : "Available"}
                    </div>
                </div>
            </div>
        `;
        });

        return roomcontent;
    }


    function escapeXML(str) {
        return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&apos;");
    }


    async function getLocalizedText(dir, faText, enText) {
        const isRTL = dir === 'rtl';
        return isRTL ? faText : enText;
    }


    async function checkSection(input) {


        // اگر ورودی null یا undefined یا رشته خالی بود
        if (
            input === null ||
            input === undefined ||
            (typeof input === 'string' && input.trim() === '')
        ) {
            return 'hidden';
        }

        // اگر رشته HTML هست مثل <p></p> یا <div>  </div> یا فقط تگ‌های خالی
        if (typeof input === 'string') {
            const temp = document.createElement('div');
            temp.innerHTML = input;

            // اگر هیچ متن قابل‌نمایشی نداشت
            if (temp.textContent.trim() === '') {
                return 'hidden';
            }
        }

        // در غیر اینصورت مشکلی نیست
        return '';
    }



</script>

</html>