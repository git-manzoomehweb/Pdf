<basis core="call" lid="1" file="Client_CheckRkey.inc"></basis>


<!DOCTYPE html>
<html lang="fa">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice PDF</title>
  <link rel="stylesheet" href="[##cms.cms.cdn##]/css/pdf-ui.min.css">
  <script src="[##cms.cms.cdn##]/js/html2pdf.bundle.min.js"></script>
</head>

<body class="p-0 m-0">

  <basis core="group" name="invalid-rkey" if="'[##db.checkrkey.checked##]'<>'true'">
    <div
      class="dir-rtl bg-red-300 border-2 border-red-500 rounded-xl py-4 px-8 font-danaregular max-w-7xl text-center w-fit mx-auto my-auto absolute top-0 left-0 right-0 bottom-0 h-fit ">
      شما اجازه دسترسی به این صفحه را ندارید </div>
  </basis>

  <basis core="group" name="valid-rkey" if="'[##db.checkrkey.checked##]'='true'">
    <basis core="api" name="api.Webservice" url="https://www.basisfly.com/panel/main/view/[##cms.query.rkey##]"
      method="post" body='{
            "name": "db", 
            "mid": "20", 
            "member":
            [
                { 
                    "name": "q", 
                    "type":"list", 
                    "request":"invoice_pdf", 
                    "id":"[##cms.query.id##]"
                }
            ] 
        }' content-type="application/json" run="atclient">
    </basis>




    <header id="pdf-header" class="header h-[80px] w-auto mx-auto "><img
        class="block h-[80px] w-auto mx-auto object-contain" src="[##cms.cms.cdn##]/images/Header-contract-pdf.jpg"
        width="794" height="100" alt="Footer-contract-pdf" />
    </header>


    <main class="dir-rtl pdf-content py-6 w-full max-w-[794px] mx-auto font-dana_FANum_regular">

      <div class="pdf-loading hidden fixed z-[99] w-full h-full pt-[20%] bg-[#8d8d8d8c]">
        <div class="flex justify-center items-center">
          <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-gray-900"></div>
        </div>
      </div>

      <div class="w-[95%] mx-auto">
        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await getOwner($data.invoiceDetails.ownerid)}}
            </script>
          </face>
        </basis>



        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await setInvoiceType($data.invoiceDetails.invoicetype)}}
              {{return await renderInvoiceDetails($data)}}
            </script>
          </face>
        </basis>

        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await renderAllProducts($data.products)}}
            </script>
          </face>
        </basis>

        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await renderPassengers($data.passengers , $data)}}
            </script>
          </face>
        </basis>

        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await renderPriceDetailsSection($data , $data.priceDetails)}}
            </script>
          </face>
        </basis>

        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>@child </layout>
          <face>
            <script type="text/template">
              {{return await renderBillSection($data.bill)}}
            </script>
          </face>
        </basis>

        <basis core="print" datamembername="db.invoice_pdf" run="atclient">
          <layout>
            @child
          </layout>
          <face>
            <script type="text/template">
              {{return await renderDescription($data)}}
            </script>
          </face>
        </basis>
      </div>
    </main>

    <footer id="pdf-footer" class=" footer h-[80px] print:w-[595pt] print:h-[100pt] mx-auto "><img
        class="block mx-auto h-[80px] print:w-[595pt] print:h-[100pt] w-auto object-contain"
        src="[##cms.cms.cdn##]/images/Footer-contract-pdf.jpg" width="794" height="100" alt="Footer-contract-pdf" />
    </footer>

    <basis core="call" lid="1" file="Client_BasisCore_Script.inc"></basis>
  </basis>



  <script>
    let globalInvoiceType = null;
    function setInvoiceType(type) {
      globalInvoiceType = type;
      console.log(globalInvoiceType)
    }


    function safeValue(value) {
      return (value !== undefined && value !== null && value !== '') ? value : '-';
    }















    function renderBillSection(bill = {}) {
      const {
        totalprice = 0,
        commission = 0,
        totalwithcommisions = 0,
        unit = "-",
        coupon = {}
      } = bill;

      const { couponcost = 0, couponcode = "-" } = coupon;

      const formatPrice = (num) => {
        if (typeof num === 'number') return num.toLocaleString();
        const parsed = parseFloat(num);
        return isNaN(parsed) ? "-" : parsed.toLocaleString();
      };

      return `
    <section class="dir-ltr mt-4">
      <h2 class="text-base font-danabold flex items-center gap-x-2 ">
        <svg class="h-5" width="17" height="17">
          <use href="./images/pdf-sprite-icons.svg#bank-card-icon-pdf"></use>
        </svg>
        <span>Total Cost Table</span>
      </h2>
      <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
        <table class="w-full text-left border-separate border-spacing-y-2 border-none">
          <thead>
            <tr>
              <th class="text-[#6D6D6D] text-xs font-danaregular">Total Cost :</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">Commission :</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">Discount :</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">Discount code:</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">Cost by Commission :</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">Unit:</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-[#292929] text-xs font-danamedium">${formatPrice(totalprice)}</td>
              <td class="text-[#292929] text-xs font-danamedium">${formatPrice(commission)}</td>
              <td class="text-[#292929] text-xs font-danamedium">${formatPrice(couponcost)}</td>
              <td class="text-[#292929] text-xs font-danamedium">${safeValue(couponcode)}</td>
              <td class="text-[#292929] text-xs font-danamedium">${formatPrice(totalwithcommisions)}</td>
              <td class="text-[#292929] text-xs font-dana_FANum_medium">${safeValue(unit)}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  `;
    }

    function renderPriceDetailsSection($data, priceDetails = {}) {
      const type = $data?.invoiceDetails?.invoicetype;

      const formatPrice = (num) => {
        if (typeof num === 'number') return num.toLocaleString();
        const parsed = parseFloat(num);
        return isNaN(parsed) ? "-" : parsed.toLocaleString();
      };

      // جدول دو ردیفه با هدر (label) و مقدار (value) کنار هم
      const renderMultiRowTable = (columns = []) => {
        const headers = columns.map(col => `
      <th class="text-[#6D6D6D] text-xs font-danaregular">${col.label}</th>
    `).join('');

        const values = columns.map(col => `
      <td class="text-[#292929] text-xs font-danamedium">
        ${col.label === 'Unit' ? col.value : formatPrice(col.value)}
      </td>
    `).join('');

        return `
      <table class="w-full text-left border-separate border-spacing-y-2 border-none">
        <thead>
          <tr>${headers}</tr>
        </thead>
        <tbody>
          <tr>${values}</tr>
        </tbody>
      </table>
    `;
      };

      // این تابع برای بخش‌های تک‌ردیفه (که قبلا بود)
      const renderRow = (label, value) => `
    <tr>
      <td class="text-[#6D6D6D] text-xs font-danaregular">${label}</td>
      <td class="text-[#292929] text-xs font-danamedium">
        ${label === 'Unit' ? value : formatPrice(value)}
      </td>
    </tr>
  `;

      const startSection = (title) => `
    <section class="dir-ltr mt-4">
      <h2 class="text-base font-danabold flex items-center gap-x-2">
        <svg class="h-5" width="17" height="17">
          <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
        </svg>
        <span>${title}</span>
      </h2>
      <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
        <table class="w-full text-left border-separate border-spacing-y-2 border-none">
          <tbody>
  `;

      const endSection = () => `
          </tbody>
        </table>
      </div>
    </section>
  `;

      const renderCostTableByProduct = ({
        flight = 0,
        hotel = 0,
        insurance = 0,
        service = 0,
        transfer = 0,
        visa = 0,
        total = 0,
        unit = '-'
      }) => `
    <section class="dir-ltr mt-4">
      <h2 class="text-base font-danabold flex items-center gap-x-2">
        <svg class="h-5" width="17" height="17">
          <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
        </svg>
        <span>Cost Table By Product</span>
      </h2>
      <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
        <table class="w-full text-left border-separate border-spacing-y-2 border-none">
          <thead>
            <tr>
              <th class="text-[#6D6D6D] text-xs font-danaregular">Flight :</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">Hotel :</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">Insurance :</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">service :</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">transfer :</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">visa :</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">Total Cost :</th>
              <th class="text-[#6D6D6D] text-xs font-danaregular">Unit :</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-[#292929] text-xs font-danamedium">${formatPrice(flight)}</td>
              <td class="text-[#292929] text-xs font-danamedium">${formatPrice(hotel)}</td>
              <td class="text-[#292929] text-xs font-danamedium">${formatPrice(insurance)}</td>
              <td class="text-[#292929] text-xs font-danamedium">${formatPrice(service)}</td>
              <td class="text-[#292929] text-xs font-danamedium">${formatPrice(transfer)}</td>
              <td class="text-[#292929] text-xs font-danamedium">${formatPrice(visa)}</td>
              <td class="text-[#292929] text-xs font-danamedium">${formatPrice(total)}</td>
              <td class="text-[#292929] text-xs font-dana_FANum_medium">${unit}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  `;

      switch (type) {

        case '3': { // Hotel Room Price
          const parts = [];

          if (Array.isArray(priceDetails.roomPrice)) {
            priceDetails.roomPrice.forEach((item, index) => {
              const roomData = item.room || {};
              const guests = Object.entries(roomData); // مانند [["adult", {...}]]

              guests.forEach(([guestType, guestData]) => {
                const { roomIndex, count, perperson, total, unit } = guestData;
                parts.push(`
          <section class="dir-ltr mt-4">
            <h2 class="text-base font-danabold flex items-center gap-x-2">
              <svg class="h-5" width="17" height="17">
                <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
              </svg>
              <span>Room ${roomIndex} - ${guestType.charAt(0).toUpperCase() + guestType.slice(1)}</span>
            </h2>
            <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
              <table class="w-full text-left border-separate border-spacing-y-2 border-none">
                <thead>
                  <tr>
                    <th class="text-[#6D6D6D] text-xs font-danaregular">Count</th>
                    <th class="text-[#6D6D6D] text-xs font-danaregular">Per Person</th>
                    <th class="text-[#6D6D6D] text-xs font-danaregular">Total</th>
                    <th class="text-[#6D6D6D] text-xs font-danaregular">Unit</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="text-[#292929] text-xs font-danamedium">${formatPrice(count)}</td>
                    <td class="text-[#292929] text-xs font-danamedium">${formatPrice(perperson)}</td>
                    <td class="text-[#292929] text-xs font-danamedium">${formatPrice(total)}</td>
                    <td class="text-[#292929] text-xs font-dana_FANum_medium">${unit}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>
        `);
              });
            });
          }

          return parts.join('');
        }


        case '4': { // tour
          const parts = [];

          if (Array.isArray(priceDetails.roomPrice)) {
            priceDetails.roomPrice.forEach((item, index) => {
              const roomData = item.room || {};
              const guests = Object.entries(roomData); // مثال: [["adult", [ { adult: {...} } ]] یا [["adult", { adult: {...} }]]

              guests.forEach(([guestType, guestList]) => {
                // حالت جدید: guestList یک آرایه از آبجکت‌هاست
                if (Array.isArray(guestList)) {
                  guestList.forEach((guestItem) => {
                    const guest = guestItem[guestType] || {};
                    const { roomIndex, count, perperson, total, unit } = guest;

                    parts.push(`
              <section class="dir-ltr mt-4">
                <h2 class="text-base font-danabold flex items-center gap-x-2">
                  <svg class="h-5" width="17" height="17">
                    <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
                  </svg>
                  <span>Room ${roomIndex} - ${guestType.charAt(0).toUpperCase() + guestType.slice(1)}</span>
                </h2>
                <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
                  <table class="w-full text-left border-separate border-spacing-y-2 border-none">
                    <thead>
                      <tr>
                        <th class="text-[#6D6D6D] text-xs font-danaregular">Count</th>
                        <th class="text-[#6D6D6D] text-xs font-danaregular">Per Person</th>
                        <th class="text-[#6D6D6D] text-xs font-danaregular">Total</th>
                        <th class="text-[#6D6D6D] text-xs font-danaregular">Unit</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="text-[#292929] text-xs font-danamedium">${formatPrice(count)}</td>
                        <td class="text-[#292929] text-xs font-danamedium">${formatPrice(perperson)}</td>
                        <td class="text-[#292929] text-xs font-danamedium">${formatPrice(total)}</td>
                        <td class="text-[#292929] text-xs font-dana_FANum_medium">${unit}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </section>
            `);
                  });
                }
                // حالت قدیمی: guestList آبجکت ساده است (بدون آرایه)
                else if (typeof guestList === 'object') {
                  const guest = guestList[guestType] || {};
                  const { roomIndex, count, perperson, total, unit } = guest;

                  parts.push(`
            <section class="dir-ltr mt-4">
              <h2 class="text-base font-danabold flex items-center gap-x-2">
                <svg class="h-5" width="17" height="17">
                  <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
                </svg>
                <span>Room ${roomIndex} - ${guestType.charAt(0).toUpperCase() + guestType.slice(1)}</span>
              </h2>
              <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
                <table class="w-full text-left border-separate border-spacing-y-2 border-none">
                  <thead>
                    <tr>
                      <th class="text-[#6D6D6D] text-xs font-danaregular">Count</th>
                      <th class="text-[#6D6D6D] text-xs font-danaregular">Per Person</th>
                      <th class="text-[#6D6D6D] text-xs font-danaregular">Total</th>
                      <th class="text-[#6D6D6D] text-xs font-danaregular">Unit</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="text-[#292929] text-xs font-danamedium">${formatPrice(count)}</td>
                      <td class="text-[#292929] text-xs font-danamedium">${formatPrice(perperson)}</td>
                      <td class="text-[#292929] text-xs font-danamedium">${formatPrice(total)}</td>
                      <td class="text-[#292929] text-xs font-dana_FANum_medium">${unit}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>
          `);
                }
              });
            });
          }

          return parts.join('');
        }






        // case '2': { // Two-way flight
        //   const parts = [];

        //   if (priceDetails.adult?.length) {
        //     priceDetails.adult.forEach((item, index) => {
        //       // دقت کن که item.adult وجود داره و مقادیرش
        //       const { special_class, count, perperson, total, unit } = item.adult;
        //       parts.push(`
        //     <section class="dir-ltr mt-4">
        //       <h2 class="text-base font-danabold flex items-center gap-x-2">
        //         <svg class="h-5" width="17" height="17">
        //           <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
        //         </svg>
        //         <span>Adult Ticket Info ${index + 1}</span>
        //       </h2>
        //       <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
        //         <table class="w-full text-left border-separate border-spacing-y-2 border-none">
        //           <thead>
        //             <tr>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Class</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Count</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Per Person</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Total</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Unit</th>
        //             </tr>
        //           </thead>
        //           <tbody>
        //             <tr>
        //               <td class="text-[#292929] text-xs font-danamedium">${special_class}</td>
        //               <td class="text-[#292929] text-xs font-danamedium">${formatPrice(count)}</td>
        //               <td class="text-[#292929] text-xs font-danamedium">${formatPrice(perperson)}</td>
        //               <td class="text-[#292929] text-xs font-danamedium">${formatPrice(total)}</td>
        //               <td class="text-[#292929] text-xs font-dana_FANum_medium">${unit}</td>
        //             </tr>
        //           </tbody>
        //         </table>
        //       </div>
        //     </section>
        //   `);
        //     });
        //   }

        //   return parts.join('');
        // }
        case '6': // Flight + Hotel + Insurance
          return renderCostTableByProduct(priceDetails);
        // case '8': { // train-1
        //   const parts = [];

        //   if (priceDetails.adult?.length) {
        //     priceDetails.adult.forEach((item, index) => {
        //       // دقت کن که item.adult وجود داره و مقادیرش
        //       const { special_class, count, perperson, total, unit } = item.adult;
        //       parts.push(`
        //     <section class="dir-ltr mt-4">
        //       <h2 class="text-base font-danabold flex items-center gap-x-2">
        //         <svg class="h-5" width="17" height="17">
        //           <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
        //         </svg>
        //         <span>Adult Ticket Info ${index + 1}</span>
        //       </h2>
        //       <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
        //         <table class="w-full text-left border-separate border-spacing-y-2 border-none">
        //           <thead>
        //             <tr>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Class</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Count</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Per Person</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Total</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Unit</th>
        //             </tr>
        //           </thead>
        //           <tbody>
        //             <tr>
        //               <td class="text-[#292929] text-xs font-danamedium">${special_class}</td>
        //               <td class="text-[#292929] text-xs font-danamedium">${formatPrice(count)}</td>
        //               <td class="text-[#292929] text-xs font-danamedium">${formatPrice(perperson)}</td>
        //               <td class="text-[#292929] text-xs font-danamedium">${formatPrice(total)}</td>
        //               <td class="text-[#292929] text-xs font-dana_FANum_medium">${unit}</td>
        //             </tr>
        //           </tbody>
        //         </table>
        //       </div>
        //     </section>
        //   `);
        //     });
        //   }

        //   return parts.join('');
        // }



        case '11': { // Lounge
          const parts = [];

          if (priceDetails.adult?.length) {
            priceDetails.adult.forEach(item => {
              const { count, perperson, total, unit } = item.adult;
              parts.push(`
            <section class="dir-ltr mt-4">
              <h2 class="text-base font-danabold flex items-center gap-x-2">
                <svg class="h-5" width="17" height="17">
                  <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
                </svg>
                <span>Adult Lounge Info</span>
              </h2>
              <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
                ${renderMultiRowTable([
                { label: 'Count', value: count },
                { label: 'Per Person', value: perperson },
                { label: 'Total', value: total },
                { label: 'Unit', value: unit }
              ])}
              </div>
            </section>
          `);
            });
          }

          if (priceDetails.services?.length) {
            priceDetails.services.forEach(item => {
              const { name, count, perperson, total, unit } = item.service;
              parts.push(`
            <section class="dir-ltr mt-4">
              <h2 class="text-base font-danabold flex items-center gap-x-2">
                <svg class="h-5" width="17" height="17">
                  <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
                </svg>
                <span>Service: ${name}</span>
              </h2>
              <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
                ${renderMultiRowTable([
                { label: 'Count', value: count },
                { label: 'Per Person', value: perperson },
                { label: 'Total', value: total },
                { label: 'Unit', value: unit }
              ])}
              </div>
            </section>
          `);
            });
          }

          if (priceDetails.transfers?.length) {
            priceDetails.transfers.forEach(item => {
              const { car_name, perperson, total, unit } = item.transfer;
              parts.push(`
            <section class="dir-ltr mt-4">
              <h2 class="text-base font-danabold flex items-center gap-x-2">
                <svg class="h-5" width="17" height="17">
                  <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
                </svg>
                <span>Transfer: ${car_name}</span>
              </h2>
              <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
                ${renderMultiRowTable([
                { label: 'Per Person', value: perperson },
                { label: 'Total', value: total },
                { label: 'Unit', value: unit }
              ])}
              </div>
            </section>
          `);
            });
          }

          if (priceDetails.escortinfo?.length) {
            priceDetails.escortinfo.forEach(item => {
              const { firsname, lastname, perperson, total, unit } = item.escort;
              parts.push(`
            <section class="dir-ltr mt-4">
              <h2 class="text-base font-danabold flex items-center gap-x-2">
                <svg class="h-5" width="17" height="17">
                  <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
                </svg>
                <span>Escort: ${firsname} ${lastname}</span>
              </h2>
              <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
                ${renderMultiRowTable([
                { label: 'Per Person', value: perperson },
                { label: 'Total', value: total },
                { label: 'Unit', value: unit }
              ])}
              </div>
            </section>
          `);
            });
          }

          return parts.join('');
        }


        case '12': { return ""; }
        // case '13': { // visa
        //   const parts = [];

        //   if (priceDetails.adult?.length) {
        //     priceDetails.adult.forEach((item, index) => {
        //       // دقت کن که item.adult وجود داره و مقادیرش
        //       const { special_class, count, perperson, total, unit } = item.adult;
        //       parts.push(`
        //     <section class="dir-ltr mt-4">
        //       <h2 class="text-base font-danabold flex items-center gap-x-2">
        //         <svg class="h-5" width="17" height="17">
        //           <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
        //         </svg>
        //         <span>Adult Ticket Info ${index + 1}</span>
        //       </h2>
        //       <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
        //         <table class="w-full text-left border-separate border-spacing-y-2 border-none">
        //           <thead>
        //             <tr>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Class</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Count</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Per Person</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Total</th>
        //               <th class="text-[#6D6D6D] text-xs font-danaregular">Unit</th>
        //             </tr>
        //           </thead>
        //           <tbody>
        //             <tr>
        //               <td class="text-[#292929] text-xs font-danamedium">${special_class}</td>
        //               <td class="text-[#292929] text-xs font-danamedium">${formatPrice(count)}</td>
        //               <td class="text-[#292929] text-xs font-danamedium">${formatPrice(perperson)}</td>
        //               <td class="text-[#292929] text-xs font-danamedium">${formatPrice(total)}</td>
        //               <td class="text-[#292929] text-xs font-dana_FANum_medium">${unit}</td>
        //             </tr>
        //           </tbody>
        //         </table>
        //       </div>
        //     </section>
        //   `);
        //     });
        //   }

        //   return parts.join('');
        // }



        // default: {
        //   // رندر عمومی و ساده برای بقیه حالات
        //   if (!priceDetails) return "";

        //   let rows = "";
        //   for (const key in priceDetails) {
        //     const label = key.charAt(0).toUpperCase() + key.slice(1);
        //     rows += renderRow(label, priceDetails[key]);
        //   }
        //   return startSection("Price Details") + rows + endSection();
        // }


        default: { // train-1
          const parts = [];

          if (priceDetails.adult?.length) {
            priceDetails.adult.forEach((item, index) => {
              // دقت کن که item.adult وجود داره و مقادیرش
              const { special_class, count, perperson, total, unit } = item.adult;
              parts.push(`
            <section class="dir-ltr mt-4">
              <h2 class="text-base font-danabold flex items-center gap-x-2">
                <svg class="h-5" width="17" height="17">
                  <use href="./images/pdf-sprite-icons.svg#coins-icon-pdf"></use>
                </svg>
                <span>Adult Ticket Info ${index + 1}</span>
              </h2>
              <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative py-2 px-6 overflow-hidden">
                <table class="w-full text-left border-separate border-spacing-y-2 border-none">
                  <thead>
                    <tr>
                      <th class="text-[#6D6D6D] text-xs font-danaregular">Class</th>
                      <th class="text-[#6D6D6D] text-xs font-danaregular">Count</th>
                      <th class="text-[#6D6D6D] text-xs font-danaregular">Per Person</th>
                      <th class="text-[#6D6D6D] text-xs font-danaregular">Total</th>
                      <th class="text-[#6D6D6D] text-xs font-danaregular">Unit</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="text-[#292929] text-xs font-danamedium">${special_class}</td>
                      <td class="text-[#292929] text-xs font-danamedium">${formatPrice(count)}</td>
                      <td class="text-[#292929] text-xs font-danamedium">${formatPrice(perperson)}</td>
                      <td class="text-[#292929] text-xs font-danamedium">${formatPrice(total)}</td>
                      <td class="text-[#292929] text-xs font-dana_FANum_medium">${unit}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>
          `);
            });
          }

          return parts.join('');
        }
      }
    }

    function renderInvoiceDetails($data) {
      const invoiceDetails = $data.invoiceDetails || {};
      const invoiceDate = $data.invoiceDate || {};
      const account =
        $data.account?.mycounter_forPassenger ||
        $data.account?.person ||
        $data.account?.supplier_agency ||
        $data.account?.mycounter_forAgency ||
        $data.account?.partner_agency ||
        {};

      const isPartnerAgency = !!$data.account?.partner_agency;

      // اگر partner_agency بود، از فیلدهای خاص آن استفاده کن
      const contractNumber = invoiceDetails.factorid || "-";
      const registerDate = invoiceDate.mstring || "-";
      const registerTime = invoiceDate.time || "-";

      const counterName = isPartnerAgency
        ? `${account.namecounter || ""} ${account.familycounter || ""}`.trim() || "-"
        : invoiceDetails.counterName || account.counterName || "-";

      const buyerName = isPartnerAgency
        ? account.agencyname || "-"
        : `${account.fullname?.firstname || ""} ${account.fullname?.lastname || ""}`.trim();

      const ownername = $data.invoiceDetails.ownerid;
      const persons = $data.invoiceDetails.persons;
      const address = isPartnerAgency ? account.agencyaddress || "-" : account.address || "-";
      const phone = isPartnerAgency ? account.agencytell || "-" : account.tel || "-";
      const email = isPartnerAgency ? account.agencyemail || "-" : account.email || "-";
      const mobile = isPartnerAgency ? account.agencymobile || "-" : account.mobile || "-";

      const serviceType = invoiceDetails.title || "-";
      const agreementText = invoiceDetails.description || "-";
      const userDescription = invoiceDetails.userDescription || "-";

      return `
        <h1 class="my-4 font-dana_FANum_demibold text-center">قرارداد ارائه خدمات مسافرتی و گردشگری</h1>
        <div class="w-full flex justify-between flex-wrap gap-y-2">
            <div class="w-[25.5%] bg-[#F4F4F4] border-2 border-[#E8E8E8] rounded-xl p-4 text-justify">
                <ul class="text-[#414141] font-dana_FANum_regular flex flex-col justify-between gap-y-3">
                    <li>
                        <span class="text-base print:text-xs font-dana_FANum_medium">شماره قرارداد</span>
                        <span class="text-lg print:text-base font-dana_FANum_demibold tracking-tighter">${contractNumber}</span>
                    </li>
                    <li class="text-sm"><span>تاریخ ثبت :</span><span class="inline-block dir-ltr" >${registerDate}</span></li>
                    <li class="text-sm"><span>ساعت ثبت :</span><span>${registerTime}</span></li>
                    <li class="text-sm"><span>نام کانتر :</span><span>${counterName}</span></li>
                </ul>
            </div>

            <div class="w-[36.5%] bg-[#F4F4F4] border-2 border-[#E8E8E8] rounded-xl p-4 text-justify">
                <ul class="text-[#414141] font-dana_FANum_regular flex flex-col gap-y-[6px]">
                    <li class="text-sm"><span>نام خریدار :</span><span>${buyerName}</span></li>
                    <li class="text-sm"><span>آدرس :</span><span>${address}</span></li>
                    <li class="text-sm"><span>تلفن :</span><span class="inline-block dir-ltr">${phone}</span></li>
                    <li class="text-sm"><span>ایمیل :</span><span>${email}</span></li>
                    <li class="text-sm"><span>موبایل :</span><span class="inline-block dir-ltr">${mobile}</span></li>
                </ul>
            </div>

            <div class="w-[36.5%] bg-[#F4F4F4] border-2 border-[#E8E8E8] rounded-xl p-4 text-justify">
                <ul class="text-[#414141] font-dana_FANum_regular flex flex-col gap-y-[6px]">
                    <li class="text-sm"><span>نوع خدمات :</span><span>${serviceType}</span></li>
                    <li class="text-sm"><span></span></li>
                    <li class="text-sm"><span>${userDescription}</span></li>
                </ul>
            </div>

            <div class="w-full bg-[#F4F4F4] border-2 border-[#E8E8E8] rounded-sm font-danaregular p-4 text-justify">

              <div>
                
                این قرارداد فی‌مابین خانم/آقای 

${buyerName}
 دارای شماره تلفن ثابت 

 (<span class="inline-block dir-ltr">${phone}</span>)
  و همراه 

  (<span class="inline-block dir-ltr">${mobile}</span>)
   به نشانی

(${address})

منعقد یا به نمایندگی تام‌الاختیار از سوی افراد
ذیل جمعاً به تعداد

${persons}

 نفر که از این پس "گردشگر" نامیده می‌شوند از یک طرف و دفتر

${ownername}

  که از این پس "کارگزار" نامیده
می‌شود، به صورت خرید اینترنتی منعقد گردیده است.

</div>
            </div>
        </div>
    `;
    }


//     <div>
//   This contract is concluded between Mr./Ms. 
//   ${buyerName}, with landline number 
//   (<span class="inline-block dir-ltr">${phone}</span>)
//   and mobile number 
//   (<span class="inline-block dir-ltr">${mobile}</span>),
//   residing at 
//   (${address}),
//   either personally or as the authorized representative of the individuals listed below, totaling 
//   ${persons} 
//   persons (hereinafter referred to as "Tourist"), on the one hand, and the office of 
//   ${ownername}, 
//   (hereinafter referred to as "Operator"), on the other hand, through an online purchase.
// </div>


    function renderFlightInfoSection(route) {
      const {
        route: routeName,
        routeDate,
        etime,
        atime,
        airline,
        startairport,
        endairport,
        routecode,
      } = route;

      const flightclass = route.class;

      const fromAirport = `${startairport.airport} / ${startairport.startotherinfo.city}`;
      const fromCode = startairport.startotherinfo.shortname;

      const toAirport = `${endairport.airport} / ${endairport.endotherinfo.city}`;
      const toCode = endairport.endotherinfo.shortname;

      return `

    <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative pb-[25px] overflow-hidden">
      <div class="flex justify-between p-[6px]">
        <div class="w-1/2 flex gap-x-2 items-center">
          <div class="bg-[#EAEAEA] rounded-md w-9 h-9 flex justify-center items-center">
            <svg class="scale-150 origin-center" width="24" height="23">
              <use href="./images/pdf-sprite-icons.svg#takeoff-airplane-icon-pdf"></use>
            </svg>
          </div>
          <div>
            <span class="block text-[#6D6D6D] text-xs font-interregular">From:</span>
            <span class="text-black text-xs font-danamedium">${fromAirport} <span class="text-[#292929]">(${fromCode})</span></span>
          </div>
        </div>
        <div class="w-1/2 flex gap-x-2 items-center">
          <div class="bg-[#EAEAEA] rounded-md w-9 h-9 flex justify-center items-center">
            <svg class="scale-150 origin-center" width="24" height="23">
              <use href="./images/pdf-sprite-icons.svg#landing-airplane-icon-pdf"></use>
            </svg>
          </div>
          <div>
            <span class="block text-[#6D6D6D] text-xs font-interregular">To:</span>
            <span class="text-black text-xs font-danamedium">${toAirport} <span class="text-[#292929]">(${toCode})</span></span>
          </div>
        </div>
      </div>
      <div class="h-[25px] w-full bg-[#EAEAEA] absolute bottom-0 left-0 right-0 rounded-[4px]">
        <ul class="flex justify-between px-2">
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Date:</span>
            <span class="text-[#292929] text-sm font-danamedium">${routeDate.mstring}</span>
          </li>
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Exit Time:</span>
            <span class="text-[#292929] text-sm font-danamedium">${etime}</span>
          </li>
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Flight NO:</span>
            <span class="text-[#292929] text-sm font-danamedium">${routecode}</span>
          </li>
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Arrival Time:</span>
            <span class="text-[#292929] text-sm font-danamedium">${atime}</span>
          </li>
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Airline:</span>
            <span class="text-[#292929] text-sm font-danamedium">${airline}</span>
          </li>
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Flight Class:</span>
            <span class="text-[#292929] text-sm font-danamedium">${flightclass}</span>
          </li>
        </ul>
      </div>
    </div>
  `;
    }

    function renderCipInfoSection(cip) {
      return `


      <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative overflow-hidden">
        <div class="flex justify-between items-center py-[6px] px-2">
          <div class="w-1/2 flex gap-x-2 items-center">
            <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Lounge:</span>
            <span class="text-[#292929] text-sm text-nowrap font-danamedium">${cip.loungename || '-'}</span>
          </div>
          <div class="w-1/2 flex gap-x-2 items-center">
            <ul class="flex justify-between px-2 gap-x-5">
              <li>
                <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Airport:</span>
                <span class="text-[#292929] text-sm text-nowrap font-danamedium">${cip.airportname || '-'}</span>
              </li>
              <li>
                <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Airline:</span>
                <span class="text-[#292929] text-sm text-nowrap font-danamedium">${cip.airline || '-'}</span>
              </li>
              <li>
                <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Flight No:</span>
                <span class="text-[#292929] text-sm text-nowrap font-danamedium">${cip.routecode || '-'}</span>
              </li>
            </ul>
          </div>
        </div>

        <hr class="w-[98%] mx-auto" />

        <div class="flex justify-between items-center py-[6px] px-2">
          <div class="w-full flex gap-x-2 items-center">
            <ul class="flex justify-between gap-x-2 w-full flex-wrap">
              <li class="flex items-center gap-x-2">
                <svg class="scale-150" width="12" height="11">
                  <use href="./images/pdf-sprite-icons.svg#pin-icon-pdf"></use>
                </svg>
                <span class="text-[#6D6D6D] text-xs font-danaregular">City:</span>
                <span class="text-[#292929] text-sm font-danamedium">${cip.route || '-'}</span>
              </li>
              <li class="flex items-center gap-x-2">
                <svg class="scale-150" width="12" height="11">
                  <use href="./images/pdf-sprite-icons.svg#check-in-icon-pdf"></use>
                </svg>
                <span class="text-[#6D6D6D] text-xs font-danaregular">Date:</span>
                <span class="text-[#292929] text-sm font-danamedium">${cip.routeDate?.mstring || '-'}</span>
              </li>
              <li class="flex items-center gap-x-2">
                <svg class="scale-150" width="12" height="11">
                  <use href="./images/pdf-sprite-icons.svg#clock-icon-pdf"></use>
                </svg>
                <span class="text-[#6D6D6D] text-xs font-danaregular">Time:</span>
                <span class="text-[#292929] text-sm font-danamedium">${cip.time || '-'}</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
  `;
    }

    function renderHotelInfoSection(room) {
      if (!room) return '';

      const {
        hotelName = '',
        hotelStar = '',
        cityName = '',
        roomNumber = '',
        roomType = '',
        fromDate = {},
        toDate = {},
        passengersRoom = {},
        service = '',
      } = room;

      // تبدیل تعداد مسافر به رشته‌ای مثل "1 Adult 1 children"
      const passengersTextParts = [];
      if (passengersRoom.adult) passengersTextParts.push(`${passengersRoom.adult} Adult${passengersRoom.adult > 1 ? 's' : ''}`);
      if (passengersRoom.child) passengersTextParts.push(`${passengersRoom.child} Children`);
      else {
        // اگر کلید child اصلی نباشه، بررسی کلیدهای دیگر (child Withbed, child Withoutbed)
        if (passengersRoom['child Withbed']) passengersTextParts.push(`${passengersRoom['child Withbed']} Children With Bed`);
        if (passengersRoom['child Withoutbed']) passengersTextParts.push(`${passengersRoom['child Withoutbed']} Children Without Bed`);
      }
      if (passengersRoom.infant) passengersTextParts.push(`${passengersRoom.infant} Infant${passengersRoom.infant > 1 ? 's' : ''}`);
      if (passengersRoom['extra Adult']) passengersTextParts.push(`${passengersRoom['extra Adult']} Extra Adult${passengersRoom['extra Adult'] > 1 ? 's' : ''}`);

      const passengersText = passengersTextParts.join(' ') || '-';

      // تبدیل تاریخ از mstring به فرمت yyyy/mm/dd
      function formatDate(dateObj) {
        if (!dateObj?.mstring) return '-';
        return dateObj.mstring.replace(/-/g, '/');
      }

      const checkInDate = formatDate(fromDate);
      const checkOutDate = formatDate(toDate);

      return `

  <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative overflow-hidden">
    <div class="flex justify-between items-center py-[6px] px-2 ">
      <div class="w-1/2 flex gap-x-2 items-center">
        <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Hotel:</span>
        <span class="text-[#292929] text-sm text-nowrap font-danamedium">${hotelName}</span>
      </div>
      <div class="w-1/2 flex gap-x-2 items-center">
        <ul class="flex justify-between px-2 gap-x-5">
          <li><span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Grade:</span><span class="text-[#292929] text-sm text-nowrap font-danamedium">${hotelStar} star</span></li>
          <li><span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Services:</span><span class="text-[#292929] text-sm text-nowrap font-danamedium">${service}</span></li>
          <li><span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Room Type:</span><span class="text-[#292929] text-sm text-nowrap font-danamedium">${roomType}</span></li>
        </ul>
      </div>
    </div>
    <hr class="w-[98%] mx-auto" />
    <div class="flex justify-between items-center py-[6px] px-2 ">
      <div class="w-full flex gap-x-2 items-center">
        <ul class="flex justify-between gap-x-2 w-full flex-wrap">
          <li class="flex items-center gap-x-2">
            <svg class=" scale-150" width="12" height="11">
              <use href="./images/pdf-sprite-icons.svg#pin-icon-pdf"></use>
            </svg>
            <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">city :</span>
            <span class="text-[#292929] text-sm text-nowrap font-danamedium">${cityName}</span>
          </li>
          <li class="flex items-center gap-x-2">
            <svg class=" scale-150" width="12" height="11">
              <use href="./images/pdf-sprite-icons.svg#small-bed-icon-pdf"></use>
            </svg>
            <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Room :</span>
            <span class="text-[#292929] text-sm text-nowrap font-danamedium">${roomNumber}</span>
          </li>
          <li class="flex items-center gap-x-2">
            <svg class=" scale-150" width="12" height="11">
              <use href="./images/pdf-sprite-icons.svg#user-icon-pdf"></use>
            </svg>
            <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Passengers :</span>
            <span class="text-[#292929] text-sm text-nowrap font-danamedium">${passengersText}</span>
          </li>
          <li class="flex items-center gap-x-2">
            <svg class=" scale-150" width="12" height="11">
              <use href="./images/pdf-sprite-icons.svg#check-in-icon-pdf"></use>
            </svg>
            <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Check in :</span>
            <span class="text-[#292929] text-sm text-nowrap font-danamedium">${checkInDate}</span>
          </li>
          <li class="flex items-center gap-x-2">
            <span class="-scale-x-100">
              <svg class="scale-150 " width="12" height="11">
                <use href="./images/pdf-sprite-icons.svg#check-in-icon-pdf"></use>
              </svg>
            </span>
            <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Check out :</span>
            <span class="text-[#292929] text-sm text-nowrap font-danamedium">${checkOutDate}</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div></div>
  `;
    }

    function renderTourHotelInfoSection(data) {
      if (!Array.isArray(data) || data.length === 0) return '';

      // تابع کمکی برای تبدیل تعداد مسافرها به رشته مطابق مثال شما
      function getPassengersText(passengersRoom = {}) {
        const parts = [];
        if (passengersRoom.adult) parts.push(`${passengersRoom.adult} Adult${passengersRoom.adult > 1 ? 's' : ''}`);
        if (passengersRoom.child) parts.push(`${passengersRoom.child} Children`);
        else {
          if (passengersRoom['child Withbed']) parts.push(`${passengersRoom['child Withbed']} Children With Bed`);
          if (passengersRoom['child Withoutbed']) parts.push(`${passengersRoom['child Withoutbed']} Children Without Bed`);
        }
        if (passengersRoom.infant) parts.push(`${passengersRoom.infant} Infant${passengersRoom.infant > 1 ? 's' : ''}`);
        if (passengersRoom['extra Adult']) parts.push(`${passengersRoom['extra Adult']} Extra Adult${passengersRoom['extra Adult'] > 1 ? 's' : ''}`);
        return parts.join(' ') || '-';
      }

      // تابع کمکی فرمت تاریخ yyyy/mm/dd
      function formatDate(dateObj) {
        if (!dateObj?.mstring) return '-';
        return dateObj.mstring.replace(/-/g, '/');
      }

      let html = `<section class="dir-ltr mt-4">
    <h2 class="text-base font-danabold flex items-center gap-x-2 ">
      <svg class="h-5" width="17" height="17">
        <use href="./images/pdf-sprite-icons.svg#bulleted-list-icon-pdf"></use>
      </svg>
      <span>List of Rooms</span>
    </h2>`;

      data.forEach((hotelGroup) => {
        const rooms = hotelGroup.hotel || [];
        if (rooms.length === 0) return;

        const { hotelName = '-', cityName = '-', hotelStar = '-', service = '-' } = rooms[0].room || {};

        // برای هر اتاق یک کارت طبق طراحی
        rooms.forEach(({ room }) => {
          const {
            roomNumber = '-',
            roomType = '-',
            fromDate = {},
            toDate = {},
            passengersRoom = {},
            service: roomService = service // اگر سرویس اتاق نبود، از هتل استفاده شود
          } = room || {};

          html += `
      <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative overflow-hidden">
        <div class="flex justify-between items-center py-[6px] px-2 ">
          <div class="w-1/2 flex gap-x-2 items-center">
            <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Hotel:</span>
            <span class="text-[#292929] text-sm text-nowrap font-danamedium">${hotelName}</span>
          </div>
          <div class="w-1/2 flex gap-x-2 items-center">
            <ul class="flex justify-between px-2 gap-x-5">
              <li>
                <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Grade:</span>
                <span class="text-[#292929] text-sm text-nowrap font-danamedium">${hotelStar} star</span>
              </li>
              <li>
                <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Services:</span>
                <span class="text-[#292929] text-sm text-nowrap font-danamedium">${roomService}</span>
              </li>
              <li>
                <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Room Type:</span>
                <span class="text-[#292929] text-sm text-nowrap font-danamedium">${roomType}</span>
              </li>
            </ul>
          </div>
        </div>
        <hr class="w-[98%] mx-auto" />
        <div class="flex justify-between items-center py-[6px] px-2 ">
          <div class="w-full flex gap-x-2 items-center">
            <ul class="flex justify-between gap-x-2 w-full flex-wrap">
              <li class="flex items-center gap-x-2">
                <svg class="scale-150" width="12" height="11">
                  <use href="./images/pdf-sprite-icons.svg#pin-icon-pdf"></use>
                </svg>
                <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">city :</span>
                <span class="text-[#292929] text-sm text-nowrap font-danamedium">${cityName}</span>
              </li>
              <li class="flex items-center gap-x-2">
                <svg class="scale-150" width="12" height="11">
                  <use href="./images/pdf-sprite-icons.svg#small-bed-icon-pdf"></use>
                </svg>
                <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Room :</span>
                <span class="text-[#292929] text-sm text-nowrap font-danamedium">${roomNumber}</span>
              </li>
              <li class="flex items-center gap-x-2">
                <svg class="scale-150" width="12" height="11">
                  <use href="./images/pdf-sprite-icons.svg#user-icon-pdf"></use>
                </svg>
                <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Passengers :</span>
                <span class="text-[#292929] text-sm text-nowrap font-danamedium">${getPassengersText(passengersRoom)}</span>
              </li>
              <li class="flex items-center gap-x-2">
                <svg class="scale-150" width="12" height="11">
                  <use href="./images/pdf-sprite-icons.svg#check-in-icon-pdf"></use>
                </svg>
                <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Check in :</span>
                <span class="text-[#292929] text-sm text-nowrap font-danamedium">${formatDate(fromDate)}</span>
              </li>
              <li class="flex items-center gap-x-2">
                <span class="-scale-x-100">
                  <svg class="scale-150" width="12" height="11">
                    <use href="./images/pdf-sprite-icons.svg#check-in-icon-pdf"></use>
                  </svg>
                </span>
                <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Check out :</span>
                <span class="text-[#292929] text-sm text-nowrap font-danamedium">${formatDate(toDate)}</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
      `;
        });
      });

      html += `</section>`;
      return html;
    }


    function renderInsuranceInfoSection(insurance) {
      if (!insurance || !Array.isArray(insurance) || insurance.length === 0) {
        console.warn("هیچ اطلاعاتی برای بیمه موجود نیست.");
        return '';
      }

      const isType4 = Number(globalInvoiceType) === 4;

      console.log('globalInvoiceType =', globalInvoiceType);
      console.log('insurance =', insurance);

      const country = isType4 ? insurance[0].insuranceCountry : insurance.country;
      const name = isType4 ? insurance[0].insuranceName : insurance.name;
      const provider = isType4 ? insurance[0].insuranceProvider : insurance.Provider;

      const duration = !isType4 && insurance.duration
        ? `
      <li class="flex items-center gap-x-2">
        <svg class="scale-150" width="12" height="11">
          <use href="./images/pdf-sprite-icons.svg#calendar-icon-pdf"></use>
        </svg>
        <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Duration:</span>
        <span class="text-[#292929] text-sm text-nowrap font-danamedium">${insurance.duration.duration} ${insurance.duration.durationtype}</span>
      </li>`
        : '';

      return `
    <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative overflow-hidden">
      <div class="flex justify-between items-center py-[6px] px-2">
        <div class="w-full flex gap-x-2 items-center">
          <ul class="flex justify-between gap-x-2 w-full flex-wrap">

            <li class="flex items-center gap-x-2">
              <svg class="scale-150" width="12" height="11">
                <use href="./images/pdf-sprite-icons.svg#pin-icon-pdf"></use>
              </svg>
              <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Country:</span>
              <span class="text-[#292929] text-sm text-nowrap font-danamedium">${country}</span>
            </li>

            <li class="flex items-center gap-x-2">
              <svg class="scale-150" width="12" height="11">
                <use href="./images/pdf-sprite-icons.svg#user-icon-pdf"></use>
              </svg>
              <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Name:</span>
              <span class="text-[#292929] text-sm text-nowrap font-danamedium">${name}</span>
            </li>

            ${duration}

            <li class="flex items-center gap-x-2">
              <svg class="scale-150" width="12" height="11">
                <use href="./images/pdf-sprite-icons.svg#check-in-icon-pdf"></use>
              </svg>
              <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Provider:</span>
              <span class="text-[#292929] text-sm text-nowrap font-danamedium">${provider}</span>
            </li>

          </ul>
        </div>
      </div>
    </div>
  `;
    }

    function renderServiceInfoSection(service) {
      return `
    <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative overflow-hidden">
      <div class="flex justify-between items-center py-[6px] px-2">
        <div class="w-full flex gap-x-2 items-center">
          <ul class="flex justify-between gap-x-2 w-full flex-wrap">
            <li class="flex items-center gap-x-2">
              <svg class="scale-150" width="12" height="11">
                <use href="./images/pdf-sprite-icons.svg#bulleted-list-icon-pdf"></use>
              </svg>
              <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Service:</span>
              <span class="text-[#292929] text-sm text-nowrap font-danamedium">${service.servicename}</span>
            </li>
            <li class="flex items-center gap-x-2">
              <svg class="scale-150" width="12" height="11">
                <use href="./images/pdf-sprite-icons.svg#location-icon-pdf"></use>
              </svg>
              <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">City:</span>
              <span class="text-[#292929] text-sm text-nowrap font-danamedium">${service.servicecityname}</span>
            </li>
            <li class="flex items-center gap-x-2">
              <svg class="scale-150" width="12" height="11">
                <use href="./images/pdf-sprite-icons.svg#calendar-icon-pdf"></use>
              </svg>
              <span class="text-[#6D6D6D] text-xs text-nowrap font-danaregular">Date:</span>
              <span class="text-[#292929] text-sm text-nowrap font-danamedium">${service.servicedate.sstring}</span>
            </li>

          </ul>
        </div>
      </div>
    </div>
  `;
    }

    function renderVisaInfoSection(visa) {
      return `
    <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative overflow-hidden">
      <div class="flex justify-between items-center py-[6px] px-2">
        <div class="w-full flex gap-x-2 items-start flex-col">
          <ul class="flex flex-wrap gap-x-4 gap-y-1 text-sm">
            <li class="flex items-center gap-x-2">
              <svg class="scale-150" width="12" height="11">
                <use href="./images/pdf-sprite-icons.svg#bulleted-list-icon-pdf"></use>
              </svg>
              <span class="text-[#6D6D6D] font-danaregular">Visa Name:</span>
              <span class="text-[#292929] font-danamedium">${visa.visaname}</span>
            </li>
            <li class="flex items-center gap-x-2">
              <svg class="scale-150" width="12" height="11">
                <use href="./images/pdf-sprite-icons.svg#location-icon-pdf"></use>
              </svg>
              <span class="text-[#6D6D6D] font-danaregular">Country:</span>
              <span class="text-[#292929] font-danamedium">${visa.visacountry}</span>
            </li>
            <li class="flex items-center gap-x-2">
              <svg class="scale-150" width="12" height="11">
                <use href="./images/pdf-sprite-icons.svg#calendar-icon-pdf"></use>
              </svg>
              <span class="text-[#6D6D6D] font-danaregular">Date:</span>
              <span class="text-[#292929] font-danamedium">${visa.visadate?.sstring || '-'}</span>
            </li>
            <li><span class="text-[#6D6D6D] font-danaregular">Application:</span> ${visa.application}</li>
            <li><span class="text-[#6D6D6D] font-danaregular">Type:</span> ${visa.visatype}</li>
            <li><span class="text-[#6D6D6D] font-danaregular">Visit:</span> ${visa.visit_log}</li>
            <li><span class="text-[#6D6D6D] font-danaregular">Validity:</span> ${safeValue(visa.validity_duration?.time)} ${safeValue(visa.validity_duration?.months)}</li>
            <li><span class="text-[#6D6D6D] font-danaregular">Documents:</span>
                <div class="divide-x inline-block">
${visa.documents?.map((doc, index, arr) =>
        `<span class="inline-block  mx-1">${doc.name1}${index < arr.length - 1 ? ',' : ''}</span>`
      ).join('') || ''}
                </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    `;
    }

    function renderTrainInfoSection(route) {
      const {
        route: routeName,
        routeDate,
        etime,
        atime,
        trainid,
        trainimage,
        startairport,
        endairport,
        routecode,
      } = route;

      const trainclass = route.class;

      const fromAirport = `${startairport.airport} / ${startairport.startotherinfo.city}`;
      const fromCode = startairport.startotherinfo.shortname;

      const toAirport = `${endairport.airport} / ${endairport.endotherinfo.city}`;
      const toCode = endairport.endotherinfo.shortname;

      return `

    <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative pb-[25px] overflow-hidden">
      <div class="flex justify-between p-[6px]">
        <div class="w-1/2 flex gap-x-2 items-center">
          <div class="bg-[#EAEAEA] rounded-md w-9 h-9 flex justify-center items-center">
                <img src="${trainimage}" width="36" height="36" alt="${trainid}" />

          </div>
          <div>
            <span class="block text-[#6D6D6D] text-xs font-interregular">From:</span>
            <span class="text-black text-xs font-danamedium">${fromAirport} <span class="text-[#292929]">(${fromCode})</span></span>
          </div>
        </div>
        <div class="w-1/2 flex gap-x-2 items-center">
          <div>
            <span class="block text-[#6D6D6D] text-xs font-interregular">To:</span>
            <span class="text-black text-xs font-danamedium">${toAirport} <span class="text-[#292929]">(${toCode})</span></span>
          </div>
        </div>
      </div>
      <div class="h-[25px] w-full bg-[#EAEAEA] absolute bottom-0 left-0 right-0 rounded-[4px]">
        <ul class="flex justify-between px-2">
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Date:</span>
            <span class="text-[#292929] text-sm font-danamedium">${routeDate.mstring}</span>
          </li>
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Exit Time:</span>
            <span class="text-[#292929] text-sm font-danamedium">${etime}</span>
          </li>
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Route Code :</span>
            <span class="text-[#292929] text-sm font-danamedium">${routecode}</span>
          </li>
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Arrival Time:</span>
            <span class="text-[#292929] text-sm font-danamedium">${atime}</span>
          </li>
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Train Name:</span>
            <span class="text-[#292929] text-sm font-danamedium">${trainid}</span>
          </li>
          <li>
            <span class="text-[#6D6D6D] text-xs font-danaregular">Class:</span>
            <span class="text-[#292929] text-sm font-danamedium">${trainclass}</span>
          </li>
        </ul>
      </div>
    </div>
  `;
    }

    function renderProducts(products) {
      return products.map(product => {


        console.log(product)



        if (globalInvoiceType != 8 && globalInvoiceType != 9) {
          console.log(globalInvoiceType, "testttttttttttttttttttttttttttttttttttttttttt flight")
          if (product.departure) {
            return product.departure.map(item => renderFlightInfoSection(item.route)).join('');
          }

          if (product.return) {
            return product.return.map(item => renderFlightInfoSection(item.route)).join('');
          }
        }

        if (globalInvoiceType == 8 || globalInvoiceType == 9) {

          if (product.departure) {
            return product.departure.map(item => renderTrainInfoSection(item.route)).join('');
          }

          if (product.return) {
            return product.return.map(item => renderTrainInfoSection(item.route)).join('');
          }
        }




        if (product.hotels) {
          return renderTourHotelInfoSection(product.hotels.hotel.room);
        }

        if (product.hotel) {
          return renderHotelInfoSection(product.hotel.room);
        }

        if (product.insurance) {
          return renderInsuranceInfoSection(product.insurance);
        }

        if (product.departure?.[0]?.cip) {
          return renderCipInfoSection(product.departure[0].cip);
        }

        if (product.return?.[0]?.cip) {
          return renderCipInfoSection(product.return[0].cip);
        }

        if (product.service?.service) {
          return renderServiceInfoSection(product.service?.service);
        }
        if (product.visa?.visa) {
          return renderVisaInfoSection(product.visa?.visa);
        }



        return ''; // fallback
      }).join('');
    }

    function renderAllProducts(products) {
      if (!Array.isArray(products) || products.length === 0) return '<p>هیچ محصولی یافت نشد.</p>';

      const flights = [];
      const returns = [];
      const hotels = [];
      const tourhotels = [];
      const insurances = [];
      const cips = [];
      const services = [];
      const visa = [];
      const traindeparture = [];
      const trainreturn = [];


      for (const product of products) {


        if (globalInvoiceType == 8 || globalInvoiceType == 9) {
          if (product?.departure?.length) {
            for (const item of product.departure) {
              if (item?.route) traindeparture.push(item.route);
            }
          }
          if (product?.return?.length) {
            for (const item of product.return) {
              if (item?.route) trainreturn.push(item.route);
            }
          }

        }


        if (globalInvoiceType != 8 && globalInvoiceType != 9) {
          if (product?.departure?.length) {
            for (const item of product.departure) {
              if (item?.route) flights.push(item.route);
              if (item?.cip) cips.push(item.cip);
            }
          }
          if (product?.return?.length) {
            for (const item of product.return) {
              if (item?.route) returns.push(item.route);
            }
          }
        }


        if (product?.hotel?.room) hotels.push(product.hotel.room);
        if (product?.hotels) tourhotels.push(product.hotels);
        if (product?.insurance) insurances.push(product.insurance);

        if (product?.service?.length) {
          for (const item of product.service) {
            if (item?.service) services.push(item.service);
          }
        }
        if (product?.visa?.length) {
          for (const item of product.visa) {
            if (item?.visa) visa.push(item.visa);
          }
        }



      }


      let html = '';

      if (traindeparture.length) {
        html += `
    <section class="dir-ltr mt-4">
      <h2 class="text-base font-danabold flex items-center gap-x-2 ">
        <svg class="h-5" width="17" height="17">
          <use href="./images/pdf-sprite-icons.svg#airplane-icon-pdf"></use>
        </svg>
        <span>Departure Train</span>
      </h2>
      ${traindeparture.map(route => renderTrainInfoSection(route)).join('')}
    </section>`;
      }

      if (trainreturn.length) {
        html += `
    <section class="dir-ltr mt-4">
      <h2 class="text-base font-danabold flex items-center gap-x-2 ">
        <svg class="h-5" width="17" height="17">
          <use href="./images/pdf-sprite-icons.svg#airplane-icon-pdf"></use>
        </svg>
        <span>Return Train</span>
      </h2>
      ${trainreturn.map(route => renderTrainInfoSection(route)).join('')}
    </section>`;
      }


      if (flights.length) {
        html += `
    <section class="dir-ltr mt-4">
      <h2 class="text-base font-danabold flex items-center gap-x-2 ">
        <svg class="h-5" width="17" height="17">
          <use href="./images/pdf-sprite-icons.svg#airplane-icon-pdf"></use>
        </svg>
        <span>Departure Flights</span>
      </h2>
      ${flights.map(route => renderFlightInfoSection(route)).join('')}
    </section>`;
      }

      if (returns.length) {
        html += `
    <section class="dir-ltr mt-4">
      <h2 class="text-base font-danabold flex items-center gap-x-2 ">
        <svg class="h-5" width="17" height="17">
          <use href="./images/pdf-sprite-icons.svg#airplane-icon-pdf"></use>
        </svg>
        <span>Return Flights</span>
      </h2>
      ${returns.map(route => renderFlightInfoSection(route)).join('')}
    </section>`;
      }




      if (hotels.length) {
        console.log(hotels)
        html += `
    <section class="dir-ltr mt-4">
      <h2 class="text-base font-danabold flex items-center gap-x-2 ">
        <svg class="h-5" width="17" height="17">
          <use href="./images/pdf-sprite-icons.svg#bulleted-list-icon-pdf"></use>
        </svg>
        <span>List of Rooms</span>
      </h2>
      ${hotels.map(room => renderHotelInfoSection(room)).join('')}
    </section>`;
      }


      if (tourhotels.length) {
        html += `
      ${tourhotels.map(hotel => renderTourHotelInfoSection(hotel)).join('')}`;
      }

      const validInsurances = Array.isArray(insurances)
        ? insurances.filter(ins => ins && Object.keys(ins).length > 0)
        : [];

      if (validInsurances.length > 0) {
        html += `
    <section class="dir-ltr mt-4">
      <h2 class="text-base font-danabold flex items-center gap-x-2">
        <svg class="h-5" width="17" height="17">
          <use href="./images/pdf-sprite-icons.svg#shield-icon-pdf"></use>
        </svg>
        <span>Travel Insurance</span>
      </h2>
      ${validInsurances.map(ins => renderInsuranceInfoSection(ins)).join('')}
    </section>`;
      }


      if (cips.length) {
        html += `
    <section class="dir-ltr mt-4">
      <h2 class="text-base font-danabold flex items-center gap-x-2 ">
        <svg class="h-5" width="17" height="17">
          <use href="./images/pdf-sprite-icons.svg#vip-icon-pdf"></use>
        </svg>
        <span>CIP Services</span>
      </h2>
      ${cips.map(cip => renderCipInfoSection(cip)).join('')}
    </section>`;
      }


      if (services.length) {
        html += `
  <section class="dir-ltr mt-4">
    <h2 class="text-base font-danabold flex items-center gap-x-2">
      <svg class="h-5" width="17" height="17">
        <use href="./images/pdf-sprite-icons.svg#tour-icon-pdf"></use>
      </svg>
      <span>Service</span>
    </h2>
    ${services.map(service => renderServiceInfoSection(service)).join('')}
  </section>`;
      }

      if (visa.length) {
        html += `
    <section class="dir-ltr mt-4">
      <h2 class="text-base font-danabold flex items-center gap-x-2">
        <svg class="h-5" width="17" height="17">
          <use href="./images/pdf-sprite-icons.svg#passport-icon-pdf"></use>
        </svg>
        <span>Visa Services</span>
      </h2>
      ${visa.map(v => renderVisaInfoSection(v)).join('')}
    </section>`;
      }




      return html;
    }

    function renderPassengers(passengers, $data) {
      const invoiceType = $data?.invoiceDetails?.invoicetype;
      const grouped = {};

      // گروه بندی مسافران بر اساس شماره اتاق
      passengers.forEach((pax) => {
        const passengerinfo = pax.passengerinfo;
        const rawRoomNum = passengerinfo.roomnumber ?? passengerinfo.roomid ?? "";
        const roomNum = parseInt(rawRoomNum);
        const finalRoomNum = isNaN(roomNum) ? null : roomNum;

        if (finalRoomNum !== null) {
          if (!grouped[finalRoomNum]) grouped[finalRoomNum] = [];
          grouped[finalRoomNum].push(pax); // توجه: اینجا کل آبجکت pax رو میذاریم
        }
      });

      const genderMap = { "0": "Female", "1": "Male" };
      const typeMap = { "1": "Child", "2": "Adult", "3": "Infant" };

      let html = "";

      const hasRooms = Object.keys(grouped).length > 0;

      // تابع کمکی برای ساختن جدول اطلاعات جانبی (بیمه، ترنسفر و ...)
      function renderInfoBox(title, data) {
        if (!data || Object.keys(data).length === 0) return "";

        const blacklist = ["file_address"];
        const entries = Object.entries(data).filter(([key]) => !blacklist.includes(key));

        if (entries.length === 0) return ""; // اگر بعد از فیلتر چیزی باقی نموند، هیچی نشون نده

        return `
    <tr>
      <td colspan="10" class="pt-2">
        <div class="mt-2 rounded-[10px] bg-[#F0F0F0] overflow-hidden border border-[#DADADA]">
          <table class="w-full text-left border-separate border-spacing-y-2 border-none">
            <thead>
              <tr>
                <th colspan="${entries.length}" class="text-black text-xs font-danabold px-2 pt-2 pb-1">${title}</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                ${entries.map(([key]) => {
          const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          return `<td class="text-[#6D6D6D] text-xs font-danaregular px-2 py-1 whitespace-nowrap">${label}</td>`;
        }).join('')}
              </tr>
              <tr>
                ${entries.map(([_, value]) => {
          return `<td class="text-[#292929] text-xs font-danamedium px-2 py-1 whitespace-nowrap">${value || "-"}</td>`;
        }).join('')}
              </tr>
            </tbody>
          </table>
        </div>
      </td>
    </tr>
  `;
      }


      // اگر اتاقی وجود ندارد ولی مسافر هست (مسافران بدون اتاق)
      if (!hasRooms && passengers.length > 0) {
        html += `
      <section class="dir-ltr mt-4">
        <h2 class="text-base font-danabold flex items-center gap-x-2">
          <svg class="h-5" width="17" height="17">
            <use href="./images/pdf-sprite-icons.svg#person-info-icon-pdf"></use>
          </svg>
          <span>اطلاعات مسافر</span>
        </h2>
        <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative p-2 overflow-hidden">
          <table class="w-full text-left border-separate border-spacing-y-2 border-none">
            <thead>
              <tr>
                <th class="text-[#6D6D6D] text-xs font-danaregular">First Name</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Last Name</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Date of Birth</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">National Code</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Passport No</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Passport Expiry</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Issue Country</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Gender</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Age Type</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Cost</th>
              </tr>
            </thead>
            <tbody>
    `;

        passengers.forEach((pax) => {
          const info = pax.passengerinfo;
          const cost = pax.costinfo?.cost ?? 0;
          const transfer = pax.transfer;
          const insurance = info.insuranceinfo;

          html += `
        <tr>
          <td class="text-[#292929] text-xs font-danamedium">${info.fullname.firstname}</td>
          <td class="text-[#292929] text-xs font-danamedium">${info.fullname.lastname}</td>
          <td class="text-[#292929] text-xs font-danamedium">${info.birthdate?.S_birthdate ?? ""}</td>
          <td class="text-[#292929] text-xs font-danamedium">${info.nationalcode}</td>
          <td class="text-[#292929] text-xs font-danamedium">${info.passportcode}</td>
          <td class="text-[#292929] text-xs font-danamedium">${info.passportexpiration}</td>
          <td class="text-[#292929] text-xs font-danamedium">${info.countryofresidence?.ecountryname ?? info.countryofpassportissue?.ecountryname ?? ""}</td>
          <td class="text-[#292929] text-xs font-danamedium">${genderMap[info.gender]}</td>
          <td class="text-[#292929] text-xs font-danamedium">${typeMap[info.type]}</td>
          <td class="text-[#292929] text-xs font-danamedium">${Number(cost).toLocaleString("en-US")}</td>
        </tr>
      `;

          if (transfer && Object.keys(transfer).length > 0) {
            html += renderInfoBox("Transfer Information", transfer);
          }


          if (insurance) {

            console.log("Insurance Information1", insurance);
          }
          if (insurance && (typeof insurance === 'object')) {

            console.log("Insurance Information2", insurance);
          }
          if (Object.keys(insuranceinfo).length > 0) {

            console.log("Insurance Information3", insurance);
          }


          if (insurance && Object.keys(insurance).length > 0) {
            html += renderInfoBox("Insurance Information", insurance);
          }
        });

        html += `
            </tbody>
          </table>
        </div>
      </section>
    `;

        return html;
      }

      // اگر اتاق‌ها وجود دارند
      Object.entries(grouped).forEach(([roomNum, paxList]) => {
        html += `
      <section class="dir-ltr mt-4">
        <h2 class="text-base font-danabold flex items-center gap-x-2">
          <svg class="h-5" width="17" height="17">
            <use href="./images/pdf-sprite-icons.svg#large-bed-icon-pdf"></use>
          </svg>
          <span>Room ${parseInt(roomNum) + 1}</span>
        </h2>
        <div class="mb-4 rounded-[10px] bg-[#F8F8F8] relative p-2 overflow-hidden">
          <table class="w-full text-left border-separate border-spacing-y-2 border-none">
            <thead>
              <tr>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Name:</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Surname:</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Date of Birth</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">National Code:</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Passport No:</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Expiration Date of Passport:</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Gender:</th>
                <th class="text-[#6D6D6D] text-xs font-danaregular">Age Range:</th>
              </tr>
            </thead>
            <tbody>
    `;

        paxList.forEach((pax) => {
          const info = pax.passengerinfo;
          const transfer = pax.transfer;
          const insurance = info.insuranceinfo;

          html += `
        <tr>
          <td class="text-[#292929] text-xs font-danamedium">${info.fullname.firstname}</td>
          <td class="text-[#292929] text-xs font-danamedium">${info.fullname.lastname}</td>
          <td class="text-[#292929] text-xs font-danamedium">${info.birthdate?.S_birthdate ?? ""}</td>
          <td class="text-[#292929] text-xs font-danamedium">${info.nationalcode}</td>
          <td class="text-[#292929] text-xs font-danamedium">${info.passportcode}</td>
          <td class="text-[#292929] text-xs font-danamedium">${info.passportexpiration}</td>
          <td class="text-[#292929] text-xs font-danamedium">${genderMap[info.gender]}</td>
          <td class="text-[#292929] text-xs font-danamedium">${typeMap[info.type]}</td>
        </tr>
      `;

          if (transfer && Object.keys(transfer).length > 0) {
            html += renderInfoBox("Transfer Information", transfer);
          }
          if (insurance && Object.keys(insurance).length > 0) {
            html += renderInfoBox("Insurance Information", insurance);
          }
        });

        html += `
            </tbody>
          </table>
        </div>
      </section>
    `;
      });

      return html;
    }

    function detectDirection(text) {
      const rtlChars = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/;
      return rtlChars.test(text) ? 'rtl' : 'ltr';
    }

    function fixRTLTextFromJSON(text) {
      if (typeof text !== 'string') return text;

      const rtlCharRange = /[\u0600-\u06FF]/;
      const ltrSensitiveChars = [':', '-', '(', ')', '/', '.', ',', '|'];

      if (rtlCharRange.test(text)) {
        const RLE = '\u202B'; // Right-To-Left Embedding
        const PDF = '\u202C'; // Pop Directional Formatting

        // اعمال RLE و PDF فقط به کل متن RTL، اگر شامل کاراکتر حساس بود
        const hasLTRSensitive = ltrSensitiveChars.some(char => text.includes(char));
        if (hasLTRSensitive) {
          text = RLE + text + PDF;
        }
      }

      return text;
    }

    function fixRTLTextCompletely(text) {
      if (typeof text !== 'string') return text;

      // جدا کردن تگ‌ها از متن (هم باز و هم بسته)
      const parts = text.split(/(<[^>]+>)/g);

      const fixed = parts.map(part => {
        if (part.startsWith('<') && part.endsWith('>')) {
          // این یک تگ HTML هست → فقط کاراکترهای مخفی رو حذف کن
          return part.replace(/[\u200E\u200F\u202A-\u202E]/g, '');
        } else {
          // این متن واقعی هست → اصلاحات مربوط به جهت متن انجام بده
          return fixRTLTextFromJSON(part);
        }
      });

      return fixed.join('');
    }

    async function renderDescription($data) {
      const rules = $data?.pdf_description;
      if (!rules || !Array.isArray(rules)) {
        console.warn("هیچ آیتمی در pdf_description پیدا نشد");
        return null;
      }

      let direction = detectDirection(rules?.[0]?.note?.text);

      let ulitem = '';
      rules.forEach((item, index) => {
        const text = item?.note?.text?.trim();

        if (text) {
          const cleanedText = text.replace(/\n/g, '<br/>'); // ⬅️ این خط اضافه شده
          ulitem += `<li class="my-4">${cleanedText}</li>`;
        } else {
          console.warn(`آیتم ${index} متن معتبری ندارد`, item);
        }
      });

      if (ulitem) {
        return `
      <div class="w-full flex justify-between flex-wrap gap-y-2">
        <div class="w-full text-xs bg-[#F4F4F4] border-2 border-[#E8E8E8] rounded-sm font-danaregular p-4 text-justify">
          <ul dir="${direction}" class="text-justify">${fixRTLTextCompletely(ulitem)}</ul>
        </div>
      </div>
    `;
      } else {
        return '';
      }
    }



    function getOwner(ownerid) {

      $bc.setSource("db.ownerdb", {
        ownerid: ownerid,
        run: true,
      });

      return '';
    }



  </script>

</body>

</html>