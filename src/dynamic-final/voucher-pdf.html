<basis core="api" name="api.Webservice" url="https://www.basisfly.com/panel/main/view/[##cms.query.rkey##]"
    method="post" body='{
         "name": "db",
         "mid": "20",
         "member": [
             {
                 "type": "list",
                 "name": "q",
                 "request": "voucher_pdf",
                 "id": "[##cms.query.id##]",
                 "lid": "[##cms.query.lid|(1)##]",
                 "cityid": "[##cms.query.cityid|(0)##]",
                 "status": "[##cms.query.status|(0)##]"
             }
         ]
     }' content-type="application/json" run="atclient">
</basis>

<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/pdf-ui.min.css">
</head>

<body class="p-0 m-0">

    <header class="h-[100px] print:w-[595pt] print:h-[75pt] w-full bg-gray-200">

    </header>





    <main
        class="pdf-content py-6 w-full max-w-screen-xl mx-auto print:w-[595pt] print:min-h-[calc(842pt-150pt)] print:max-w-none print:overflow-hidden print:shadow-none">

        <div class="pdf-loading hidden fixed z-[99] w-full h-full pt-[20%] bg-[#8d8d8d8c]">
            <div class="flex justify-center items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-gray-900"></div>
            </div>
        </div>

        <div class="w-[95%] mx-auto">

            <!-- info -->
            <section class="w-full flex justify-between items-center ">
                <h2 class="font-semibold font-intersemibold text-base text-black">Voucher/Accommodation</h2>
                <ul class="flex gap-x-4">

                    <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                        <layout>
                            @child
                        </layout>
                        <face>
                            <script type="text/template">
                    <li>
                        <div>
                            <h2 class="text-sm font-normal text-[#202020] font-interregular">Reference number :</h2>
                            <p class="text-base text-[#292929] text-left font-danademibold">@refnumber@</p>
                        </div>
                    </li>
                        </script>
                        </face>
                    </basis>
                    <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                        <layout>
                            @child
                        </layout>
                        <face>
                            <script type="text/template">
                    <li>
                        <div>
                            <h2 class="text-sm font-normal text-[#202020] font-interregular">Date Of issue:</h2>
                            <p class="text-base text-[#292929] text-left font-danademibold">@createDate.mstring@</p>
                        </div>
                    </li>
                        </script>
                        </face>
                    </basis>
                    <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                        <layout>
                            @child
                        </layout>
                        <face>
                            <script type="text/template">
                    <li>
                        <div>
                            <h2 class="text-sm font-normal text-[#202020] font-interregular">CreateHour :</h2>
                            <p class="text-base text-[#292929] text-center font-danademibold">@createHour@</p>
                        </div>
                    </li>
                        </script>
                        </face>
                    </basis>
                </ul>

            </section>

            <section class="border-2 border-[#E3E3E3] rounded-xl  my-4 justify-between flex p-3">
                <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                    <layout>
                        @child
                    </layout>
                    <face>
                        <script type="text/template">
                                {{ return await RenderInfoCard($data)}}
                        </script>
                    </face>
                </basis>
            </section>

            <section>

                <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                    <layout>
                        @child
                    </layout>
                    <face>
                        <script type="text/template">
                                {{ return await renderRooms($data)}}
                        </script>
                    </face>
                </basis>
            </section>


            <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                <layout>
                    @child
                </layout>
                <face>
                    <script type="text/template">
                <section class="mt-3">
                <h2 class="font-bold text-2xl my-2 font-interbold ">Remarks</h2>
                <div class="bg-[#F8F8F8] rounded-xl py-4  px-8 text-justify font-interregular">
                    @HotelDescription@
                </div>
            </section>   
                        </script>
                </face>
            </basis>




                        <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                <layout>
                    @child
                </layout>
                <face>
                    <script type="text/template">
            <section>
                <h2 class="font-bold text-2xl my-2 font-interbold ">Rules</h2>
                <div class="bg-[#F8F8F8] rounded-xl py-4  px-8 text-justify font-interregular">
                    {{ return await renderRules($data)}}
                            </div>
            </section>
                        </script>
                </face>
            </basis>






            <basis core="print" datamembername="db.voucher_pdf" run="atclient">
                <layout>
                    @child
                </layout>
                <face>
                    <script type="text/template">
            <section>
                <h2 class="font-bold text-2xl my-2 font-interbold ">Note</h2>
                <div class="bg-[#F8F8F8] rounded-xl py-4  px-8 text-justify font-interregular">
                    @note@
                            </div>
            </section>
                        </script>
                </face>
            </basis>





    </main>



    <footer class="h-[100px] print:w-[595pt] print:h-[75pt] w-full bg-gray-200">

    </footer>

</body>


<basis core="call" file="Client_BasisCore_Script.inc"></basis>
<script>

    async function RenderInfoCard($data) {
        let hotelJson = $data;

        if (!hotelJson || !hotelJson.hotelinfo) {
            console.error("Invalid hotel data:", hotelJson);
            return '<div class="text-red-500">Invalid hotel data provided.</div>';
        }

        const hotel = hotelJson.hotelinfo;
        const checkin = hotelJson.checkin?.mstring ? formatDateToReadable(hotelJson.checkin.mstring) : "";
        const checkout = hotelJson.checkout?.mstring ? formatDateToReadable(hotelJson.checkout.mstring) : "";
        const nights = hotelJson.nights || 0;
        const roomsCount = hotelJson.rooms?.length || 0;

        let infocard = `
<div class="w-3/5">
    <div class="flex leading-5 gap-x-3">
        <figure class="w-[80px] h-[80px] rounded-[5px] overflow-hidden">
            <img class="w-[80px] h-[80px] object-cover " width="80" height="80" src="${hotel.hotelimage}"
                alt="${hotel.hotelname}" />
        </figure>
        <div class="flex flex-col gap-y-1">
            <h2 class="text-lg font-semibold font-intersemibold">
                ${hotel.hotelname}
            </h2>
            <div class="flex items-center">
                ${RenderRateHotel(hotel.star)}
                <span class="text-sm ml-2 font-interregular">${hotel.star} star</span>
            </div>
            <span class="text-base font-interregular">${hotel.ecountry} / ${hotel.ecity}</span>
        </div>
    </div>

    <div class="mt-3">
                        <ul class="flex flex-col gap-y-2 font-interregular">
                            <li>
                                <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">
                                    <svg class="scale-150 origin-center" width="13" height="13">
                                        <use href="./images/pdf-sprite-icons.svg#location-icon-pdf"></use>
                                    </svg>
                                    <span>
                                        veniam, quis nostrud exercitation ullamco laboris
                                    </span>
                                </div>
                            </li>
                            <li>
                                <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">

                                    <svg class="scale-150 origin-center" width="12" height="13">
                                        <use href="./images/pdf-sprite-icons.svg#call-icon-pdf"></use>
                                    </svg>
                                    <span>
                                        +51-556699774411
                                    </span>
                                </div>
                            </li>
                            <li>
                                <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">

                                    <svg class="scale-150 origin-center" width="13" height="13">
                                        <use href="./images/pdf-sprite-icons.svg#email-icon-pdf"></use>
                                    </svg>
                                    <span>
                                        heydarimohsen71@gmail.com
                                    </span>
                                </div>
                            </li>
                            <li>
                                <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">

                                    <svg class="scale-150 origin-center" width="13" height="13">
                                        <use href="./images/pdf-sprite-icons.svg#www-icon-pdf"></use>
                                    </svg>
                                    <span>
                                        www.moshenheydari.com
                                    </span>
                                </div>
                            </li>
                        </ul>
    </div>
</div>
<div class="w-2/5 border-l-2 border-[#E3E3E3] pl-3 ">
    <ul class="flex flex-col gap-y-2">
        <li>
            <h2 class="text-base font-semibold font-intersemibold">Check in</h2>
            <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">
                <svg class="scale-150 origin-center" width="13" height="13">
                    <use href="./images/pdf-sprite-icons.svg#calendar-icon-pdf"></use>
                </svg>
                <span class="font-interregular">${checkin}</span>
            </div>
        </li>
        <li>
            <h2 class="text-base font-semibold font-intersemibold">Check out</h2>
            <div class="flex items-center w-full gap-x-2 text-sm text-[#242424]">
                <svg class="scale-150 origin-center" width="13" height="13">
                    <use href="./images/pdf-sprite-icons.svg#calendar-icon-pdf"></use>
                </svg>
                <span class="font-interregular">${checkout}</span>
            </div>
        </li>
        <li>
            <h2 class="text-base font-semibold font-intersemibold">Night</h2>
            <div class="flex items-center w-full gap-x-2 text-sm text-[#242424] font-interregular">
                ${nights}
            </div>
        </li>
        <li>
            <h2 class="text-base font-semibold font-intersemibold">Room</h2>
            <div class="flex items-center w-full gap-x-2 text-sm text-[#242424] font-interregular">
                ${roomsCount}
            </div>
        </li>
    </ul>
</div>`;

        return infocard;
    }



async function renderRules($data) {
  const rules = $data?.pdf_description;
  console.log("rules:", rules);

  if (!rules || !Array.isArray(rules)) {
    console.warn("هیچ آیتمی در pdf_description پیدا نشد");
    return null;
  }

  let ulitem = '';
  rules.forEach((item, index) => {

    console.log(`بررسی آیتم ${index}:`, item);

    const text = item?.note?.text?.trim();

    if (text) {
        ulitem+=`<li>${text}</li>`;
    } else {
      console.warn(`آیتم ${index} متن معتبری ندارد`, item);
    }
  });

  return `<ul>${ulitem}</ul>`;
}






    function RenderRateHotel(starCount) {
        let stars = '';
        for (let i = 0; i < starCount; i++) {
            stars += `
            <svg width="14" height="14">
                <use href="./images/pdf-sprite-icons.svg#star-icon-pdf"></use>
            </svg>`;
        }
        return stars;
    }

    function formatDateToReadable(dateString) {
        const date = new Date(dateString);
        const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: '2-digit'
        };
        const formatted = date.toLocaleDateString('en-US', options);
        const [weekday, month, day, year] = formatted.replace(',', '').split(' ');
        return `${day} ${month} ${year} / ${weekday}`;
    }


    // async function renderRooms($data) {
    //     let hotelinfo = $data?.hotelinfo;
    //     let roominfo = $data?.rooms;
    //     let roomcontent = '';

    //     roominfo.forEach((room, roomIndex) => {
    //         let passengersHTML = `<div>${room.passengers
    //             .map(p => `${p.fullname.firstname.trim()} ${p.fullname.lastname.trim()}`)}</div>`;


    //         let childrenCount = (room.numpassenger.childwithbed || 0) + (room.numpassenger.childwithoutbed || 0);

    //         roomcontent += `
    //         <h2 class="font-bold text-2xl my-2 font-interbold">Room ${room.index}</h2>
    //         <div class="bg-[#F4FBF9] rounded-xl p-4 flex justify-between flex-wrap">
    //             <div class="gap-y-2 flex flex-col">
    //                 <span class="text-[#6D6D6D] text-sm text-nowrap font-interregular">Room type</span>
    //                 <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">${room.roomtype.trim()}</h2>
    //             </div>

    //             <div class="gap-y-2 flex flex-col">
    //                 <span class="text-[#6D6D6D] text-sm text-nowrap font-interregular">Board</span>
    //                 <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">
    //                     ${escapeXML(hotelinfo.services)}</h2>
    //             </div>
    //         <div class="gap-y-2 flex flex-col">
    //             <span class="text-[#6D6D6D] text-sm text-nowrap font-interregular">Passenger:</span>
    //             <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">

    //                 ${passengersHTML}
    //             </h2>
    //         </div>


    //             <div class="gap-y-2 flex flex-col">
    //                 <span class="text-[#6D6D6D] text-sm text-nowrap font-interregular">Gender:</span>
    //                 <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">${rooms.passengers.type}</h2>
    //             </div>


    //             <div class="gap-y-2 flex flex-col">
    //                 <span class="text-[#6D6D6D] text-sm text-nowrap font-interregular">Children ages:</span>
    //                 <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">${rooms.passengers.age}</h2>
    //             </div>

    //             <div class="gap-y-2 flex flex-col">
    //                 <span class="text-[#6D6D6D] text-sm text-nowrap font-interregular">Status:</span>
    //                 <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">${room.onrequest === "1" ? "On Request" : "Available"}</h2>
    //             </div>
    //         </div>
    //     `;
    //     });

    //     return roomcontent;
    // }



    async function renderRooms($data) {
        let hotelinfo = $data?.hotelinfo;
        let roominfo = $data?.rooms;
        let roomcontent = '';

        roominfo.forEach((room) => {
            const parsedPassengers = room.passengers.map(p => {
                const typeRaw = p.type || '';
                const typeMatch = typeRaw.match(/^([^\(]+)(?:\s*\((.+)\))?/);
                const passengerType = typeMatch?.[1]?.trim() || '–';
                const passengerAge = typeMatch?.[2]?.trim() || (p.age || '–');

                return {
                    name: `${p.fullname.firstname.trim()} ${p.fullname.lastname.trim()}`,
                    type: passengerType,
                    age: passengerAge
                };
            });

            const passengerNames = parsedPassengers.map(p =>
                `<h2 class="text-[#292929] text-sm font-semibold font-intersemibold">${p.name}</h2>`
            ).join('');

            const passengerTypes = parsedPassengers.map(p =>
                `<h2 class="text-[#292929] text-sm font-semibold font-intersemibold">${p.type}</h2>`
            ).join('');

            const passengerAges = parsedPassengers.map(p =>
                `<h2 class="text-[#292929] text-sm font-semibold font-intersemibold">${p.age}</h2>`
            ).join('');

            const childrenCount = (room.numpassenger.childwithbed || 0) + (room.numpassenger.childwithoutbed || 0);

            roomcontent += `
            <h2 class="font-bold text-2xl my-2 font-interbold">Room ${room.index}</h2>
            <div class="bg-[#F4FBF9] rounded-xl p-4 flex flex-wrap justify-between gap-4">
                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-interregular">Room type</span>
                    <div class="text-[#292929] text-sm font-semibold font-intersemibold self-center flex justify-center items-center h-[calc(100%-20px)]">${room.roomtype.trim()}</div>
                </div>

                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-interregular">Board</span>
                    <div class="text-[#292929] text-sm font-semibold font-intersemibold self-center flex justify-center items-center h-[calc(100%-20px)]">
                        ${escapeXML(hotelinfo.services)}
                    </div>
                </div>

                <!-- Passenger Names -->
                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-interregular">Passenger</span>
                    ${passengerNames}
                </div>

                <!-- Passenger Types (Gender) -->
                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-interregular">Gender</span>
                    ${passengerTypes}
                </div>

                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-interregular">Age</span>
                    ${passengerAges}
                </div>

                <div class="gap-y-2 flex flex-col">
                    <span class="text-[#6D6D6D] text-sm font-interregular">Status</span>
                    <div class="text-[#292929] text-sm font-semibold font-intersemibold self-center flex justify-center items-center h-[calc(100%-20px)]">
                        ${room.onrequest === "1" ? "On Request" : "Available"}
                    </div>
                </div>
            </div>
        `;
        });

        return roomcontent;
    }











    // async function renderRooms($data) {
    //     let hotelinfo = $data?.hotelinfo;
    //     let roominfo = $data?.rooms; 
    //     let roomcontent = '';

    //     roominfo.forEach((room) => {
    //         let childrenCount = (room.numpassenger.childwithbed || 0) + (room.numpassenger.childwithoutbed || 0);

    //         roomcontent += `
    //             <h2 class="font-bold text-2xl my-2 font-interbold">Room ${room.index}</h2>
    //         `;

    //         // برای هر passenger یک باکس مشابه تولید می‌کنیم
    //         room.passengers.forEach((p, idx) => {
    //             roomcontent += `
    //                 <div class="bg-[#F4FBF9] rounded-xl p-4 flex justify-between flex-wrap mb-4">
    //                     <div class="gap-y-1 flex flex-col">
    //                         <span class="text-[#6D6D6D] text-sm font-interregular">Room type</span>
    //                         <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">${room.roomtype.trim()}</h2>
    //                     </div>

    //                     <div class="gap-y-1 flex flex-col">
    //                         <span class="text-[#6D6D6D] text-sm font-interregular">Board</span>
    //                         <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">${escapeXML(hotelinfo.services)}</h2>
    //                     </div>

    //                     <div class="gap-y-1 flex flex-col">
    //                         <span class="text-[#6D6D6D] text-sm font-interregular">Passenger</span>
    //                         <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">
    //                             ${p.fullname.firstname.trim()} ${p.fullname.lastname.trim()}
    //                         </h2>
    //                     </div>

    //                     <div class="gap-y-1 flex flex-col">
    //                         <span class="text-[#6D6D6D] text-sm font-interregular">Adult</span>
    //                         <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">${room.numpassenger.adult}</h2>
    //                     </div>

    //                     <div class="gap-y-1 flex flex-col">
    //                         <span class="text-[#6D6D6D] text-sm font-interregular">Children</span>
    //                         <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">${childrenCount}</h2>
    //                     </div>

    //                     <div class="gap-y-1 flex flex-col">
    //                         <span class="text-[#6D6D6D] text-sm font-interregular">Status</span>
    //                         <h2 class="text-[#292929] text-sm font-semibold font-intersemibold">
    //                             ${room.onrequest === "1" ? "On Request" : "Available"}
    //                         </h2>
    //                     </div>
    //                 </div>
    //             `;
    //         });
    //     });

    //     return roomcontent;
    // }


    function escapeXML(str) {
        return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&apos;");
    }




    // export async function getHotelInfo($data) {
    //     hotelJson = $data;
    //     return hotelJson.hotelinfo;
    // }

    // export async function getHotelImage($data) {
    //     hotelJson = $data;
    //     return hotelJson.hotelinfo?.hotelimage || "";
    // }

    // export async function getHotelName($data) {
    //     hotelJson = $data;
    //     return hotelJson.hotelinfo?.hotelname || "";
    // }

    // export async function getPersianHotelName($data) {
    //     hotelJson = $data;
    //     return hotelJson.hotelinfo?.persianname || "";
    // }

    // export async function getHotelStar($data) {
    //     hotelJson = $data;
    //     return hotelJson.hotelinfo?.star || 0;
    // }

    // export async function getCountryInfo($data) {
    //     hotelJson = $data;
    //     return {
    //         english: hotelJson.hotelinfo?.ecountry || "",
    //         persian: hotelJson.hotelinfo?.country || ""
    //     };
    // }

    // export async function getCityInfo($data) {
    //     hotelJson = $data;
    //     return {
    //         english: hotelJson.hotelinfo?.ecity || "",
    //         persian: hotelJson.hotelinfo?.city || ""
    //     };
    // }

    // export async function getServices($data) {
    //     hotelJson = $data;
    //     return hotelJson.hotelinfo?.services || "";
    // }

    // export async function getCheckinDate($data) {
    //     hotelJson = $data;
    //     return hotelJson.checkin;
    // }

    // export async function getCheckoutDate($data) {
    //     hotelJson = $data;
    //     return hotelJson.checkout;
    // }

    // export async function getNights($data) {
    //     hotelJson = $data;
    //     return hotelJson.nights || 0;
    // }

    // export async function getFlightInfo($data) {
    //     hotelJson = $data;
    //     return hotelJson.flightinfo || "";
    // }

    // export async function getRooms($data) {
    //     hotelJson = $data;
    //     return hotelJson.rooms || [];
    // }

    // export async function getRoomByIndex(index = 0) {
    //     return hotelJson.rooms?.[index] || null;
    // }

    // export async function getPassengersInRoom(index = 0) {
    //     return hotelJson.rooms?.[index]?.passengers || [];
    // }

    // export async function getPassengerFullNames(index = 0) {
    //     const passengers = hotelJson.rooms?.[index]?.passengers || [];
    //     return passengers.map(p => `${p.fullname.firstname.trim()} ${p.fullname.lastname.trim()}`);
    // }

    // export async function getRoomType(index = 0) {
    //     return hotelJson.rooms?.[index]?.roomtype?.trim() || "";
    // }

    // export async function isRoomOnRequest(index = 0) {
    //     return hotelJson.rooms?.[index]?.onrequest === "1";
    // }

    // export async function getNote($data) {
    //     hotelJson = $data;
    //     return hotelJson.note || "";
    // }

    // export async function getPdfDescription($data) {
    //     hotelJson = $data;
    //     return hotelJson.pdf_description?.map(d => d.note) || [];
    // }

    // export async function getCreateDate($data) {
    //     hotelJson = $data;
    //     return hotelJson.createDate;
    // }

    // export async function getCreateHour($data) {
    //     hotelJson = $data;
    //     return hotelJson.createHour || "";
    // }

    // export async function getRefNumber($data) {
    //     hotelJson = $data;
    //     return hotelJson.refnumber || "";
    // }

    // export async function getTransfer($data) {
    //     hotelJson = $data;
    //     return hotelJson.transfer || {};
    // }

    // export async function getHotelDescription($data) {
    //     hotelJson = $data;
    //     return hotelJson.HotelDescription || "";
    // }

    // export async function getBroker($data) {
    //     hotelJson = $data;
    //     return hotelJson.broker || "";
    // }

    // export async function getProvider($data) {
    //     hotelJson = $data;
    //     return hotelJson.provider || "";
    // }


</script>

</html>