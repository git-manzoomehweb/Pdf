<basis core="call" lid="1" file="Client_CheckRkey.inc"></basis>
<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lounge PDF</title>
    <link rel="stylesheet" href="[##cms.cms.cdn##]/css/pdf-ui.min.css">
    <script src="[##cms.cms.cdn##]/js/html2pdf.bundle.min.js"></script>
</head>

<body class="p-0 m-0 overflow-auto" id="content">
    <basis core="group" name="invalid-rkey" if="'[##db.checkrkey.checked##]'<>'true'">
        <div
            class="dir-rtl bg-red-300 border-2 border-red-500 rounded-xl py-4 px-8 font-danaregular max-w-7xl text-center w-fit mx-auto my-auto absolute top-0 left-0 right-0 bottom-0 h-fit ">
            شما اجازه دسترسی به این صفحه را ندارید </div>
    </basis>
    <basis core="group" name="valid-rkey" if="'[##db.checkrkey.checked##]'='true'">
        <basis core="api" name="api.Webservice" url="https://www.basisfly.com/panel/main/view/[##cms.query.rkey##]"
            method="post" body='{
    "name": "db",
    "mid": "20",
    "member": [
        {
            "type": "list",
            "name": "q",
            "request": "lounge_pdf",
            "id": "[##cms.query.id##]",
            "lid": "[##cms.query.lid|(1)##]"
        }
    ]
}' content-type="application/json" run="atclient"></basis>
        <div
            class="text-sm max-w-screen-md min-w-[900px] mx-auto mt-8 max-lg:w-full max-lg:min-w-0 max-lg:max-w-full margin-btn dir-rtl">
            <button class="flex gap-1 font-danademibold items-center my-4 font-bold text-base hover:text-[#FF0000]"
                onclick="DownloadPDF()"><svg xmlns="http://www.w3.org/2000/svg" width="35" height="35"
                    viewBox="0 0 24 24" fill="none" stroke="#FF0000" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="9" y1="13" x2="15" y2="13" />
                    <line x1="9" y1="17" x2="15" y2="17" />
                </svg>دانلود PDF </button>
        </div>
        <header id="pdf-header" class="header h-[80px] w-auto mx-auto "><img
                class="block h-[80px] w-auto mx-auto object-contain"
                src="[##cms.cms.cdn##]/images/Header-contract-pdf.jpg" width="794" height="100"
                alt="Footer-contract-pdf" /></header>
        <main class="dir-rtl pdf-content py-6 w-full max-w-[794px] mx-auto">
            <div class="pdf-loading hidden ">
                <div
                    class="flex justify-center items-center fixed z-[99] w-full h-full top-0 left-0 right-0 bottom-0 bg-black/60 backdrop-blur-xl">
                    <span
                        class="dir-rtl pointer-events-none rounded bg-primary px-6 pb-2 pt-2.5 text-xs font-medium uppercase leading-normal text-white
                         shadow-primary-3 transition duration-150 ease-in-out hover:bg-primary-accent-300 hover:shadow-primary-2 focus:bg-primary-accent-300 
                         focus:shadow-primary-2 focus:outline-none focus:ring-0 active:bg-primary-600 active:shadow-primary-2 disabled:opacity-70 dark:shadow-black/30
                          dark:hover:shadow-dark-strong dark:focus:shadow-dark-strong dark:active:shadow-dark-strong flex justify-center items-center gap-x-2">
                        <div class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-current border-e-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"
                            role="status"></div>
                        <div class="font-danamedium leading-9 ">در حال تولید PDF...</div>
                    </span>
                </div>
            </div>


            <div class="w-[95%] mx-auto">
                <!-- info -->
                <section class="w-full flex justify-between items-center dir-rtl">
                    <h2 class="font-danademibold text-base text-black">لانژ</h2>
                    <ul class="flex gap-x-4">
                        <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                            <layout>@child </layout>
                            <face>
                                <script type="text/template"><li><div><h2 class="text-sm font-normal text-[#202020] dir-rtl text-right font-danaregular">شماره قرارداد<span>:</span></h2><p class="text-base text-[#292929] text-right font-danademibold">[##cms.query.id##
]</p></div></li></script>
                            </face>
                        </basis>
                        <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                            <layout>@child </layout>
                            <face>
                                <script
                                    type="text/template"><li><div><h2 class="text-sm font-normal text-[#202020] dir-rtl  text-right font-danaregular">تاریخ صدور<span>:</span></h2><p class="text-base text-[#292929] text-right font-danademibold">@cipinfo.createDate.sstring@</p></div></li></script>
                            </face>
                        </basis>
                        <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                            <layout>@child </layout>
                            <face>
                                <script
                                    type="text/template"><li><div><h2 class="text-sm font-normal text-[#202020] dir-rtl  text-right font-danaregular">ساعت ایجاد<span>:</span></h2><p class="text-base text-[#292929] text-center font-danademibold">@cipinfo.createHour@</p></div></li></script>
                            </face>
                        </basis>
                    </ul>
                </section>
                <section class="border-2 border-[#E3E3E3] rounded-xl my-4 justify-between flex items-center p-3">
                    <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                        <layout>@child </layout>
                        <face>
                            <script type="text/template">{
    { return await RenderInfoCard($data)
    }
} </script>
                        </face>
                    </basis>
                </section>
                <section>
                    <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                        <layout>@child </layout>
                        <face>
                            <script type="text/template">
                                {
    { return await renderLoungeInfo($data)
    }
}  
                                {
    { return await renderLoungePassengerInfo($data)
    }
} 
                                {
    { return await renderServiceInfo($data)
    }
}  
                                {
    { return await renderTransferInfo($data)
    }
}                                 
                                {
    { return await renderEscortInfo($data)
    }
}                            
                                
                            </script>
                        </face>
                    </basis>
                </section>
                <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                    <layout>@child </layout>
                    <face>
                        <script type="text/template"><section class="mt-3 {{return await checkSection($data.HotelDescription)}}" ><h2 class="font-bold text-lg my-2 font-danabold " dir="{{return await detectDirection($data.HotelDescription)}}">{
    { return await getLocalizedText(await detectDirection($data.HotelDescription) ,
        "ملاحظات",
        "Remarks")
    }
} </h2><div class="bg-[#F8F8F8] rounded-xl py-4 px-8 text-justify font-danaregular dir-{{return await detectDirection($data.HotelDescription)}}" >{
    { return await fixRTLTextCompletely($data.HotelDescription)
    }
}</div></section></script>
                    </face>
                </basis>
                <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                    <layout>@child </layout>
                    <face>
                        <script type="text/template"><section class="{{return await checkSection($data.pdf_description?.[0]?.note?.text || '')}}"><h2 class="font-bold text-lg my-2 font-danabold" dir="{{return await detectDirection($data.pdf_description?.[0]?.note?.text || '')}}" >{
    { return await getLocalizedText(await detectDirection($data.pdf_description?.[
            0
        ]?.note.text),
        "قوانین و مقررات",
        "Rules")
    }
}</h2><div class="bg-[#F8F8F8] rounded-xl py-4 px-8 text-justify font-danaregular dir-{{return await detectDirection($data.pdf_description?.[0]?.note?.text || '')}}">{
    { return await renderRules($data)
    }
} </div></section></script>
                    </face>
                </basis>
                <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                    <layout>@child </layout>
                    <face>
                        <script type="text/template"><section class="{{return await checkSection($data.note)}}"><h2 class="font-bold text-lg my-2 font-danabold" dir="{{return await detectDirection($data.note)}}" >{
    { return await getLocalizedText(await detectDirection($data.note),
        "یادداشت",
        "Note")
    }
}</h2><div class="bg-[#F8F8F8] rounded-xl py-4 px-8 text-justify font-danaregular dir-{{return await detectDirection($data.note)}}" >{
    { return await fixRTLTextCompletely($data.note)
    }
}</div></section></script>
                    </face>
                </basis>
        </main>

        <footer id="pdf-footer" class=" footer h-[80px] print:w-[595pt] print:h-[100pt] mx-auto "><img
                class="block mx-auto h-[80px] print:w-[595pt] print:h-[100pt] w-auto object-contain"
                src="[##cms.cms.cdn##]/images/Footer-contract-pdf.jpg" width="794" height="100"
                alt="Footer-contract-pdf" /></footer>
        <basis core="call" lid="1" file="Client_BasisCore_Script.inc"></basis>





        <script>

            async function RenderInfoCard($data) {
                let loungeJson = $data;

                if (!loungeJson || !loungeJson.cipinfo) {
                    console.error("Invalid hotel data:", loungeJson);
                    return '<div class="text-red-500">Invalid hotel data provided.</div>';
                }

                const cip = loungeJson.cipinfo;
                const hotelImageName = extractFilenameFromUrl(cip.hotelimage);

                const checkin = loungeJson.checkin?.mstring ? formatDateToReadable(loungeJson.checkin.mstring) : "";
                const checkout = loungeJson.checkout?.mstring ? formatDateToReadable(loungeJson.checkout.mstring) : "";
                const nights = loungeJson.nights || 0;
                const roomsCount = loungeJson.rooms?.length || 0;
                let infocard = `
            <h1 class="text-lg font-danademibold text-center">
                ${cip.loungename
                    }
            </h1>
            <div class="flex text-sm">
            <span class="text-sm font-danademibold">

                ${cip.airport
                    }
            </span>
            <span class="mx-2">/</span>
            <span class="text-sm font-danademibold">
                ${cip.cities
                    }
            </span>
            </div>`;

                return infocard;
            }

            async function renderRules($data) {
                const rules = $data?.pdf_description;
                if (!rules || !Array.isArray(rules)) {
                    console.warn("هیچ آیتمی در pdf_description پیدا نشد");
                    return null;
                }

                let direction;
                direction = detectDirection(rules?.[
                    0
                ]?.note.text);

                let ulitem = '';
                rules.forEach((item, index) => {
                    const text = item?.note?.text?.trim();

                    if (text) {
                        ulitem += `<li>${text
                            }</li>`;
                    } else {
                        console.warn(`آیتم ${index
                            } متن معتبری ندارد`, item);
                    }
                });

                // return `<ul dir="${direction}" class="text-right">${ulitem}</ul>`;
                return `<ul dir="${direction}" class="text-right">${fixRTLTextCompletely(ulitem)
                    }</ul>`;
            }

            async function renderLoungeInfo($data) {
                let product_info = $data?.product_info;
                let Flightinfo = '';

                console.log(product_info);
                Flightinfo += `
        <h2 class="font-bold text-lg my-2 font-danabold">اطلاعات lounge</h2>
        <div class="bg-[#F4FBF9] rounded-xl p-4 flex justify-between gap-4">


            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular">نام فرودگاه</span>
                <div class="text-[#292929] text-sm font-danademibold">
                ${product_info.airportName
                    }
                </div>
            </div>

            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular text-center">شهر</span>
                <div class="text-[#292929] text-sm font-danademibold">
                ${product_info.cityname
                    }
                </div>
            </div>

            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular text-center">ایرلاین</span>
                <div class="text-[#292929] text-sm font-danademibold">
                ${product_info.airline
                    }
                </div>
            </div>
            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular text-center">کد مسیر</span>
                <div class="text-[#292929] text-sm font-danademibold">
                ${product_info.routecode
                    }
                </div>
            </div>
            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular text-center">تاریخ</span>
                <div class="text-[#292929] text-sm font-danademibold dir-ltr text-left">
                <span>${product_info.dateinfo.mstring
                    }</span>
                <span>(${product_info.dateinfo.sstring
                    })</span>
                </div>
            </div>
            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular text-center">ساعت</span>
                <div class="text-[#292929] text-sm font-danademibold">
                ${product_info.time
                    }
                </div>
            </div>
            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular text-center">نوع سفر</span>
                <div class="text-[#292929] text-sm font-danademibold">
                ${product_info.traveltype === "1" ? "داخلی" : "خارجی"
                    }
                </div>
            </div>
            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular text-center">نوع پرواز</span>
                <div class="text-[#292929] text-sm font-danademibold">
                    <span>               ${product_info.flighttype === "1" ? "ورودی" : "خروجی"}
</span>
                    <span>               ${product_info.city_flight}
</span>
                </div>
            </div>

        </div>
        `;

                return Flightinfo;
            }
            async function renderLoungePassengerInfo($data) {
                const cipinfo = $data?.cipinfo;
                const passengers = $data?.passengerinfo || [];

                const parsedPassengers = passengers.map(p => {
                    const info = p.cip_passenger;
                    return {
                        name: `${info.fullname.firstname?.trim() || ''
                            } ${info.fullname.lastname?.trim() || ''
                            }`,
                        type: info.type || '–',
                        gender: info.gender || '–',
                        birthdate: info.birthdate?.birthdate1 || '–',
                        country: info.countryofresidence?.countryname || '–'
                    };
                });

                console.log(parsedPassengers);

                const passengerNames = parsedPassengers.map(p =>
                    `<h2 class="text-[#292929] text-sm font-danademibold text-nowrap">${p.name
                    }</h2>`
                ).join('');

                const passengerTypes = parsedPassengers.map(p =>
                    `<h2 class="text-[#292929] text-sm font-danademibold text-center">${p.type
                    }</h2>`
                ).join('');

                const passengerBirthdates = parsedPassengers.map(p =>
                    `<h2 class="text-[#292929] text-sm font-danademibold dir-ltr text-center text-nowrap">${p.birthdate
                    }</h2>`
                ).join('');

                const passengerCountries = parsedPassengers.map(p =>
                    `<h2 class="text-[#292929] text-sm font-danademibold text-center">${p.country
                    }</h2>`
                ).join('');


                const passengerGender = parsedPassengers.map(p =>
                    `<h2 class="text-[#292929] text-sm font-danademibold text-center">${p.gender == "1" ? "مرد" : "زن"
                    }</h2>`
                ).join('');

                return `
            <h2 class="font-bold text-lg my-2 font-danabold">اطلاعات مسافران</h2>

        <div class="bg-[#F4FBF9] rounded-xl p-4 flex justify-between gap-4">


            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular">مسافران</span>
                ${passengerNames
                    }
            </div>

            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap text-center">نوع مسافر</span>
                ${passengerTypes
                    }
            </div>

            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap text-center">جنسیت</span>
                ${passengerGender
                    }
            </div>

            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular text-center">تاریخ تولد</span>
                ${passengerBirthdates
                    }
            </div>

            <div class="gap-y-2 flex flex-col">
                <span class="text-[#6D6D6D] text-sm font-danaregular text-center">کشور</span>
                ${passengerCountries
                    }
            </div>
        </div>
    `;
            }

            async function renderServiceInfo($data) {
                const cipinfo = $data?.cipinfo;
                const services = $data?.serviceinfo || [];

                const serviceNames = services.map(s =>
                    `<h2 class="text-[#292929] text-sm font-danademibold">${s.service.servicename || '–'
                    }</h2>`
                ).join('');

                const serviceDescriptions = services.map(s =>
                    `<h2 class="text-[#292929] text-sm font-danademibold">${s.service.des_service || '–'
                    }</h2>`
                ).join('');

                const serviceCount = services.map(s =>
                    `<h2 class="text-[#292929] text-sm font-danademibold">${s.service.count || '–'
                    }</h2>`
                ).join('');

                return `<h2 class="font-bold text-lg my-2 font-danabold">اطلاعات خدمات</h2>
        <div class="bg-[#F4FBF9] rounded-xl p-4 mt-3 flex justify-between gap-x-4 gap-y-2">
            <div class="flex flex-col gap-2">
                <span class="text-[#6D6D6D] text-sm font-danaregular">نام خدمات</span>
                ${serviceNames
                    }
            </div>
            <div class="flex flex-col gap-2">
                <span class="text-[#6D6D6D] text-sm font-danaregular">تعداد</span>
                ${serviceCount
                    }
            </div>
            <div class="flex flex-col gap-2">
                <span class="text-[#6D6D6D] text-sm font-danaregular">توضیحات</span>
                ${serviceDescriptions
                    }
            </div>
        </div>
    `;
            }

            async function renderTransferInfo($data) {
                const transfers = $data?.transferinfo || [];

                const carNames = transfers.map(t =>
                    `<h2 class="text-[#292929] text-sm font-danademibold">${t.transfer?.car_name || '–'
                    }</h2>`
                ).join('');

                const addresses = transfers.map(t =>
                    `<h2 class="text-[#292929] text-sm font-danademibold">${t.transfer?.address || '–'
                    }</h2>`
                ).join('');

                const times = transfers.map(t =>
                    `<h2 class="text-[#292929] text-sm font-danademibold">${t.transfer?.time || '–'
                    }</h2>`
                ).join('');

                const phones = transfers.map(t =>
                    `<h2 class="text-[#292929] text-sm font-danademibold">${t.transfer?.phone || '–'
                    }</h2>`
                ).join('');

                const descriptions = transfers.map(t =>
                    `<h2 class="text-[#292929] text-sm font-danademibold">${t.transfer?.des_transfer || '–'
                    }</h2>`
                ).join('');

                return `
        <h2 class="font-bold text-lg my-2 font-danabold">اطلاعات ترنسفر</h2>
        <div class="bg-[#F4FBF9] rounded-xl p-4 mt-3 flex justify-between gap-x-4 gap-y-2">
            <div class="flex flex-col gap-2">
                <span class="text-[#6D6D6D] text-sm font-danaregular">نام خودرو</span>
                ${carNames
                    }
            </div>
            <div class="flex flex-col gap-2">
                <span class="text-[#6D6D6D] text-sm font-danaregular">آدرس</span>
                ${addresses
                    }
            </div>
            <div class="flex flex-col gap-2">
                <span class="text-[#6D6D6D] text-sm font-danaregular">زمان</span>
                ${times
                    }
            </div>
            <div class="flex flex-col gap-2">
                <span class="text-[#6D6D6D] text-sm font-danaregular">شماره تماس</span>
                ${phones
                    }
            </div>
            <div class="flex flex-col gap-2 col-span-full">
                <span class="text-[#6D6D6D] text-sm font-danaregular">توضیحات</span>
                ${descriptions
                    }
            </div>
        </div>
    `;
            }

            async function renderEscortInfo($data) {
                const escorts = $data?.escortinfo || [];

                const escortNames = escorts.map(e => {
                    const { firsname, lastname
                    } = e.escort || {};
                    return `<h2 class="text-[#292929] text-sm font-danademibold">${firsname || ''
                        } ${lastname || ''
                        }</h2>`;
                }).join('');

                const escortGenders = escorts.map(e => {
                    const gender = e.escort?.gender === "1" ? "مرد" : "زن";
                    return `<h2 class="text-[#292929] text-sm font-danademibold">${gender
                        }</h2>`;
                }).join('');

                return `
        <h2 class="font-bold text-lg my-2 font-danabold">اطلاعات اسکورت</h2>
        <div class="bg-[#F4FBF9] rounded-xl p-4 mt-3 flex justify-between gap-x-4 gap-y-2">
            <div class="flex flex-col gap-2 w-1/2 justify-center items-center">
                <span class="text-[#6D6D6D] text-sm font-danaregular">نام اسکورت</span>
                ${escortNames
                    }
            </div>
            <div class="flex flex-col gap-2 w-1/2 justify-center items-center">
                <span class="text-[#6D6D6D] text-sm font-danaregular">جنسیت</span>
                ${escortGenders
                    }
            </div>
        </div>
    `;
            }

        </script>
        <script src="[##cms.cms.cdn##]/js/pdf-content.functions.js" defer></script>
        <script src="[##cms.cms.cdn##]/js/flight_ticket_test.js" defer></script>
    </basis>
</body>

</html>