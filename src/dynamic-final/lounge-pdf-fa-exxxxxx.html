<basis core="call" lid="1" file="Client_CheckRkey.inc"></basis>
<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lounge PDF</title>
    <link rel="stylesheet" href="[##cms.cms.cdn##]/css/pdf-ui.min.css">
    <script src="[##cms.cms.cdn##]/js/html2pdf.bundle.min.js"></script>
</head>

<body class="p-0 m-0 overflow-auto" id="content">
    <basis core="group" name="invalid-rkey" if="'[##db.checkrkey.checked##]'<>'true'">
        <div
            class="dir-rtl bg-red-300 border-2 border-red-500 rounded-xl py-4 px-8 font-danaregular max-w-7xl text-center w-fit mx-auto my-auto absolute top-0 left-0 right-0 bottom-0 h-fit ">
            شما اجازه دسترسی به این صفحه را ندارید </div>
    </basis>
    <basis core="group" name="valid-rkey" if="'[##db.checkrkey.checked##]'='true'">
        <basis core="api" name="api.Webservice" url="https://www.basisfly.com/panel/main/view/[##cms.query.rkey##]"
            method="post"
            body='{ "name": "db", "mid": "20", "member": 
            [{ "type": "list", "name": "q", "request": "lounge_pdf", "id": "[##cms.query.id##]", "lid": "[##cms.query.lid|(1)##]", "cityid": "[##cms.query.cityid|(0)##]", "status": "[##cms.query.status|(0)##]"} ]}'
            content-type="application/json" run="atclient"></basis>

                    <div
            class="text-sm max-w-screen-md flex justify-center  min-w-[900px] mx-auto mt-8 max-lg:w-full max-lg:min-w-0 max-lg:max-w-full margin-btn dir-rtl">
            <button class="flex gap-1 font-danademibold items-center my-4 font-bold text-base hover:text-[#FF0000]"
                onclick="DownloadPDF()"><svg xmlns="http://www.w3.org/2000/svg" width="35" height="35"
                    viewBox="0 0 24 24" fill="none" stroke="#FF0000" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="9" y1="13" x2="15" y2="13" />
                    <line x1="9" y1="17" x2="15" y2="17" />
                </svg>دانلود PDF </button>
        </div>

        <header id="pdf-header" class="header h-[100px] w-auto mx-auto "><img
                class="block h-[100px] w-auto mx-auto object-contain"
                src="[##cms.cms.cdn##]/images/Header-contract-pdf.jpg" width="1060" height="100"
                alt="Footer-contract-pdf" /></header>
        <main
            class="dir-rtl pdf-content py-6 w-full max-w-[794px] mx-auto">
            <div class="pdf-loading hidden ">
                <div
                    class="flex justify-center items-center fixed z-[99] w-full h-full top-0 left-0 right-0 bottom-0 bg-black/60 backdrop-blur-xl">
                    <span
                        class="dir-rtl pointer-events-none rounded bg-primary px-6 pb-2 pt-2.5 text-xs font-medium uppercase leading-normal text-white
                         shadow-primary-3 transition duration-150 ease-in-out hover:bg-primary-accent-300 hover:shadow-primary-2 focus:bg-primary-accent-300 
                         focus:shadow-primary-2 focus:outline-none focus:ring-0 active:bg-primary-600 active:shadow-primary-2 disabled:opacity-70 dark:shadow-black/30
                          dark:hover:shadow-dark-strong dark:focus:shadow-dark-strong dark:active:shadow-dark-strong flex justify-center items-center gap-x-2">
                        <div class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-current border-e-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"
                            role="status"></div>
                        <div class="font-danamedium leading-9 ">در حال تولید PDF...</div>
                    </span>
                </div>
            </div>


            <div class="w-[95%] mx-auto">
                <!-- info -->
                <section class="w-full flex justify-between items-center dir-rtl">
                    <h2 class="font-danademibold text-base text-black">لانژ</h2>
                    <ul class="flex gap-x-4">
                        <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                            <layout>@child </layout>
                            <face>
                                <script
                                    type="text/template"><li><div><h2 class="text-sm font-normal text-[#202020] dir-rtl text-right font-danaregular">شماره قرارداد<span>:</span></h2><p class="text-base text-[#292929] text-right font-danademibold">[##cms.query.id##]</p></div></li></script>
                            </face>
                        </basis>
                        <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                            <layout>@child </layout>
                            <face>
                                <script
                                    type="text/template"><li><div><h2 class="text-sm font-normal text-[#202020] dir-rtl  text-right font-danaregular">تاریخ صدور<span>:</span></h2><p class="text-base text-[#292929] text-right font-danademibold">@cipinfo.createDate.sstring@</p></div></li></script>
                            </face>
                        </basis>
                        <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                            <layout>@child </layout>
                            <face>
                                <script
                                    type="text/template"><li><div><h2 class="text-sm font-normal text-[#202020] dir-rtl  text-right font-danaregular">ساعت ایجاد<span>:</span></h2><p class="text-base text-[#292929] text-center font-danademibold">@cipinfo.createHour@</p></div></li></script>
                            </face>
                        </basis>
                    </ul>
                </section>
                <section class="border-2 border-[#E3E3E3] rounded-xl my-4 justify-between flex p-3">
                    <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                        <layout>@child </layout>
                        <face>
                            <script type="text/template">{{ return await RenderInfoCard($data)}} </script>
                        </face>
                    </basis>
                </section>
                <section>
                    <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                        <layout>@child </layout>
                        <face>
                            <script type="text/template">{{ return await renderRooms($data)}} </script>
                        </face>
                    </basis>
                </section>
                <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                    <layout>@child </layout>
                    <face>
                        <script
                            type="text/template"><section class="mt-3 {{return await checkSection($data.HotelDescription)}}" ><h2 class="font-bold text-lg my-2 font-danabold " dir="{{return await detectDirection($data.HotelDescription)}}">{{ return await getLocalizedText(await detectDirection($data.HotelDescription) , "ملاحظات", "Remarks")}} </h2><div class="bg-[#F8F8F8] rounded-xl py-4 px-8 text-justify font-danaregular dir-{{return await detectDirection($data.HotelDescription)}}" >{{ return await fixRTLTextCompletely($data.HotelDescription) }}</div></section></script>
                    </face>
                </basis>
                <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                    <layout>@child </layout>
                    <face>
                        <script
                            type="text/template"><section class="{{return await checkSection($data.pdf_description?.[0]?.note?.text || '')}}"><h2 class="font-bold text-lg my-2 font-danabold" dir="{{return await detectDirection($data.pdf_description?.[0]?.note?.text || '')}}" >{{ return await getLocalizedText(await detectDirection($data.pdf_description?.[0]?.note.text), "قوانین و مقررات", "Rules")}}</h2><div class="bg-[#F8F8F8] rounded-xl py-4 px-8 text-justify font-danaregular dir-{{return await detectDirection($data.pdf_description?.[0]?.note?.text || '')}}">{{ return await renderRules($data)}} </div></section></script>
                    </face>
                </basis>
                <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                    <layout>@child </layout>
                    <face>
                        <script
                            type="text/template"><section class="{{return await checkSection($data.note)}}"><h2 class="font-bold text-lg my-2 font-danabold" dir="{{return await detectDirection($data.note)}}" >{{ return await getLocalizedText(await detectDirection($data.note), "یادداشت", "Note")}}</h2><div class="bg-[#F8F8F8] rounded-xl py-4 px-8 text-justify font-danaregular dir-{{return await detectDirection($data.note)}}" >{{ return await fixRTLTextCompletely($data.note) }}</div></section></script>
                    </face>
                </basis>
        </main>

        <footer id="pdf-footer" class=" footer h-[100px] print:w-[595pt] print:h-[100pt] mx-auto "><img
                class="block mx-auto h-[100px] print:w-[595pt] print:h-[100pt] w-auto object-contain"
                src="[##cms.cms.cdn##]/images/Footer-contract-pdf.jpg" width="1060" height="100"
                alt="Footer-contract-pdf" /></footer>
        <basis core="call" lid="1" file="Client_BasisCore_Script.inc"></basis>
        <script>


































function cleanInvisibleCharsFromTags(text) {
  if (typeof text !== 'string') return text;

  // لیست کاراکترهای نامرئی کنترل جهت متن
  const invisibleChars = /[\u200E\u200F\u202A-\u202E]/g;

  // فقط داخل تگ‌های HTML پاکسازی کن
  return text.replace(/<[^>]+>/g, tag => tag.replace(invisibleChars, ''));
}

function sanitizeText(text) {
  if (typeof text !== 'string') return text;

  // حذف همه کاراکترهای کنترل جهت متن (جهت جلوگیری از خراب‌شدن خروجی)
  const cleaned = text.replace(/[\u200E\u200F\u202A-\u202E]/g, '');

  return cleaned;
}

function fixRTLTextFromJSON(text) {
  if (typeof text !== 'string') return text;

  const rtlCharRange = /[\u0600-\u06FF]/;
  const ltrSensitiveChars = [':', '-', '(', ')', '/', '.', ',', '|'];

  if (rtlCharRange.test(text)) {
    const RLE = '\u202B'; // Right-To-Left Embedding
    const PDF = '\u202C'; // Pop Directional Formatting

    // اعمال RLE و PDF فقط به کل متن RTL، اگر شامل کاراکتر حساس بود
    const hasLTRSensitive = ltrSensitiveChars.some(char => text.includes(char));
    if (hasLTRSensitive) {
      text = RLE + text + PDF;
    }
  }

  return text;
}

function fixRTLTextCompletely(text) {
  if (typeof text !== 'string') return text;

  // جدا کردن تگ‌ها از متن (هم باز و هم بسته)
  const parts = text.split(/(<[^>]+>)/g);

  const fixed = parts.map(part => {
    if (part.startsWith('<') && part.endsWith('>')) {
      // این یک تگ HTML هست → فقط کاراکترهای مخفی رو حذف کن
      return part.replace(/[\u200E\u200F\u202A-\u202E]/g, '');
    } else {
      // این متن واقعی هست → اصلاحات مربوط به جهت متن انجام بده
      return fixRTLTextFromJSON(part);
    }
  });

  return fixed.join('');
}
            function detectDirection(text) {
                const rtlChars = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]/;
                return rtlChars.test(text) ? 'rtl' : 'ltr';
            }

            function extractFilenameFromUrl(url) {
                if (!url) return "";
                try {
                    const parsedUrl = new URL(url);
                    return parsedUrl.pathname.split('/').pop();
                } catch (e) {
                    return url.split('/').pop();
                }
            }



            function formatDateToReadable(dateString) {
                const date = new Date(dateString);
                const options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: '2-digit'
                };
                const formatted = date.toLocaleDateString('en-US', options);
                const [weekday, month, day, year] = formatted.replace(',', '').split(' ');
                return `${day} ${month} ${year}<span class="mx-1"> / </span>${weekday}`;
            }

        //     async function renderRooms($data) {
        //         let cipinfo = $data?.cipinfo;
        //         let roominfo = $data?.rooms;
        //         let roomcontent = '';

        //         roominfo.forEach((room) => {
        //             const parsedPassengers = room.passengers.map(p => {
        //                 const typeRaw = p.type || '';
        //                 const typeMatch = typeRaw.match(/^([^\(]+)(?:\s*\((.+)\))?/);
        //                 const passengerType = typeMatch?.[1]?.trim() || '–';
        //                 const passengerAge = typeMatch?.[2]?.trim() || (p.age || '–');

        //                 return {
        //                     name: `${p.fullname.firstname.trim()} ${p.fullname.lastname.trim()}`,
        //                     type: passengerType,
        //                     age: passengerAge
        //                 };
        //             });

        //             const passengerNames = parsedPassengers.map(p =>
        //                 `<h2 class="text-[#292929] text-sm font-danademibold text-nowrap">${p.name}</h2>`
        //             ).join('');

        //             const passengerTypes = parsedPassengers.map(p =>
        //                 `<h2 class="text-[#292929] text-sm font-danademibold text-center">${p.type}</h2>`
        //             ).join('');

        //             const passengerAges = parsedPassengers.map(p =>
        //                 `<h2 class="text-[#292929] text-sm font-danademibold dir-ltr text-center text-nowrap">${p.age}</h2>`
        //             ).join('');

        //             const childrenCount = (room.numpassenger.childwithbed || 0) + (room.numpassenger.childwithoutbed || 0);

        //             roomcontent += `
        //     <h2 class="font-bold text-lg my-2 font-danabold">اتاق ${room.index}</h2>
        //     <div class="bg-[#F4FBF9] rounded-xl p-4 flex justify-between gap-4">
        //         <div class="gap-y-2 flex flex-col">
        //             <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap">نوع اتاق</span>
        //             <div class="text-[#292929] text-sm font-danademibold self-center flex justify-center items-center h-[calc(100%-20px)]">${room.roomtype.trim()}</div>
        //         </div>
    
        //         <div class="gap-y-2 flex flex-col">
        //             <span class="text-[#6D6D6D] text-sm font-danaregular">خدمات</span>
        //             <div class="text-[#292929] text-sm font-danademibold self-center flex justify-center items-center h-[calc(100%-20px)]">
        //                 ${escapeXML(cipinfo.services)}
        //             </div>
        //         </div>
    
        //         <!-- Passenger Names -->
        //         <div class="gap-y-2 flex flex-col">
        //             <span class="text-[#6D6D6D] text-sm font-danaregular">مسافران</span>
        //             ${passengerNames}
        //         </div>
    
        //         <!-- Passenger Types (Gender) -->
        //         <div class="gap-y-2 flex flex-col">
        //             <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap text-center">نوع مسافر</span>
        //             ${passengerTypes}
        //         </div>
    
        //         <div class="gap-y-2 flex flex-col">
        //             <span class="text-[#6D6D6D] text-sm font-danaregular text-center">سن</span>
        //             ${passengerAges}
        //         </div>
    
        //         <div class="gap-y-2 flex flex-col">
        //             <span class="text-[#6D6D6D] text-sm font-danaregular">وضعیت</span>
        //             <div class="text-[#292929] text-sm font-danademibold self-center flex justify-center items-center h-[calc(100%-20px)]">
        //                 ${room.onrequest === "1" ? "On Request" : "Available"}
        //             </div>
        //         </div>
        //     </div>
        // `;
        //         });

        //         return roomcontent;
        //     }



            function escapeXML(str) {
                return str.replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&apos;");
            }

            async function getLocalizedText(dir, faText, enText) {
                const isRTL = dir === 'rtl';
                return isRTL ? faText : enText;
            }

            async function checkSection(input) {


                // اگر ورودی null یا undefined یا رشته خالی بود
                if (
                    input === null ||
                    input === undefined ||
                    (typeof input === 'string' && input.trim() === '')
                ) {
                    return 'hidden';
                }

                // اگر رشته HTML هست مثل <p></p> یا <div>  </div> یا فقط تگ‌های خالی
                if (typeof input === 'string') {
                    const temp = document.createElement('div');
                    temp.innerHTML = input;

                    // اگر هیچ متن قابل‌نمایشی نداشت
                    if (temp.textContent.trim() === '') {
                        return 'hidden';
                    }
                }

                // در غیر اینصورت مشکلی نیست
                return '';
            }

            async function waitForImagesToLoad(container) {
                const images = container.querySelectorAll("img");
                const promises = [];
                images.forEach(img => {
                    if (!img.complete) {
                        promises.push(new Promise(resolve => {
                            img.onload = resolve;
                            img.onerror = resolve;
                        }));
                    }
                });
                await Promise.all(promises);
            }


            async function DownloadPDF() {
                console.log("generate clicked");

                const element = document.querySelector('.pdf-content');
                const headerElement = document.getElementById('pdf-header');
                const footerElement = document.getElementById('pdf-footer');
                const loadingElement = document.querySelector('.pdf-loading');

                // ذخیره عرض اصلی
                const originalWidth = element.style.width;

                try {
                    if (loadingElement) loadingElement.classList.remove('hidden');

                    // تغییر عرض فقط برای خروجی PDF
                    element.style.width = '100%';

                    const isMobile = window.innerWidth <= 768;
                    let static_width = 300;
                    let static_y = -45;
                    let static_height = 20;
                    let header_scale = 1.5;
                    let main_scale = 1.2;

                    let margin = [35, 5, 35, 5];

                    if (isMobile) {
                        static_width = 190;
                        static_y = 10;
                        static_height = 25;
                        header_scale = 2;
                        main_scale = 1.2;
                        margin = [10, 10, 10, 10];
                    }

                    const opt = {
                        margin: margin,
                        image: { type: 'jpeg', quality: 1 },
                        html2canvas: {
                            scale: main_scale,
                            backgroundColor: '#ffffff',
                            useCORS: true,
                            allowTaint: true,
                            scrollX: 0,
                            scrollY: 0,
                            letterRendering: true,
                            ignoreElements: (e) => {
                                if (['BUTTON', 'A', 'SCRIPT'].includes(e.tagName)) return true;
                                if (e.classList.contains('pdf-loading', 'pdf-header', 'pdf-footer')) return true;
                                return false;
                            }
                        },
                        jsPDF: {
                            unit: 'mm',
                            format: 'a4',
                            orientation: 'portrait'
                        }
                    };

                    const [headerCanvas, footerCanvas] = await Promise.all([
                        html2canvas(headerElement, { scale: header_scale }),
                        html2canvas(footerElement, { scale: header_scale })
                    ]);

                    const headerImage = headerCanvas.toDataURL('image/png');
                    const footerImage = footerCanvas.toDataURL('image/png');

                    const maincontainer = document.querySelector("main");
                    await waitForImagesToLoad(maincontainer);

                    const worker = html2pdf().set(opt).from(element).toPdf();

                    const pdf = await worker.get('pdf');
                    const totalPages = pdf.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        pdf.addImage(headerImage, 'PNG', static_y, 5, static_width, static_height);
                        pdf.addImage(footerImage, 'PNG', static_y, 270, static_width, static_height);
                    }

                    await worker.save();

                } catch (err) {
                    console.error("PDF generation error:", err);
                    alert("خطا در تولید PDF.");
                } finally {
                    // بازگرداندن عرض به حالت اولیه
                    element.style.width = originalWidth;

                    if (loadingElement) loadingElement.classList.add('hidden');
                }
            }



            //             async function DownloadPDF() {
            //     const element = document.querySelector('.pdf-content');
            //     const headerElement = document.getElementById('pdf-header');
            //     const footerElement = document.getElementById('pdf-footer');

            //     // element.style.transform = 'scale(0.8)';
            //     // element.style.transformOrigin = 'top left';
            //     // element.style.width = '125%';

            //     try {
            //         const loadingElement = document.querySelector('.pdf-loading');
            //         if (loadingElement) loadingElement.classList.remove('hidden');
                                        
            //         const isMobile = window.innerWidth <= 768; // Adjust breakpoint as needed

            //         var static_width = 300;
            //         var static_y = -45;
            //         var static_height = 20;
            //         var html2canvas_width = 1554 * 0.8;
            //         var header_scale = 1.5;
            //         var main_sacel = 1.5;
            //         var window_width = 1900;
            //         var margin = [35, -5, 35, -5];
                    
            //         if (isMobile){
            //             static_width = 190;
            //             static_y = 10;
            //             static_height = 25;
            //             header_scale = 2;
            //             main_sacel = 1.2;
            //             html2canvas_width = 416 * 2.05;
            //             window_width = 600;
            //             margin = [35, 20, 35, -5];
            //         } else {
            //             if (window.innerWidth > 1554){
            //                 html2canvas_width = window.innerWidth * 0.6;
            //                 window_width = window.innerWidth + 115;
            //             }

            //             if (window.innerWidth < 1554){
            //                 if (window.innerWidth < 1554 && window.innerWidth > 1200){
            //                     html2canvas_width = window.innerWidth * 0.8;
            //                 } else {
            //                     html2canvas_width = window.innerWidth * 1;
            //                 }
            //                 window_width = window.innerWidth;
            //                 static_width = 190;
            //                 static_y = 10;
            //                 static_height = 25;
            //                 header_scale = 2;
            //                 main_sacel = 1.2;
            //                 margin = [35, 20, 35, -5];
            //             }
            //         }
                    
            //         const opt = {
            //             margin: margin, 
            //             image: { type: 'jpeg', quality: 1 },
            //             html2canvas: {
            //                 width: html2canvas_width,
            //                 scale: main_sacel,
            //                 windowWidth: window_width,
            //                 backgroundColor: '#ffffff',
            //                 useCORS: true,
            //                 allowTaint: true,
            //                 scrollX: 0,
            //                 scrollY: 0,
            //                 letterRendering: true,
            //                 ignoreElements: (e) => {
            //                     if (['BUTTON', 'A', 'SCRIPT'].includes(e.tagName)) {
            //                         return true;
            //                     }
            //                     if (e.classList.contains('pdf-loading', 'pdf-header', 'pdf-footer')) {
            //                         return true;
            //                     }
            //                     return false;
            //                 }
            //             },
            //             jsPDF: {
            //                 unit: 'mm',
            //                 format: 'a4',
            //                 orientation: 'portrait'
            //             }
            //         };

            //         try {
            //             const headerElement = document.getElementById('pdf-header');
            //             const footerElement = document.getElementById('pdf-footer');

            //             // تبدیل هدر و فوتر به عکس
            //             const headerCanvasPromise = html2canvas(headerElement, { scale: header_scale });
            //             const footerCanvasPromise = html2canvas(footerElement, { scale: header_scale });

            //             Promise.all([headerCanvasPromise, footerCanvasPromise]).then(async ([headerCanvas, footerCanvas]) => {
            //                 const headerImage = headerCanvas.toDataURL('image/png');
            //                 const footerImage = footerCanvas.toDataURL('image/png');

            //                 const worker = html2pdf().set(opt).from(element).toPdf();
                            
                            
            //                 worker.get('pdf').then(function (pdf) {
            //                     const totalPages = pdf.internal.getNumberOfPages();
            //                     for (let i = 1; i <= totalPages; i++) {
            //                         pdf.setPage(i);

            //                         // Add header
            //                         pdf.addImage(headerImage, 'PNG', static_y, 5, static_width, static_height); // x, y, width, height (سایز رو تنظیم کن)

            //                         // Add footer
            //                         pdf.addImage(footerImage, 'PNG', static_y, 270, static_width, static_height);
            //                     }
            //                 });

            //                 worker.save();
            //             });


            //         } catch (highResError) {}

            //     } catch (error) {
            //         console.error('PDF generation failed:', error);
            //         alert('خطا در تولید PDF.');
            //     }
            //     finally {
            //         const loadingElement = document.querySelector('.pdf-loading');
            //         if (loadingElement) loadingElement.classList.add('hidden');
            //     }
            // }
            

        </script>
        <script src="[##cms.cms.cdn##]/js/flight_ticket_test.js" defer></script>
    </basis>
</body>

</html>