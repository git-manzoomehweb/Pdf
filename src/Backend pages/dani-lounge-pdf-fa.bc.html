<basis core="call" lid="1" file="Client_CheckRkey.inc"></basis>
<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lounge PDF</title>
    <link rel="stylesheet" href="[##cms.cms.cdn##]/css/pdf-ui.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        p {
            text-align: justify !important;
            break-inside: avoid;
        }

        .pdf-content {
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
            min-width: 794px !important;
            min-height: 1697px !important;    /* ارتفاع ثابت (نسبت طلایی برای A4) */
            position: relative;
            page-break-inside: avoid;
        }

        /* Force page break before these elements */
        .page-break-before {
            page-break-before: always;
        }

        /* Force page break after these elements */
        .page-break-after {
            page-break-after: always;
        }

        table {
            page-break-inside: auto;
            page-break-before: avoid;
        }

        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }
        
        .avoid-break {
            break-inside: avoid;
        }
        
        /* Or use the more modern equivalent */
        @media print {
            .avoid-break {
                break-inside: avoid;
            }
            
            .break-before {
                break-before: page;
            }
            
            .break-after {
                break-after: page;
            }
        }
    </style>
</head>

<body class="p-0 m-0 overflow-auto" id="content">


    <basis core="group" name="invalid-rkey" if="'[##db.checkrkey.checked##]'<>'true'">
        <div
            class="dir-rtl bg-red-300 border-2 border-red-500 rounded-xl py-4 px-8 font-danaregular max-w-7xl text-center w-fit mx-auto my-auto absolute top-0 left-0 right-0 bottom-0 h-fit ">
            شما اجازه دسترسی به این صفحه را ندارید </div>
    </basis>


    <basis core="group" name="valid-rkey" if="'[##db.checkrkey.checked##]'='true'">
        <basis core="api" name="api.Webservice" url="https://www.basisfly.com/panel/main/view/[##cms.query.rkey##]"
            method="post"
            body='{ "name": "db", "mid": "20", "member": [ { "type": "list", "name": "q", "request": "lounge_pdf", "id": "[##cms.query.id##]", "lid": "[##cms.query.lid|(1)##]"} ]}'
            content-type="application/json" run="atclient"></basis>




        <header id="pdf-header" class="header h-[80px] w-auto mx-auto "><img
                class="block h-[80px] w-auto mx-auto object-contain"
                src="[##cms.cms.cdn##]/images/Header-contract-pdf.jpg" width="794" height="100"
                alt="Footer-contract-pdf" /></header>
            
        <div class="text-sm max-w-screen-md min-w-[900px] mx-auto mt-8 text-xs max-lg:w-full max-lg:min-w-0 max-lg:min-w-0 max-lg:max-w-full margin-btn">
            <button class="flex gap-1 items-center my-4 font-bold text-base hover:text-[#FF0000]"
                onclick="generatePDF()"><svg xmlns="http://www.w3.org/2000/svg" width="35" height="35"
                    viewBox="0 0 24 24" fill="none" stroke="#FF0000" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="9" y1="13" x2="15" y2="13" />
                    <line x1="9" y1="17" x2="15" y2="17" />
                </svg> دانلود PDF</button>
        </div>

        <div class="pdf-config">
            <input type="hidden" id="name" value="document"/>
            <input type="hidden" id="header" value="1"/>
        </div>

        <main class="dir-rtl pdf-content py-6 w-full max-w-[794px] mx-auto">
            <!-- pdf generator loading -->
            <div class="pdf-loading hidden ">
                <div
                    class="flex justify-center items-center fixed z-[99] w-full h-full top-0 left-0 right-0 bottom-0 bg-black/60 backdrop-blur-xl">
                    <span
                        class="dir-rtl pointer-events-none rounded bg-primary px-6 pb-2 pt-2.5 text-xs font-medium uppercase leading-normal text-white shadow-primary-3 transition duration-150 ease-in-out hover:bg-primary-accent-300 hover:shadow-primary-2 focus:bg-primary-accent-300 focus:shadow-primary-2 focus:outline-none focus:ring-0 active:bg-primary-600 active:shadow-primary-2 disabled:opacity-70 dark:shadow-black/30 dark:hover:shadow-dark-strong dark:focus:shadow-dark-strong dark:active:shadow-dark-strong flex justify-center items-center gap-x-2">
                        <div class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-current border-e-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]"
                            role="status"></div>
                        <div class="font-danamedium leading-9 ">در حال تولید PDF...</div>
                    </span></div>
            </div>


            <div class="w-[95%] mx-auto">
                <!-- info -->
                <section class="w-full flex justify-between items-center dir-rtl">
                    <h2 class="font-danademibold text-base text-black">لانژ</h2>
                    <ul class="flex gap-x-4">
                        <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                            <layout>@child </layout>
                            <face>
                                <script
                                    type="text/template"><li><div><h2 class="text-sm font-normal text-[#202020] dir-rtl text-right font-danaregular">شماره قرارداد<span>:</span></h2><p class="text-base text-[#292929] text-right font-danademibold">[##cms.query.id##]</p></div></li></script>
                            </face>
                        </basis>
                        <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                            <layout>@child </layout>
                            <face>
                                <script
                                    type="text/template"><li><div><h2 class="text-sm font-normal text-[#202020] dir-rtl text-right font-danaregular">تاریخ صدور<span>:</span></h2><p class="text-base text-[#292929] text-right font-danademibold">@cipinfo.createDate.sstring@</p></div></li></script>
                            </face>
                        </basis>
                        <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                            <layout>@child </layout>
                            <face>
                                <script
                                    type="text/template"><li><div><h2 class="text-sm font-normal text-[#202020] dir-rtl text-right font-danaregular">ساعت قرارداد<span>:</span></h2><p class="text-base text-[#292929] text-center font-danademibold">@cipinfo.createHour@</p></div></li></script>
                            </face>
                        </basis>
                    </ul>
                </section>
                <section class="border-2 border-[#E3E3E3] rounded-xl my-4 justify-between flex items-center p-3">
                    <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                        <layout>@child </layout>
                        <face>
                            <script type="text/template">{{ return await RenderInfoCard($data, [##cms.query.lid##])}} </script>
                        </face>
                    </basis>
                </section>
                <section>
                    <basis core="print" datamembername="db.lounge_pdf" run="atclient">
                        <layout>@child </layout>
                        <face>
                            <script
                                type="text/template">{{return await renderLoungeInfo($data , [##cms.query.lid##])}} {{return await renderLoungePassengerInfo($data, [##cms.query.lid##])}} {{return await renderServiceInfo($data , [##cms.query.lid##])}} {{return await renderTransferInfo($data , [##cms.query.lid##])}} {{return await renderEscortInfo($data , [##cms.query.lid##])}} </script>
                        </face>
                    </basis>
                </section>

<!-- بخش قوانین و مقررات/Rules -->
<basis core="print" datamembername="db.lounge_pdf" run="atclient">
    <layout>@child </layout>
    <face>
        <script type="text/template">
            <section class="{{return await checkSection($data.pdf_description?.[0]?.note?.text || '')}}">
                <h2 class="font-bold text-lg my-2 font-danabold" dir="{{return await detectDirection($data.pdf_description?.[0]?.note?.text || '')}}">
                    {{ return await getLocalizedText(await detectDirection($data.pdf_description?.[0]?.note?.text || ''), "قوانین و مقررات", "Rules")}}
                </h2>
                <div class="bg-[#F8F8F8] rounded-xl py-4 px-8 text-justify font-danaregular dir-{{return await detectDirection($data.pdf_description?.[0]?.note?.text || '')}}">
                    {{ return await renderRules($data)}}
                </div>
            </section>
        </script>
    </face>
</basis>

<!-- بخش یادداشت/Note -->
<basis core="print" datamembername="db.lounge_pdf" run="atclient">
    <layout>@child </layout>
    <face>
        <script type="text/template">
            <section class="{{return await checkSection($data.note)}}">
                <h2 class="font-bold text-lg my-2 font-danabold" dir="{{return await detectDirection($data.note)}}">
                    {{ return await getLocalizedText(await detectDirection($data.note), "یادداشت", "Note")}}
                </h2>
                <div class="bg-[#F8F8F8] rounded-xl py-4 px-8 text-justify font-danaregular dir-{{return await detectDirection($data.note)}}">
                    {{ return await fixRTLTextCompletely($data.note)}}
                </div>
            </section>
        </script>
    </face>
</basis>
        </main>

        <footer id="pdf-footer" class=" footer h-[80px] print:w-[595pt] print:h-[100pt] mx-auto "><img
                class="block mx-auto h-[80px] print:w-[595pt] print:h-[100pt] w-auto object-contain"
                src="[##cms.cms.cdn##]/images/Footer-contract-pdf.jpg" width="794" height="100"
                alt="Footer-contract-pdf" /></footer>

        <basis core="call" lid="1" file="Client_BasisCore_Script.inc"></basis>

        <script>
            async function RenderInfoCard($data, lang) {
                let loungeJson = $data;

                // تعریف ترجمه‌ها برای هر زبان
                const translations = {
                    1: { // فارسی
                        error: "داده‌های هتل نامعتبر است.",
                        dir: "rtl",
                        textAlign: "text-right"
                    },
                    2: { // انگلیسی
                        error: "Invalid hotel data provided.",
                        dir: "ltr",
                        textAlign: "text-left"
                    },
                    3: { // عربی
                        error: "بيانات الفندق غير صالحة.",
                        dir: "rtl",
                        textAlign: "text-right"
                    }
                };

                // انتخاب زبان بر اساس ورودی lang (پیش‌فرض: فارسی)
                const t = translations[lang] || translations[1];

                if (!loungeJson || !loungeJson.cipinfo) {
                    console.error("Invalid hotel data:", loungeJson);
                    return `<div class="text-red-500 ${t.textAlign}" dir="${t.dir}">${t.error}</div>`;
                }

                const cip = loungeJson.cipinfo;
                let infocard = `<h1 class="text-lg font-danademibold text-center" dir="${t.dir}">${cip.loungename}</h1>
                    <div class="flex text-sm" dir="${t.dir}">
                        <span class="text-sm font-danademibold ${t.textAlign}">${cip.airport}</span>
                        <span class="mx-2">/</span>
                        <span class="text-sm font-danademibold ${t.textAlign}">${cip.cities}</span>
                    </div>`;

                return infocard;
            }

            async function renderRules($data, lang ) {
                const rules = $data?.pdf_description;

                // تعریف ترجمه‌ها برای هر زبان
                const translations = {
                    1: { // فارسی
                        noItems: "هیچ آیتمی در pdf_description پیدا نشد",
                        invalidText: "آیتم {index} متن معتبری ندارد",
                        dir: "rtl",
                        textAlign: "text-right"
                    },
                    2: { // انگلیسی
                        noItems: "No items found in pdf_description",
                        invalidText: "Item {index} does not have valid text",
                        dir: "ltr",
                        textAlign: "text-left"
                    },
                    3: { // عربی
                        noItems: "لم يتم العثور على أي عناصر في pdf_description",
                        invalidText: "العنصر {index} لا يحتوي على نص صالح",
                        dir: "rtl",
                        textAlign: "text-right"
                    }
                };

                // انتخاب زبان بر اساس ورودی lang (پیش‌فرض: فارسی)
                const t = translations[lang] || translations[1];

                if (!rules || !Array.isArray(rules)) {
                    console.warn(t.noItems);
                    return null;
                }

                let direction = detectDirection(rules?.[0]?.note.text) || t.dir;

                let ulitem = '';
                rules.forEach((item, index) => {
                    const text = item?.note?.text?.trim();

                    if (text) {
                        ulitem += `<li>${text}</li>`;
                    } else {
                        console.warn(t.invalidText.replace("{index}", index), item);
                    }
                });

                return `<ul dir="${direction}" class="${t.textAlign}">${fixRTLTextCompletely(ulitem)}</ul>`;
            }

            async function renderLoungeInfo($data, lang) {
                let product_info = $data?.product_info;
                let Flightinfo = '';

                // تعریف ترجمه‌ها برای هر زبان
                const translations = {
                    1: { // فارسی
                        title: "اطلاعات lounge",
                        airport: "نام فرودگاه",
                        city: "شهر",
                        airline: "ایرلاین",
                        routecode: "کد مسیر",
                        date: "تاریخ",
                        time: "ساعت",
                        travelType: "نوع سفر",
                        flightType: "نوع پرواز",
                        domestic: "داخلی",
                        international: "خارجی",
                        arrival: "ورودی",
                        departure: "خروجی",
                        dir: "rtl",
                        textAlign: "text-right"
                    },
                    2: { // انگلیسی
                        title: "Lounge Information",
                        airport: "Airport Name",
                        city: "City",
                        airline: "Airline",
                        routecode: "Route Code",
                        date: "Date",
                        time: "Time",
                        travelType: "Travel Type",
                        flightType: "Flight Type",
                        domestic: "Domestic",
                        international: "International",
                        arrival: "Arrival",
                        departure: "Departure",
                        dir: "ltr",
                        textAlign: "text-left"
                    },
                    3: { // عربی
                        title: "معلومات الصالة",
                        airport: "اسم المطار",
                        city: "المدينة",
                        airline: "الخطوط الجوية",
                        routecode: "رمز المسار",
                        date: "التاريخ",
                        time: "الوقت",
                        travelType: "نوع السفر",
                        flightType: "نوع الرحلة",
                        domestic: "محلي",
                        international: "دولي",
                        arrival: "وصول",
                        departure: "مغادرة",
                        dir: "rtl",
                        textAlign: "text-right"
                    }
                };

                // انتخاب زبان بر اساس ورودی lang (پیش‌فرض: فارسی)
                const t = translations[lang] || translations[1];

                console.log(product_info);

                Flightinfo += `
                    <h2 class="font-bold text-lg my-2 font-danabold ${t.textAlign}" dir="${t.dir}">${t.title}</h2>
                    <div class="bg-[#F4FBF9] rounded-xl p-4 flex justify-between gap-4" dir="${t.dir}">
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.airport}</span>
                            <div class="text-[#292929] text-sm font-danademibold ${t.textAlign}">
                                ${product_info.airportName}
                            </div>
                        </div>
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.city}</span>
                            <div class="text-[#292929] text-sm font-danademibold ${t.textAlign}">
                                ${product_info.cityname}
                            </div>
                        </div>
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.airline}</span>
                            <div class="text-[#292929] text-sm font-danademibold ${t.textAlign}">
                                ${product_info.airline}
                            </div>
                        </div>
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.routecode}</span>
                            <div class="text-[#292929] text-sm font-danademibold ${t.textAlign}">
                                ${product_info.routecode}
                            </div>
                        </div>
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.date}</span>
                            <div class="text-[#292929] text-sm font-danademibold dir-${t.dir} ${t.textAlign}">
                                <span>${product_info.dateinfo.mstring}</span>
                                ${lang === 1 ? `<span>(${product_info.dateinfo.sstring})</span>` : ''}
                            </div>
                        </div>
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.time}</span>
                            <div class="text-[#292929] text-sm font-danademibold ${t.textAlign}">
                                ${product_info.time}
                            </div>
                        </div>
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.travelType}</span>
                            <div class="text-[#292929] text-sm font-danademibold ${t.textAlign}">
                                ${product_info.traveltype === "1" ? t.domestic : t.international}
                            </div>
                        </div>
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.flightType}</span>
                            <div class="text-[#292929] text-sm font-danademibold ${t.textAlign}">
                                <span class="inline-block">${product_info.flighttype === "1" ? t.arrival : t.departure}</span>
                                <span class="mx-1">-</span>
                                <span class="inline-block">${product_info.city_flight}</span>
                            </div>
                        </div>
                    </div>
                `;

                return Flightinfo;
            }

            async function renderLoungePassengerInfo($data, lang) {
                const cipinfo = $data?.cipinfo;
                const passengers = $data?.passengerinfo || [];

                // تعریف ترجمه‌ها برای هر زبان
                const translations = {
                    1: { // فارسی
                        title: "اطلاعات مسافران",
                        row: "ردیف",
                        passengers: "مسافران",
                        type: "نوع مسافر",
                        gender: "جنسیت",
                        country: "ملیت",
                        male: "مرد",
                        female: "زن",
                        dir: "rtl",
                        textAlign: "text-right"
                    },
                    2: { // انگلیسی
                        title: "Passenger Information",
                        row: "Row",
                        passengers: "Passengers",
                        type: "Passenger Type",
                        gender: "Gender",
                        country: "Nationality",
                        male: "Male",
                        female: "Female",
                        dir: "ltr",
                        textAlign: "text-left"
                    },
                    3: { // عربی
                        title: "معلومات المسافرين",
                        row: "الصف",
                        passengers: "المسافرون",
                        type: "نوع المسافر",
                        gender: "الجنس",
                        country: "الجنسية",
                        male: "ذكر",
                        female: "أنثى",
                        dir: "rtl",
                        textAlign: "text-right"
                    }
                };

                // انتخاب زبان بر اساس ورودی lang (پیش‌فرض: فارسی)
                const t = translations[lang] || translations[1];

                const parsedPassengers = passengers.map(p => {
                    const info = p.cip_passenger;
                    return {
                        name: `${info.fullname.firstname?.trim() || ''} ${info.fullname.lastname?.trim() || ''}`,
                        type: info.type || '–',
                        gender: info.gender || '–',
                        birthdate: info.birthdate?.birthdate1 || '–',
                        country: info.countryofresidence?.countryname || '–'
                    };
                });

                console.log(parsedPassengers);

                const passengerNames = parsedPassengers.map(p =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${p.name}</h2>`
                ).join('');

                const passengerTypes = parsedPassengers.map(p =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${p.type}</h2>`
                ).join('');

                const passengerCountries = parsedPassengers.map(p =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${p.country}</h2>`
                ).join('');

                const passengerGender = parsedPassengers.map(p =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${p.gender == "1" ? t.male : t.female}</h2>`
                ).join('');

                const rowNumbers = parsedPassengers.map((_, index) =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${index + 1}</h2>`
                ).join('');

                return `
                    <h2 class="font-bold text-lg my-2 font-danabold ${t.textAlign}" dir="${t.dir}">${t.title}</h2>
                    <div class="bg-[#F4FBF9] rounded-xl p-4 flex justify-between gap-4" dir="${t.dir}">
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.row}</span>
                            ${rowNumbers}
                        </div>
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.passengers}</span>
                            ${passengerNames}
                        </div>
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.type}</span>
                            ${passengerTypes}
                        </div>
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.gender}</span>
                            ${passengerGender}
                        </div>
                        <div class="gap-y-2 flex flex-col">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.country}</span>
                            ${passengerCountries}
                        </div>
                    </div>
                `;
            }

            async function renderServiceInfo($data, lang) {
                const cipinfo = $data?.cipinfo;
                const services = $data?.serviceinfo || [];

                // تعریف ترجمه‌ها برای هر زبان
                const translations = {
                    1: { // فارسی
                        title: "اطلاعات خدمات",
                        serviceName: "نام خدمات",
                        count: "تعداد",
                        description: "توضیحات",
                        dir: "rtl",
                        textAlign: "text-right"
                    },
                    2: { // انگلیسی
                        title: "Service Information",
                        serviceName: "Service Name",
                        count: "Count",
                        description: "Description",
                        dir: "ltr",
                        textAlign: "text-left"
                    },
                    3: { // عربی
                        title: "معلومات الخدمات",
                        serviceName: "اسم الخدمة",
                        count: "العدد",
                        description: "الوصف",
                        dir: "rtl",
                        textAlign: "text-right"
                    }
                };

                // انتخاب زبان بر اساس ورودی lang (پیش‌فرض: فارسی)
                const t = translations[lang] || translations[1];

                const serviceNames = services.map(s =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${s.service.servicename || '–'}</h2>`
                ).join('');

                const serviceDescriptions = services.map(s =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${s.service.des_service || '–'}</h2>`
                ).join('');

                const serviceCount = services.map(s =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${s.service.count || '–'}</h2>`
                ).join('');

                return `
                    <h2 class="font-bold text-lg my-2 font-danabold ${t.textAlign}" dir="${t.dir}">${t.title}</h2>
                    <div class="bg-[#F4FBF9] rounded-xl p-4 mt-3 flex justify-between gap-x-4 gap-y-2" dir="${t.dir}">
                        <div class="flex flex-col gap-2">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.serviceName}</span>
                            ${serviceNames}
                        </div>
                        <div class="flex flex-col gap-2">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.count}</span>
                            ${serviceCount}
                        </div>
                        <div class="flex flex-col gap-2">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.description}</span>
                            ${serviceDescriptions}
                        </div>
                    </div>
                `;
            }

            async function renderTransferInfo($data, lang ) {
                const transfers = $data?.transferinfo || [];

                // تعریف ترجمه‌ها برای هر زبان
                const translations = {
                    1: { // فارسی
                        title: "اطلاعات ترنسفر",
                        carName: "نام خودرو",
                        address: "آدرس",
                        time: "زمان",
                        phone: "شماره تماس",
                        description: "توضیحات",
                        dir: "rtl",
                        textAlign: "text-right"
                    },
                    2: { // انگلیسی
                        title: "Transfer Information",
                        carName: "Car Name",
                        address: "Address",
                        time: "Time",
                        phone: "Phone Number",
                        description: "Description",
                        dir: "ltr",
                        textAlign: "text-left"
                    },
                    3: { // عربی
                        title: "معلومات النقل",
                        carName: "اسم السيارة",
                        address: "العنوان",
                        time: "الوقت",
                        phone: "رقم الهاتف",
                        description: "الوصف",
                        dir: "rtl",
                        textAlign: "text-right"
                    }
                };

                // انتخاب زبان بر اساس ورودی lang (پیش‌فرض: فارسی)
                const t = translations[lang] || translations[1];

                const carNames = transfers.map(t =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${t.transfer?.car_name || '–'}</h2>`
                ).join('');

                const addresses = transfers.map(t =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${t.transfer?.address || '–'}</h2>`
                ).join('');

                const times = transfers.map(t =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${t.transfer?.time || '–'}</h2>`
                ).join('');

                const phones = transfers.map(t =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${t.transfer?.phone || '–'}</h2>`
                ).join('');

                const descriptions = transfers.map(t =>
                    `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${t.transfer?.des_transfer || '–'}</h2>`
                ).join('');

                return `
                    <h2 class="font-bold text-lg my-2 font-danabold ${t.textAlign}" dir="${t.dir}">${t.title}</h2>
                    <div class="bg-[#F4FBF9] rounded-xl p-4 mt-3 flex justify-between gap-x-4 gap-y-2" dir="${t.dir}">
                        <div class="flex flex-col gap-2">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.carName}</span>
                            ${carNames}
                        </div>
                        <div class="flex flex-col gap-2">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.address}</span>
                            ${addresses}
                        </div>
                        <div class="flex flex-col gap-2">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.time}</span>
                            ${times}
                        </div>
                        <div class="flex flex-col gap-2">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.phone}</span>
                            ${phones}
                        </div>
                        <div class="flex flex-col gap-2 col-span-full">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.description}</span>
                            ${descriptions}
                        </div>
                    </div>
                `;
            }

            async function renderEscortInfo($data, lang ) {
                const escorts = $data?.escortinfo || [];

                // تعریف ترجمه‌ها برای هر زبان
                const translations = {
                    1: { // فارسی
                        title: "اطلاعات اسکورت",
                        escortName: "نام اسکورت",
                        gender: "جنسیت",
                        male: "مرد",
                        female: "زن",
                        dir: "rtl",
                        textAlign: "text-right"
                    },
                    2: { // انگلیسی
                        title: "Escort Information",
                        escortName: "Escort Name",
                        gender: "Gender",
                        male: "Male",
                        female: "Female",
                        dir: "ltr",
                        textAlign: "text-left"
                    },
                    3: { // عربی
                        title: "معلومات المرافق",
                        escortName: "اسم المرافق",
                        gender: "الجنس",
                        male: "ذكر",
                        female: "أنثى",
                        dir: "rtl",
                        textAlign: "text-right"
                    }
                };

                // انتخاب زبان بر اساس ورودی lang (پیش‌فرض: فارسی)
                const t = translations[lang] || translations[1];

                const escortNames = escorts.map(e => {
                    const { firsname, lastname } = e.escort || {};
                    return `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${firsname || ''} ${lastname || ''}</h2>`;
                }).join('');

                const escortGenders = escorts.map(e => {
                    const gender = e.escort?.gender === "1" ? t.male : t.female;
                    return `<h2 class="text-[#292929] text-sm font-danademibold ${t.textAlign}">${gender}</h2>`;
                }).join('');

                return `
                    <h2 class="font-bold text-lg my-2 font-danabold ${t.textAlign}" dir="${t.dir}">${t.title}</h2>
                    <div class="bg-[#F4FBF9] rounded-xl p-4 mt-3 flex justify-between gap-x-4 gap-y-2" dir="${t.dir}">
                        <div class="flex flex-col gap-2 w-1/2 justify-center items-center">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.escortName}</span>
                            ${escortNames}
                        </div>
                        <div class="flex flex-col gap-2 w-1/2 justify-center items-center">
                            <span class="text-[#6D6D6D] text-sm font-danaregular text-nowrap ${t.textAlign}">${t.gender}</span>
                            ${escortGenders}
                        </div>
                    </div>
                `;
            }
            
            function setFixedViewport() {
                const metaViewport = document.querySelector('meta[name="viewport"]');
                if (metaViewport) {
                    metaViewport.setAttribute('content', 'width=794, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no');
                }

                const pdfContent = document.querySelector('.pdf-content');
                if (pdfContent && pdfContent.classList.contains('max-w-[794px]')) {
                    pdfContent.classList.remove('max-w-[794px]');
                }
            }

            function resetViewport() {
                window.location.reload();
            }

            async function generatePDF() {
                setFixedViewport();
                const element = document.querySelector('.pdf-content');
                const headerElement = document.querySelector('#pdf-header').querySelector("img");
                const footerElement = document.querySelector('#pdf-footer').querySelector("img");
                const loadingElement = document.querySelector('.pdf-loading');

                try {
                    if (loadingElement) loadingElement.classList.remove('hidden');

                    const pdfConfig = document.querySelector('.pdf-config');
                    const pdfFileName = pdfConfig.querySelector('#name');
                    const isSetHeader = pdfConfig.querySelector('#header');

                    const opt = {
                        margin: [30, 10, 30, 10],  
                        filename: pdfFileName.value || "reservationDoc.pdf",
                        image: { type: 'jpeg', quality: 1 },
                        html2canvas: {
                            scale: 1,
                            width: 794,
                            windowWidth: element.scrollWidth, 
                            useCORS: true,
                            backgroundColor: '#ffffff',
                            scrollX: 0,
                            scrollY: 0,
                            letterRendering: true,
                            ignoreElements: (el) =>
                                ['BUTTON', 'A', 'SCRIPT'].includes(el.tagName) ||
                                el.classList.contains('pdf-loading'),
                        },
                        jsPDF: {
                            unit: 'mm',
                            format: 'a4',
                            orientation: 'portrait',
                            hotfixes: ['px_scaling']
                        },
                        pagebreak: { 
                            mode: ['css', 'legacy'], // Use both CSS and legacy mode
                            before: '.page-break-before',
                            after: '.page-break-after',
                            avoid: '.avoid-break'
                        }
                    };

                    const headerCanvas = await html2canvas(headerElement, { scale: 2 });
                    const footerCanvas = await html2canvas(footerElement, { scale: 2 });
                    
                    const headerImage = headerCanvas.toDataURL('image/png');
                    const footerImage = footerCanvas.toDataURL('image/png');

                    // ایجاد PDF از عنصر
                    const worker = html2pdf().set(opt).from(element).toPdf();

                    // افزودن هدر و فوتر به تمام صفحات
                    worker.get('pdf').then((pdf) => {
                        const totalPages = pdf.internal.getNumberOfPages();
                        for (let i = 1; i <= totalPages; i++) {
                            pdf.setPage(i);
                            if (isSetHeader.value == 1){
                                pdf.addImage(headerImage, 'PNG', 0, 5, 210, 18);  // x, y, width, height
                                pdf.addImage(footerImage, 'PNG', 0, 277, 210, 18);
                            }
                        }
                    });

                    await worker.save();
                } catch (err) {
                    console.error('PDF generation failed:', err);
                    alert('خطا در تولید PDF.');
                } finally {
                    resetViewport();
                    if (loadingElement) loadingElement.classList.add('hidden');
                }
            }

        </script>
        <script src="[##cms.cms.cdn##]/js/pdf-content.functions.js" defer></script>
        <script src="[##cms.cms.cdn##]/js/flight_ticket_test.js" defer></script>
    </basis>
</body>

</html>